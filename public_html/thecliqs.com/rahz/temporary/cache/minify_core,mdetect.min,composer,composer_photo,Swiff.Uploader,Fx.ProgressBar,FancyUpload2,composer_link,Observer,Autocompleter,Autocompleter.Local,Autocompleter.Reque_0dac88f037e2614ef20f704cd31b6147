(function(){var $='id'in document?document.id:window.$;en4.activity={load:function(next_id,subject_guid){if(en4.core.request.isRequestActive())return;$('feed_viewmore').style.display='none';$('feed_loading').style.display='';en4.core.request.send(new Request.HTML({url:en4.core.baseUrl+'activity/widget/feed',data:{'maxid':next_id,'feedOnly':true,'nolayout':true,'subject':subject_guid}}),{'element':$('activity-feed'),'updateHtmlMode':'append'});},like:function(action_id,comment_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/like',data:{format:'json',action_id:action_id,comment_id:comment_id,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},unlike:function(action_id,comment_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/unlike',data:{format:'json',action_id:action_id,comment_id:comment_id,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},comment:function(action_id,body){if(body.trim()=='')
{return;}
en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/comment',data:{format:'json',action_id:action_id,body:body,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},attachComment:function(formElement){var bind=this;formElement.addEvent('submit',function(event){event.stop();bind.comment(formElement.action_id.value,formElement.body.value);});},viewComments:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/viewComment',data:{format:'json',action_id:action_id,nolist:true}}),{'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});},viewLikes:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/viewLike',data:{format:'json',action_id:action_id,nolist:true}}),{'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});},hideNotifications:function(reset_text){en4.core.request.send(new Request.JSON({'url':en4.core.baseUrl+'activity/notifications/hide'}));$('updates_toggle').set('html',reset_text).removeClass('new_updates');if($('notifications_main')){var notification_children=$('notifications_main').getChildren('li');notification_children.each(function(el){el.setAttribute('class','');});}
if($('notifications_menu')){var notification_children=$('notifications_menu').getChildren('li');notification_children.each(function(el){el.setAttribute('class','');});}},updateNotifications:function(){if(en4.core.request.isRequestActive())return;en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/update',data:{format:'json'},onSuccess:this.showNotifications.bind(this)}));},showNotifications:function(responseJSON){if(responseJSON.notificationCount>0){$('updates_toggle').set('html',responseJSON.text).addClass('new_updates');}},markRead:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/test',data:{format:'json','actionid':action_id}}));},cometNotify:function(responseObject){$('core_menu_mini_menu_updates').style.display='';$('core_menu_mini_menu_updates_count').innerHTML=responseObject.text;}};NotificationUpdateHandler=new Class({Implements:[Events,Options],options:{debug:false,baseUrl:'/',identity:false,delay:5000,minDelay:5000,maxDelay:600000,delayFactor:1.5,admin:false,idleTimeout:600000,last_id:0,subject_guid:null},state:true,activestate:1,fresh:true,lastEventTime:false,title:document.title,initialize:function(options){this.setOptions(options);this.options.minDelay=this.options.delay;},start:function(){this.state=true;this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this.activestate=1;this.state=true;}.bind(this),'onStateIdle':function(){this.activestate=0;this.state=false;}.bind(this)});this.loop();},stop:function(){this.state=false;},updateNotifications:function(){if(en4.core.request.isRequestActive())return;en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/update',data:{format:'json'},onSuccess:this.showNotifications.bind(this)}));},showNotifications:function(responseJSON){if(responseJSON.notificationCount>0){this.options.delay=this.options.minDelay;$('updates_toggle').set('html',responseJSON.text).addClass('new_updates');}else{this.options.delay=Math.min(this.options.maxDelay,this.options.delayFactor*this.options.delay);}},loop:function(){if(!this.state){this.loop.delay(this.options.delay,this);return;}
try{this.updateNotifications().addEvent('complete',function(){this.loop.delay(this.options.delay,this);}.bind(this));}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}},_log:function(object){if(!this.options.debug){return;}
try{if(typeof(console)&&$type(console)){console.log(object);}}catch(e){}}});en4.activity.compose={composers:{},register:function(object){name=object.getName();this.composers[name]=object;},deactivate:function(){for(var x in this.composers){this.composers[x].deactivate();}
return this;}};en4.activity.compose.icompose=new Class({Implements:[Events,Options],name:false,element:false,options:{},initialize:function(element,options){this.element=$(element);this.setOptions(options);},getName:function(){return this.name;},activate:function(){en4.activity.compose.deactivate();},deactivate:function(){}});ActivityUpdateHandler=new Class({Implements:[Events,Options],options:{debug:true,baseUrl:'/',identity:false,delay:5000,admin:false,idleTimeout:600000,last_id:0,next_id:null,subject_guid:null,showImmediately:false},state:true,activestate:1,fresh:true,lastEventTime:false,title:document.title,initialize:function(options){this.setOptions(options);},start:function(){this.state=true;this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this._log('activity loop onStateActive');this.activestate=1;this.state=true;}.bind(this),'onStateIdle':function(){this._log('activity loop onStateIdle');this.activestate=0;this.state=false;}.bind(this)});this.loop();},stop:function(){this.state=false;},checkFeedUpdate:function(action_id,subject_guid){if(en4.core.request.isRequestActive())return;function getAllElementsWithAttribute(attribute){var matchingElements=[];var values=[];var allElements=document.getElementsByTagName('*');for(var i=0;i<allElements.length;i++){if(allElements[i].getAttribute(attribute)){matchingElements.push(allElements[i]);values.push(allElements[i].getAttribute(attribute));}}
return values;}
var list=getAllElementsWithAttribute('data-activity-feed-item');this.options.last_id=Math.max.apply(Math,list);min_id=this.options.last_id+1;var req=new Request.HTML({url:en4.core.baseUrl+'widget/index/name/activity.feed',data:{'format':'html','minid':min_id,'feedOnly':true,'nolayout':true,'subject':this.options.subject_guid,'getUpdate':true}});en4.core.request.send(req,{'element':$('activity-feed'),'updateHtmlMode':'prepend'});req.addEvent('complete',function(){(function(){if(this.options.showImmediately&&$('feed-update').getChildren().length>0){$('feed-update').setStyle('display','none');$('feed-update').empty();this.getFeedUpdate(this.options.next_id);}}).delay(50,this);}.bind(this));if(localStorage){var pageTitle=document.title;var feed=document.getElementById('activity-feed');var items=feed.getElementsByTagName("li");var itemObject={};var c=0;for(var i=0;i<items.length;++i){if(items[i].getAttribute('data-activity-feed-item')!=null){var itemId=items[i].getAttribute('data-activity-feed-item');itemObject[c]={id:itemId,content:document.getElementById('activity-item-'+itemId).innerHTML};c++;}}
var activityFeedJSON=JSON.stringify(itemObject);localStorage.setItem(pageTitle+'-activity-feed-widget',activityFeedJSON);}
if(localStorage.getItem(pageTitle+'-activity-feed-widget')){var storedFeedJSON=localStorage.getItem(pageTitle+'-activity-feed-widget');var storedObj=eval("("+storedFeedJSON+")");}
return req;},getFeedUpdate:function(last_id){if(en4.core.request.isRequestActive())return;var min_id=this.options.last_id+1;this.options.last_id=last_id;document.title=this.title;var req=new Request.HTML({url:en4.core.baseUrl+'widget/index/name/activity.feed',data:{'format':'html','minid':min_id,'feedOnly':true,'nolayout':true,'getUpdate':true,'subject':this.options.subject_guid}});en4.core.request.send(req,{'element':$('activity-feed'),'updateHtmlMode':'prepend'});return req;},loop:function(){this._log('activity update loop start');if(!this.state){this.loop.delay(this.options.delay,this);return;}
try{this.checkFeedUpdate().addEvent('complete',function(){try{this._log('activity loop req complete');this.loop.delay(this.options.delay,this);}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}}.bind(this));}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}
this._log('activity update loop stop');},_log:function(object){if(!this.options.debug){return;}
try{if('console'in window&&typeof(console)&&'log'in console){console.log(object);}}catch(e){}}});})();
;var isIphone=false;var isTierIphone=false;var isTierRichCss=false;var isTierGenericMobile=false;var engineWebKit="webkit";var deviceIphone="iphone";var deviceIpod="ipod";var deviceIpad="ipad";var deviceMacPpc="macintosh";var deviceAndroid="android";var deviceGoogleTV="googletv";var deviceNuvifone="nuvifone";var deviceSymbian="symbian";var deviceS60="series60";var deviceS70="series70";var deviceS80="series80";var deviceS90="series90";var deviceWinPhone7="windows phone os 7";var deviceWinMob="windows ce";var deviceWindows="windows";var deviceIeMob="iemobile";var devicePpc="ppc";var enginePie="wm5 pie";var deviceBB="blackberry";var vndRIM="vnd.rim";var deviceBBStorm="blackberry95";var deviceBBBold="blackberry97";var deviceBBTour="blackberry96";var deviceBBCurve="blackberry89";var deviceBBTorch="blackberry 98";var devicePalm="palm";var deviceWebOS="webos";var engineBlazer="blazer";var engineXiino="xiino";var deviceKindle="kindle";var vndwap="vnd.wap";var wml="wml";var deviceBrew="brew";var deviceDanger="danger";var deviceHiptop="hiptop";var devicePlaystation="playstation";var deviceNintendoDs="nitro";var deviceNintendo="nintendo";var deviceWii="wii";var deviceXbox="xbox";var deviceArchos="archos";var engineOpera="opera";var engineNetfront="netfront";var engineUpBrowser="up.browser";var engineOpenWeb="openweb";var deviceMidp="midp";var uplink="up.link";var engineTelecaQ='teleca q';var devicePda="pda";var mini="mini";var mobile="mobile";var mobi="mobi";var maemo="maemo";var maemoTablet="tablet";var linux="linux";var qtembedded="qt embedded";var mylocom2="com2";var manuSonyEricsson="sonyericsson";var manuericsson="ericsson";var manuSamsung1="sec-sgh";var manuSony="sony";var manuHtc="htc";var svcDocomo="docomo";var svcKddi="kddi";var svcVodafone="vodafone";var disUpdate="update";var uagent=navigator.userAgent.toLowerCase();function DetectIphone()
{if(uagent.search(deviceIphone)>-1)
{if(DetectIpad()||DetectIpod())
return false;else
return true;}
else
return false;}
function DetectIpod()
{if(uagent.search(deviceIpod)>-1)
return true;else
return false;}
function DetectIpad()
{if(uagent.search(deviceIpad)>-1&&DetectWebkit())
return true;else
return false;}
function DetectIphoneOrIpod()
{if(uagent.search(deviceIphone)>-1||uagent.search(deviceIpod)>-1)
return true;else
return false;}
function DetectAndroid()
{if(uagent.search(deviceAndroid)>-1)
return true;else
return false;}
function DetectAndroidWebKit()
{if(DetectAndroid()&&DetectWebkit())
return true;else
return false;}
function DetectGoogleTV()
{if(uagent.search(deviceGoogleTV)>-1)
return true;else
return false;}
function DetectWebkit()
{if(uagent.search(engineWebKit)>-1)
return true;else
return false;}
function DetectS60OssBrowser()
{if(DetectWebkit())
{if((uagent.search(deviceS60)>-1||uagent.search(deviceSymbian)>-1))
return true;else
return false;}
else
return false;}
function DetectSymbianOS()
{if(uagent.search(deviceSymbian)>-1||uagent.search(deviceS60)>-1||uagent.search(deviceS70)>-1||uagent.search(deviceS80)>-1||uagent.search(deviceS90)>-1)
return true;else
return false;}
function DetectWindowsPhone7()
{if(uagent.search(deviceWinPhone7)>-1)
return true;else
return false;}
function DetectWindowsMobile()
{if(DetectWindowsPhone7())
return false;if(uagent.search(deviceWinMob)>-1||uagent.search(deviceIeMob)>-1||uagent.search(enginePie)>-1)
return true;if((uagent.search(devicePpc)>-1)&&!(uagent.search(deviceMacPpc)>-1))
return true;if(uagent.search(manuHtc)>-1&&uagent.search(deviceWindows)>-1)
return true;else
return false;}
function DetectBlackBerry()
{if(uagent.search(deviceBB)>-1)
return true;if(uagent.search(vndRIM)>-1)
return true;else
return false;}
function DetectBlackBerryWebKit()
{if(uagent.search(deviceBB)>-1&&uagent.search(engineWebKit)>-1)
return true;else
return false;}
function DetectBlackBerryTouch()
{if((uagent.search(deviceBBStorm)>-1)||(uagent.search(deviceBBTorch)>-1))
return true;else
return false;}
function DetectBlackBerryHigh()
{if(DetectBlackBerryWebKit())
return false;if(DetectBlackBerry())
{if(DetectBlackBerryTouch()||uagent.search(deviceBBBold)>-1||uagent.search(deviceBBTour)>-1||uagent.search(deviceBBCurve)>-1)
return true;else
return false;}
else
return false;}
function DetectBlackBerryLow()
{if(DetectBlackBerry())
{if(DetectBlackBerryHigh())
return false;else
return true;}
else
return false;}
function DetectPalmOS()
{if(uagent.search(devicePalm)>-1||uagent.search(engineBlazer)>-1||uagent.search(engineXiino)>-1)
{if(DetectPalmWebOS())
return false;else
return true;}
else
return false;}
function DetectPalmWebOS()
{if(uagent.search(deviceWebOS)>-1)
return true;else
return false;}
function DetectGarminNuvifone()
{if(uagent.search(deviceNuvifone)>-1)
return true;else
return false;}
function DetectSmartphone()
{if(DetectIphoneOrIpod())
return true;if(DetectS60OssBrowser())
return true;if(DetectSymbianOS())
return true;if(DetectWindowsMobile())
return true;if(DetectWindowsPhone7())
return true;if(DetectAndroid())
return true;if(DetectBlackBerry())
return true;if(DetectPalmWebOS())
return true;if(DetectPalmOS())
return true;if(DetectGarminNuvifone())
return true;return false;};function DetectArchos()
{if(uagent.search(deviceArchos)>-1)
return true;else
return false;}
function DetectBrewDevice()
{if(uagent.search(deviceBrew)>-1)
return true;else
return false;}
function DetectDangerHiptop()
{if(uagent.search(deviceDanger)>-1||uagent.search(deviceHiptop)>-1)
return true;else
return false;}
function DetectMaemoTablet()
{if(uagent.search(maemo)>-1)
return true;if(uagent.search(maemoTablet)>-1&&uagent.search(linux)>-1)
return true;else
return false;}
function DetectSonyMylo()
{if(uagent.search(manuSony)>-1)
{if(uagent.search(qtembedded)>-1||uagent.search(mylocom2)>-1)
return true;else
return false;}
else
return false;}
function DetectOperaMobile()
{if(uagent.search(engineOpera)>-1)
{if(uagent.search(mini)>-1||uagent.search(mobi)>-1)
return true;else
return false;}
else
return false;}
function DetectSonyPlaystation()
{if(uagent.search(devicePlaystation)>-1)
return true;else
return false;};function DetectNintendo()
{if(uagent.search(deviceNintendo)>-1||uagent.search(deviceWii)>-1||uagent.search(deviceNintendoDs)>-1)
return true;else
return false;};function DetectXbox()
{if(uagent.search(deviceXbox)>-1)
return true;else
return false;};function DetectGameConsole()
{if(DetectSonyPlaystation())
return true;if(DetectNintendo())
return true;if(DetectXbox())
return true;else
return false;};function DetectKindle()
{if(uagent.search(deviceKindle)>-1)
return true;else
return false;}
function DetectMobileQuick()
{if(DetectIpad())
return false;if(DetectSmartphone())
return true;if(uagent.search(deviceMidp)>-1||DetectBrewDevice())
return true;if(DetectOperaMobile())
return true;if(uagent.search(engineNetfront)>-1)
return true;if(uagent.search(engineUpBrowser)>-1)
return true;if(uagent.search(engineOpenWeb)>-1)
return true;if(DetectDangerHiptop())
return true;if(DetectMaemoTablet())
return true;if(DetectArchos())
return true;if((uagent.search(devicePda)>-1)&&(uagent.search(disUpdate)<0))
return true;if(uagent.search(mobile)>-1)
return true;if(DetectKindle())
return true;return false;};function DetectMobileLong()
{if(DetectMobileQuick())
return true;if(DetectGameConsole())
return true;if(DetectSonyMylo())
return true;if(uagent.search(manuSamsung1)>-1||uagent.search(manuSonyEricsson)>-1||uagent.search(manuericsson)>-1)
return true;if(uagent.search(svcDocomo)>-1)
return true;if(uagent.search(svcKddi)>-1)
return true;if(uagent.search(svcVodafone)>-1)
return true;return false;};function DetectTierIphone()
{if(DetectIphoneOrIpod())
return true;if(DetectAndroid())
return true;if(DetectAndroidWebKit())
return true;if(DetectWindowsPhone7())
return true;if(DetectBlackBerryWebKit())
return true;if(DetectPalmWebOS())
return true;if(DetectGarminNuvifone())
return true;if(DetectMaemoTablet())
return true;else
return false;};function DetectTierRichCss()
{if(DetectMobileQuick())
{if(DetectTierIphone())
return false;if(DetectWebkit())
return true;if(DetectS60OssBrowser())
return true;if(DetectBlackBerryHigh())
return true;if(DetectWindowsMobile())
return true;if(uagent.search(engineTelecaQ)>-1)
return true;else
return false;}
else
return false;};function DetectTierOtherPhones()
{if(DetectMobileLong())
{if(DetectTierIphone())
return false;if(DetectTierRichCss())
return false;else
return true;}
else
return false;};
;(function(){var $='id'in document?document.id:window.$;Composer=new Class({Implements:[Events,Options],elements:{},plugins:{},options:{lang:{},overText:true,allowEmptyWithoutAttachment:false,allowEmptyWithAttachment:true,hideSubmitOnBlur:true,submitElement:false,useContentEditable:true},initialize:function(element,options){this.setOptions(options);this.elements=new Hash(this.elements);this.plugins=new Hash(this.plugins);this.elements.textarea=$(element);this.elements.textarea.store('Composer');this.attach();this.getTray();this.getMenu();this.pluginReady=false;this.getForm().addEvent('submit',function(e){if(this.pluginReady){if(!this.options.allowEmptyWithAttachment&&this.getContent()==''){e.stop();return;}}else{if(!this.options.allowEmptyWithoutAttachment&&this.getContent()==''){e.stop();return;}}
this.saveContent();}.bind(this));},getMenu:function(){if(!$type(this.elements.menu)){this.elements.menu=$try(function(){return $(this.options.menuElement);}.bind(this));if(!$type(this.elements.menu)){this.elements.menu=new Element('div',{'id':'compose-menu','class':'compose-menu'}).inject(this.getForm(),'after');}}
return this.elements.menu;},getTray:function(){if(!$type(this.elements.tray)){this.elements.tray=$try(function(){return $(this.options.trayElement);}.bind(this));if(!$type(this.elements.tray)){this.elements.tray=new Element('div',{'id':'compose-tray','class':'compose-tray','styles':{'display':'none'}}).inject(this.getForm(),'after');}}
return this.elements.tray;},getInputArea:function(){if(!$type(this.elements.inputarea)){var form=this.elements.textarea.getParent('form');this.elements.inputarea=new Element('div',{'styles':{'display':'none'}}).inject(form);}
return this.elements.inputarea;},getForm:function(){return this.elements.textarea.getParent('form');},attach:function(){var size=this.elements.textarea.getSize();this.elements.textarea.addClass('compose-textarea').setStyle('display','none');this.elements.container=new Element('div',{'id':'compose-container','class':'compose-container','styles':{}});this.elements.container.wraps(this.elements.textarea);var supportsContentEditable=this._supportsContentEditable();if(supportsContentEditable){this.elements.body=new Element('div',{'class':'compose-content','styles':{'display':'block'},'events':{'keypress':function(event){if(event.key=='a'&&event.control){if(Browser.Engine.gecko){fix_gecko_select_all_contenteditable_bug(this,event);}}}}}).inject(this.elements.textarea,'before');}else{this.elements.body=this.elements.textarea;}
var self=this;this.elements.body.addEvent('blur',function(e){var curVal;if(supportsContentEditable){curVal=this.get('html').replace(/\s/,'').replace(/<[^<>]+?>/ig,'');}else{curVal=this.get('value').replace(/\s/,'').replace(/<[^<>]+?>/ig,'')}
if(''==curVal){if(!Browser.Engine.trident){if(supportsContentEditable){this.set('html','<br />');}else{this.set('value','');}}
if(self.options.hideSubmitOnBlur){(function(){if(!self.hasActivePlugin()){self.getMenu().setStyle('display','none');}}).delay(250);}}});if(self.options.hideSubmitOnBlur){this.getMenu().setStyle('display','none');this.elements.body.addEvent('focus',function(e){self.getMenu().setStyle('display','');});}
if(supportsContentEditable){$(this.elements.body);this.elements.body.contentEditable=true;this.elements.body.designMode='On';['MouseUp','MouseDown','ContextMenu','Click','Dblclick','KeyPress','KeyUp','KeyDown'].each(function(eventName){var method=(this['editor'+eventName]||function(){}).bind(this);this.elements.body.addEvent(eventName.toLowerCase(),method);}.bind(this));this.setContent(this.elements.textarea.value);this.selection=new Composer.Selection(this.elements.body);}else{this.elements.textarea.setStyle('display','');}
if(this.options.overText&&supportsContentEditable){new Composer.OverText(this.elements.body,$merge({textOverride:this._lang('Post Something...'),poll:true,isPlainText:!supportsContentEditable,positionOptions:{position:(en4.orientation=='rtl'?'upperRight':'upperLeft'),edge:(en4.orientation=='rtl'?'upperRight':'upperLeft'),offset:{x:(en4.orientation=='rtl'?-4:4),y:2}}},this.options.overTextOptions));}
this.fireEvent('attach',this);},detach:function(){this.saveContent();this.textarea.setStyle('display','').removeClass('compose-textarea').inject(this.container,'before');this.container.dispose();this.fireEvent('detach',this);return this;},focus:function(){(function(){this.elements.body.focus();this.fireEvent('focus',this);}).bind(this).delay(10);return this;},getContent:function(){if(this._supportsContentEditable()){return this.cleanup(this.elements.body.get('html'));}else{return this.cleanup(this.elements.body.get('value'));}},setContent:function(newContent){if(this._supportsContentEditable()){if(!newContent.trim()&&!Browser.Engine.trident)newContent='<br />';this.elements.body.set('html',newContent);}else{this.elements.body.set('value',newContent);}
return this;},saveContent:function(){if(this._supportsContentEditable()){this.elements.textarea.set('value',this.getContent());}
return this;},cleanup:function(html){return html.replace(/<(br|p|div)[^<>]*?>/ig,"\r\n").replace(/<[^<>]+?>/ig,' ').replace(/(\r\n?|\n){3,}/ig,"\n\n").trim();},addPlugin:function(plugin){var key=plugin.getName();this.plugins.set(key,plugin);plugin.setComposer(this);return this;},addPlugins:function(plugins){plugins.each(function(plugin){this.addPlugin(plugin);}.bind(this));},getPlugin:function(name){return this.plugins.get(name);},activate:function(name){this.deactivate();this.getMenu().setStyle();this.plugins.get(name).activate();},deactivate:function(){this.plugins.each(function(plugin){plugin.deactivate();});this.getTray().empty();},signalPluginReady:function(state){this.pluginReady=state;},hasActivePlugin:function(){var active=false;this.plugins.each(function(plugin){active=active||plugin.active;});return active;},editorMouseUp:function(e){this.fireEvent('editorMouseUp',e);},editorMouseDown:function(e){this.fireEvent('editorMouseDown',e);},editorContextMenu:function(e){this.fireEvent('editorContextMenu',e);},editorClick:function(e){if(Browser.Engine.webkit){var el=e.target;if(el.get('tag')=='img'){this.selection.selectNode(el);}}
this.fireEvent('editorClick',e);},editorDoubleClick:function(e){this.fireEvent('editorDoubleClick',e);},editorKeyPress:function(e){this.keyListener(e);this.fireEvent('editorKeyPress',e);},editorKeyUp:function(e){this.fireEvent('editorKeyUp',e);},editorKeyDown:function(e){if(e.key=='enter'){}
this.fireEvent('editorKeyDown',e);},keyListener:function(e){},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}},_supportsContentEditable:function(){if('useContentEditable'in this.options&&this.options.useContentEditable&&!en4.isMobile){return true;}else{return false;}}});Composer.Selection=new Class({initialize:function(win){this.win=win;},getSelection:function(){return window.getSelection();},getRange:function(){var s=this.getSelection();if(!s)return null;try{return s.rangeCount>0?s.getRangeAt(0):(s.createRange?s.createRange():null);}catch(e){return document.body.createTextRange();}},setRange:function(range){if(range.select){$try(function(){range.select();});}else{var s=this.getSelection();if(s.addRange){s.removeAllRanges();s.addRange(range);}}},selectNode:function(node,collapse){var r=this.getRange();var s=this.getSelection();if(r.moveToElementText){$try(function(){r.moveToElementText(node);r.select();});}else if(s.addRange){collapse?r.selectNodeContents(node):r.selectNode(node);s.removeAllRanges();s.addRange(r);}else{s.setBaseAndExtent(node,0,node,1);}
return node;},isCollapsed:function(){var r=this.getRange();if(r.item)return false;return r.boundingWidth==0||this.getSelection().isCollapsed;},collapse:function(toStart){var r=this.getRange();var s=this.getSelection();if(r.select){r.collapse(toStart);r.select();}else{toStart?s.collapseToStart():s.collapseToEnd();}},getContent:function(){var r=this.getRange();var body=new Element('body');if(this.isCollapsed())return'';if(r.cloneContents){body.appendChild(r.cloneContents());}else if($defined(r.item)||$defined(r.htmlText)){body.set('html',r.item?r.item(0).outerHTML:r.htmlText);}else{body.set('html',r.toString());}
var content=body.get('html');return content;},getText:function(){var r=this.getRange();var s=this.getSelection();return this.isCollapsed()?'':r.text||s.toString();},getNode:function(){var r=this.getRange();if(!Browser.Engine.trident){var el=null;if(r){el=r.commonAncestorContainer;if(!r.collapsed)
if(r.startContainer==r.endContainer)
if(r.startOffset-r.endOffset<2)
if(r.startContainer.hasChildNodes())
el=r.startContainer.childNodes[r.startOffset];while($type(el)!='element')el=el.parentNode;}
return $(el);}
return $(r.item?r.item(0):r.parentElement());},insertContent:function(content){var r=this.getRange();if(r.insertNode){r.deleteContents();r.insertNode(r.createContextualFragment(content));}else{(r.pasteHTML)?r.pasteHTML(content):r.item(0).outerHTML=content;}}});Composer.OverText=new Class({Extends:OverText,test:function(){if(!$type(this.options.isPlainText)||!this.options.isPlainText){return!this.element.get('html').replace(/\s+/,'').replace(/<br.*?>/,'');}else{return this.parent();}},hide:function(suppressFocus,force){if(this.text&&(this.text.isDisplayed()&&(!this.element.get('disabled')||force))){this.text.hide();this.fireEvent('textHide',[this.text,this.element]);this.pollingPaused=true;try{this.element.fireEvent('focus');this.element.focus();}catch(e){}}
return this;}})
Composer.Plugin={};Composer.Plugin.Interface=new Class({Implements:[Options,Events],name:'interface',active:false,composer:false,options:{loadingImage:en4.core.staticBaseUrl+'application/modules/Core/externals/images/loading.gif'},elements:{},persistentElements:['activator','loadingImage'],params:{},initialize:function(options){this.params=new Hash();this.elements=new Hash();this.reset();this.setOptions(options);},getName:function(){return this.name;},setComposer:function(composer){this.composer=composer;this.attach();return this;},getComposer:function(){if(!this.composer)throw"No composer defined";return this.composer;},attach:function(){this.reset();},detach:function(){this.reset();if(this.elements.activator){this.elements.activator.destroy();this.elements.erase('menu');}},reset:function(){this.elements.each(function(element,key){if($type(element)=='element'&&!this.persistentElements.contains(key)){element.destroy();this.elements.erase(key);}}.bind(this));this.params=new Hash();this.elements=new Hash();},activate:function(){if(this.active)return;this.active=true;this.reset();this.getComposer().getTray().setStyle('display','');this.getComposer().getMenu().setStyle('display','none');var submitButtonEl=$(this.getComposer().options.submitElement);if(submitButtonEl){submitButtonEl.setStyle('display','none');}
this.getComposer().getMenu().setStyle('border','none');this.getComposer().getMenu().getElements('.compose-activator').each(function(element){element.setStyle('display','none');});switch($type(this.options.loadingImage)){case'element':break;case'string':this.elements.loadingImage=new Asset.image(this.options.loadingImage,{'id':'compose-'+this.getName()+'-loading-image','class':'compose-loading-image'});break;default:this.elements.loadingImage=new Asset.image('loading.gif',{'id':'compose-'+this.getName()+'-loading-image','class':'compose-loading-image'});break;}},deactivate:function(){if(!this.active)return;this.active=false;this.reset();this.getComposer().getTray().setStyle('display','none');this.getComposer().getMenu().setStyle('display','');var submitButtonEl=$(this.getComposer().options.submitElement);if(submitButtonEl){submitButtonEl.setStyle('display','');}
this.getComposer().getMenu().getElements('.compose-activator').each(function(element){element.setStyle('display','');});this.getComposer().getMenu().set('style','');this.getComposer().signalPluginReady(false);},ready:function(){this.getComposer().signalPluginReady(true);this.getComposer().getMenu().setStyle('display','');var submitEl=$(this.getComposer().options.submitElement);if(submitEl){submitEl.setStyle('display','');}},makeActivator:function(){if(!this.elements.activator){this.elements.activator=new Element('a',{'id':'compose-'+this.getName()+'-activator','class':'compose-activator buttonlink','href':'javascript:void(0);','html':this._lang(this.options.title),'events':{'click':this.activate.bind(this)}}).inject(this.getComposer().getMenu());}},makeMenu:function(){if(!this.elements.menu){var tray=this.getComposer().getTray();this.elements.menu=new Element('div',{'id':'compose-'+this.getName()+'-menu','class':'compose-menu'}).inject(tray);this.elements.menuTitle=new Element('span',{'html':this._lang(this.options.title)+' ('}).inject(this.elements.menu);this.elements.menuClose=new Element('a',{'href':'javascript:void(0);','html':this._lang('cancel'),'events':{'click':function(e){e.stop();this.getComposer().deactivate();}.bind(this)}}).inject(this.elements.menuTitle);this.elements.menuTitle.appendText(')');}},makeBody:function(){if(!this.elements.body){var tray=this.getComposer().getTray();this.elements.body=new Element('div',{'id':'compose-'+this.getName()+'-body','class':'compose-body'}).inject(tray);}},makeLoading:function(action){if(!this.elements.loading){if(action=='empty'){this.elements.body.empty();}else if(action=='hide'){this.elements.body.getChildren().each(function(element){element.setStyle('display','none')});}else if(action=='invisible'){this.elements.body.getChildren().each(function(element){element.setStyle('height','0px').setStyle('visibility','hidden')});}
this.elements.loading=new Element('div',{'id':'compose-'+this.getName()+'-loading','class':'compose-loading'}).inject(this.elements.body);var image=this.elements.loadingImage||(new Element('img',{'id':'compose-'+this.getName()+'-loading-image','class':'compose-loading-image'}));image.inject(this.elements.loading);new Element('span',{'html':this._lang('Loading...')}).inject(this.elements.loading);}},makeError:function(message,action){if(!$type(action))action='empty';message=message||'An error has occurred';message=this._lang(message);this.elements.error=new Element('div',{'id':'compose-'+this.getName()+'-error','class':'compose-error','html':message}).inject(this.elements.body);},makeFormInputs:function(data){this.ready();this.getComposer().getInputArea().empty();data.type=this.getName();$H(data).each(function(value,key){this.setFormInputValue(key,value);}.bind(this));},setFormInputValue:function(key,value){var elName='attachmentForm'+key.capitalize();if(!this.elements.has(elName)){this.elements.set(elName,new Element('input',{'type':'hidden','name':'attachment['+key+']','value':value||''}).inject(this.getComposer().getInputArea()));}
this.elements.get(elName).value=value;},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}}});})();;(function(){var $='id'in document?document.id:window.$;Composer.Plugin.Photo=new Class({Extends:Composer.Plugin.Interface,name:'photo',options:{title:'Add Photo',lang:{},requestOptions:false,fancyUploadEnabled:true,fancyUploadOptions:{}},initialize:function(options){this.elements=new Hash(this.elements);this.params=new Hash(this.params);this.parent(options);},attach:function(){this.parent();this.makeActivator();return this;},detach:function(){this.parent();return this;},activate:function(){if(this.active)return;this.parent();this.makeMenu();this.makeBody();var fullUrl=this.options.requestOptions.url;this.elements.form=new Element('form',{'id':'compose-photo-form','class':'compose-form','method':'post','action':fullUrl,'enctype':'multipart/form-data'}).inject(this.elements.body);this.elements.formInput=new Element('input',{'id':'compose-photo-form-input','class':'compose-form-input','type':'file','name':'Filedata','events':{'change':this.doRequest.bind(this)}}).inject(this.elements.form);if(this.options.fancyUploadEnabled&&this.options.fancyUploadOptions){this.elements.formFancyContainer=new Element('div',{'styles':{'display':'none','visibility':'hidden'}}).inject(this.elements.body);this.elements.formFancyFile=new Element('a',{'href':'javascript:void(0);','id':'compose-photo-form-fancy-file','class':'buttonlink','html':this._lang('Select File')}).inject(this.elements.formFancyContainer);this.elements.formFancyStatus=new Element('div',{'html':'<div style="display:none;">\n\
  <div class="demo-status-overall" id="demo-status-overall" style="display:none;">\n\
    <div class="overall-title"></div>\n\
    <img src="" class="progress overall-progress" />\n\
  </div>\n\
  <div class="demo-status-current" id="demo-status-current" style="display:none;">\n\
    <div class="current-title"></div>\n\
    <img src="" class="progress current-progress" />\n\
  </div>\n\
  <div class="current-text"></div>\n\
</div>'}).inject(this.elements.formFancyContainer);this.elements.formFancyList=new Element('div',{'styles':{'display':'none'}}).inject(this.elements.formFancyContainer);var self=this;var opts=$merge({policyFile:('https:'==document.location.protocol?'https://':'http://')
+document.location.host
+en4.core.baseUrl+'cross-domain',url:fullUrl,appendCookieData:true,multiple:false,typeFilter:{'Images (*.jpg, *.jpeg, *.gif, *.png)':'*.jpg; *.jpeg; *.gif; *.png'},target:this.elements.formFancyFile,container:self.elements.body,onLoad:function(){self.elements.formFancyContainer.setStyle('display','');self.elements.formFancyContainer.setStyle('visibility','visible');self.elements.form.destroy();this.target.addEvents({click:function(){return false;},mouseenter:function(){this.addClass('hover');},mouseleave:function(){this.removeClass('hover');this.blur();},mousedown:function(){this.focus();}});},onSelectSuccess:function(){self.makeLoading('invisible');this.start();},onFileSuccess:function(file,response){var json=new Hash(JSON.decode(response,true)||{});self.doProcessResponse(json);}},this.options.fancyUploadOptions);try{this.elements.formFancyUpload=new FancyUpload2(this.elements.formFancyStatus,this.elements.formFancyList,opts);}catch(e){}}},deactivate:function(){if(!this.active)return;this.parent();},doRequest:function(){this.elements.iframe=new IFrame({'name':'composePhotoFrame','src':'javascript:false;','styles':{'display':'none'},'events':{'load':function(){this.doProcessResponse(window._composePhotoResponse);window._composePhotoResponse=false;}.bind(this)}}).inject(this.elements.body);window._composePhotoResponse=false;this.elements.form.set('target','composePhotoFrame');this.elements.form.submit();this.elements.form.destroy();this.makeLoading();},doProcessResponse:function(responseJSON){if(($type(responseJSON)!='hash'&&$type(responseJSON)!='object')||$type(responseJSON.src)!='string'||$type(parseInt(responseJSON.photo_id))!='number'){this.elements.loading.destroy();this.elements.body.empty();if(responseJSON.error=='Invalid data'){this.makeError(this._lang('The image you tried to upload exceeds the maximum file size.'),'empty');}
else{this.makeError(this._lang('Unable to upload photo.'),'empty');}
return;}
this.params.set('rawParams',responseJSON);this.params.set('photo_id',responseJSON.photo_id);this.elements.preview=Asset.image(responseJSON.src,{'id':'compose-photo-preview-image','class':'compose-preview-image','onload':this.doImageLoaded.bind(this)});},doImageLoaded:function(){if($('compose-photo-error')){$('compose-photo-error').destroy();}
if(this.elements.loading)this.elements.loading.destroy();if(this.elements.formFancyContainer)this.elements.formFancyContainer.destroy();this.elements.preview.erase('width');this.elements.preview.erase('height');this.elements.preview.inject(this.elements.body);this.makeFormInputs();},makeFormInputs:function(){this.ready();this.parent({'photo_id':this.params.photo_id});}});})();;Swiff.Uploader=new Class({Extends:Swiff,Implements:Events,options:{path:'Swiff.Uploader.swf',target:null,zIndex:9999,height:30,width:100,callBacks:null,params:{wMode:'opaque',menu:'false',allowScriptAccess:'always'},typeFilter:null,multiple:true,queued:true,verbose:false,url:null,method:null,data:null,mergeData:true,fieldName:null,fileSizeMin:1,fileSizeMax:null,allowDuplicates:false,timeLimit:(Browser.Platform.linux)?0:30,buttonImage:null,policyFile:null,fileListMax:0,fileListSizeMax:0,instantStart:false,appendCookieData:false,fileClass:null},initialize:function(options){this.addEvent('load',this.initializeSwiff,true).addEvent('select',this.processFiles,true).addEvent('complete',this.update,true).addEvent('fileRemove',function(file){this.fileList.erase(file);}.bind(this),true);this.setOptions(options);if(this.options.callBacks){Hash.each(this.options.callBacks,function(fn,name){this.addEvent(name,fn);},this);}
this.options.callBacks={fireCallback:this.fireCallback.bind(this)};var path=this.options.path;if(!path.contains('?'))path+='?noCache='+$time();this.options.container=this.box=new Element('span',{'class':'swiff-uploader-box'}).inject($(this.options.container)||document.body);this.target=$(this.options.target);if(this.target){var scroll=window.getScroll();this.box.setStyles({position:'absolute',visibility:'visible',zIndex:this.options.zIndex,overflow:'hidden',height:1,width:1,top:scroll.y,left:scroll.x});this.parent(path,{params:{wMode:'transparent'},height:'100%',width:'100%'});this.target.addEvent('mouseenter',this.reposition.bind(this,[]));this.addEvents({buttonEnter:this.targetRelay.bind(this,['mouseenter']),buttonLeave:this.targetRelay.bind(this,['mouseleave']),buttonDown:this.targetRelay.bind(this,['mousedown']),buttonDisable:this.targetRelay.bind(this,['disable'])});this.reposition();window.addEvent('resize',this.reposition.bind(this,[]));}else{this.parent(path);}
this.inject(this.box);this.fileList=[];this.size=this.uploading=this.bytesLoaded=this.percentLoaded=0;if(Browser.Plugins.Flash.version<9){this.fireEvent('fail',['flash']);}else{this.verifyLoad.delay(1000,this);}},verifyLoad:function(){if(this.loaded)return;if(!this.object.parentNode){this.fireEvent('fail',['disabled']);}else if(this.object.style.display=='none'){this.fireEvent('fail',['hidden']);}else if(!this.object.offsetWidth){this.fireEvent('fail',['empty']);}},fireCallback:function(name,args){if(name.substr(0,4)=='file'){if(args.length>1)this.update(args[1]);var data=args[0];var file=this.findFile(data.id);this.fireEvent(name,file||data,5);if(file){var fire=name.replace(/^file([A-Z])/,function($0,$1){return $1.toLowerCase();});file.update(data).fireEvent(fire,[data],10);}}else{this.fireEvent(name,args,5);}},update:function(data){$extend(this,data);this.fireEvent('queue',[this],10);return this;},findFile:function(id){for(var i=0;i<this.fileList.length;i++){if(this.fileList[i].id==id)return this.fileList[i];}
return null;},initializeSwiff:function(){this.remote('initialize',{width:this.options.width,height:this.options.height,typeFilter:this.options.typeFilter,multiple:this.options.multiple,queued:this.options.queued,url:this.options.url,method:this.options.method,data:this.options.data,mergeData:this.options.mergeData,fieldName:this.options.fieldName,verbose:this.options.verbose,fileSizeMin:this.options.fileSizeMin,fileSizeMax:this.options.fileSizeMax,allowDuplicates:this.options.allowDuplicates,timeLimit:this.options.timeLimit,buttonImage:this.options.buttonImage,policyFile:this.options.policyFile});this.loaded=true;this.appendCookieData();},targetRelay:function(name){if(this.target)this.target.fireEvent(name);},reposition:function(coords){if($type(coords)=='array'&&coords.length==0){coords=null;}
coords=coords||((this.target&&this.target.offsetHeight)?this.target.getCoordinates():{top:window.getScrollTop(),left:0,width:40,height:40})
if('right'in coords&&(Browser.Engine.webkit||Browser.Engine.trident)&&$try(function(){return $$('html')[0].get('dir')=='rtl'})){coords.right=$$('body')[0].getComputedSize().x-coords.right;}
this.box.setStyles(coords);this.fireEvent('reposition',[coords,this.box,this.target]);},setOptions:function(options){if(options){if(options.url)options.url=Swiff.Uploader.qualifyPath(options.url);if(options.buttonImage)options.buttonImage=Swiff.Uploader.qualifyPath(options.buttonImage);this.parent(options);if(this.loaded)this.remote('setOptions',options);}
return this;},setEnabled:function(status){this.remote('setEnabled',status);},start:function(){this.fireEvent('beforeStart');this.remote('UploadStart');},stop:function(){this.fireEvent('beforeStop');this.remote('UploadStop');},remove:function(){this.fireEvent('beforeRemove');this.remote('remove');},fileStart:function(file){this.remote('fileStart',file.id);},fileStop:function(file){this.remote('fileStop',file.id);},fileRemove:function(file){this.remote('fileRemove',file.id);},fileRequeue:function(file){this.remote('fileRequeue',file.id);},appendCookieData:function(){var append=this.options.appendCookieData;if(!append)return;var hash={};document.cookie.split(/;\s*/).each(function(cookie){cookie=cookie.split('=');if(cookie.length==2){hash[decodeURIComponent(cookie[0])]=decodeURIComponent(cookie[1]);}});var data=this.options.data||{};if($type(append)=='string')data[append]=hash;else $extend(data,hash);this.setOptions({data:data});},processFiles:function(successraw,failraw,queue){var cls=this.options.fileClass||Swiff.Uploader.File;var fail=[],success=[];if(successraw){successraw.each(function(data){var ret=new cls(this,data);if(!ret.validate()){ret.remove.delay(10,ret);fail.push(ret);}else{this.size+=data.size;this.fileList.push(ret);success.push(ret);ret.render();}},this);this.fireEvent('selectSuccess',[success],10);}
if(failraw||fail.length){fail.extend((failraw)?failraw.map(function(data){return new cls(this,data);},this):[]).each(function(file){file.invalidate().render();});this.fireEvent('selectFail',[fail],10);}
this.update(queue);if(this.options.instantStart&&success.length)this.start();}});$extend(Swiff.Uploader,{STATUS_QUEUED:0,STATUS_RUNNING:1,STATUS_ERROR:2,STATUS_COMPLETE:3,STATUS_STOPPED:4,log:function(){if(window.console&&console.info)console.info.apply(console,arguments);},unitLabels:{b:[{min:1,unit:'B'},{min:1024,unit:'kB'},{min:1048576,unit:'MB'},{min:1073741824,unit:'GB'}],s:[{min:1,unit:'s'},{min:60,unit:'m'},{min:3600,unit:'h'},{min:86400,unit:'d'}]},formatUnit:function(base,type,join){var labels=Swiff.Uploader.unitLabels[(type=='bps')?'b':type];var append=(type=='bps')?'/s':'';var i,l=labels.length,value;if(base<1)return'0 '+labels[0].unit+append;if(type=='s'){var units=[];for(i=l-1;i>=0;i--){value=Math.floor(base/labels[i].min);if(value){units.push(value+' '+labels[i].unit);base-=value*labels[i].min;if(!base)break;}}
return(join===false)?units:units.join(join||', ');}
for(i=l-1;i>=0;i--){value=labels[i].min;if(base>=value)break;}
return(base/value).toFixed(1)+' '+labels[i].unit+append;}});Swiff.Uploader.qualifyPath=(function(){var anchor;return function(path){(anchor||(anchor=new Element('a'))).href=path;return anchor.href;};})();Swiff.Uploader.File=new Class({Implements:Events,initialize:function(base,data){this.base=base;this.update(data);},update:function(data){return $extend(this,data);},validate:function(){var options=this.base.options;if(options.fileListMax&&this.base.fileList.length>=options.fileListMax){this.validationError='fileListMax';return false;}
if(options.fileListSizeMax&&(this.base.size+this.size)>options.fileListSizeMax){this.validationError='fileListSizeMax';return false;}
return true;},invalidate:function(){this.invalid=true;this.base.fireEvent('fileInvalid',this,10);return this.fireEvent('invalid',this,10);},render:function(){return this;},setOptions:function(options){if(options){if(options.url)options.url=Swiff.Uploader.qualifyPath(options.url);this.base.remote('fileSetOptions',this.id,options);this.options=$merge(this.options,options);}
return this;},start:function(){this.base.fileStart(this);return this;},stop:function(){this.base.fileStop(this);return this;},remove:function(){this.base.fileRemove(this);return this;},requeue:function(){this.base.fileRequeue(this);}});;Fx.ProgressBar=new Class({Extends:Fx,options:{text:null,url:null,transition:Fx.Transitions.Circ.easeOut,fit:true,link:'cancel'},initialize:function(element,options){this.element=$(element);this.parent(options);var url=this.options.url;if(url){this.element.setStyles({'background-image':'url('+url+')','background-repeat':'no-repeat'});}
if(this.options.fit){url=url||this.element.getStyle('background-image').replace(/^url\(["']?|["']?\)$/g,'');if(url){var fill=new Image();fill.onload=function(){this.fill=fill.width;fill=fill.onload=null;this.set(this.now||0);}.bind(this);fill.src=url;if(!this.fill&&fill.width)fill.onload();}}else{this.set(0);}},start:function(to,total){return this.parent(this.now,(arguments.length==1)?to.limit(0,100):to/total*100);},set:function(to){this.now=to;var css=(this.fill)?(((this.fill/-2)+(to/100)*(this.element.width||1)||0).round()+'px'):((100-to)+'%');this.element.setStyle('backgroundPosition',css+' 0px').title=Math.round(to)+'%';var text=$(this.options.text);if(text)text.set('text',Math.round(to)+'%');return this;}});;var FancyUpload2=new Class({Extends:Swiff.Uploader,options:{queued:1,limitSize:0,limitFiles:0,validateFile:$lambda(true)},initialize:function(status,list,options){this.status=$(status);this.list=$(list);options.fileClass=options.fileClass||FancyUpload2.File;options.fileSizeMax=options.limitSize||options.fileSizeMax;options.fileListMax=options.limitFiles||options.fileListMax;this.parent(options);this.addEvents({'load':this.render,'select':this.onSelect,'cancel':this.onCancel,'start':this.onStart,'queue':this.onQueue,'complete':this.onComplete});},render:function(){this.overallTitle=this.status.getElement('.overall-title');this.currentTitle=this.status.getElement('.current-title');this.currentText=this.status.getElement('.current-text');var progress=this.status.getElement('.overall-progress');this.overallProgress=new Fx.ProgressBar(progress,{text:new Element('span',{'class':'progress-text'}).inject(progress,'after')});progress=this.status.getElement('.current-progress')
this.currentProgress=new Fx.ProgressBar(progress,{text:new Element('span',{'class':'progress-text'}).inject(progress,'after')});this.updateOverall();},onSelect:function(){this.status.removeClass('status-browsing');},onCancel:function(){this.status.removeClass('file-browsing');},onStart:function(){this.status.addClass('file-uploading');this.overallProgress.set(0);},onQueue:function(){this.updateOverall();},onComplete:function(){this.status.removeClass('file-uploading');if(this.size){this.overallProgress.start(100);}else{this.overallProgress.set(0);this.currentProgress.set(0);}},updateOverall:function(){this.overallTitle.set('html',MooTools.lang.get('FancyUpload','progressOverall').substitute({total:Swiff.Uploader.formatUnit(this.size,'b')}));if(!this.size){this.currentTitle.set('html',MooTools.lang.get('FancyUpload','currentTitle'));this.currentText.set('html','');}},upload:function(){this.start();},removeFile:function(){return this.remove();}});FancyUpload2.File=new Class({Extends:Swiff.Uploader.File,render:function(){if(this.invalid){if(this.validationError){var msg=MooTools.lang.get('FancyUpload','validationErrors')[this.validationError]||this.validationError;this.validationErrorMessage=msg.substitute({name:this.name,size:Swiff.Uploader.formatUnit(this.size,'b'),fileSizeMin:Swiff.Uploader.formatUnit(this.base.options.fileSizeMin||0,'b'),fileSizeMax:Swiff.Uploader.formatUnit(this.base.options.fileSizeMax||0,'b'),fileListMax:this.base.options.fileListMax||0,fileListSizeMax:Swiff.Uploader.formatUnit(this.base.options.fileListSizeMax||0,'b')});}
this.remove();return;}
this.addEvents({'start':this.onStart,'progress':this.onProgress,'complete':this.onComplete,'error':this.onError,'remove':this.onRemove});this.info=new Element('span',{'class':'file-info'});this.element=new Element('li',{'class':'file'}).adopt(new Element('span',{'class':'file-size','html':Swiff.Uploader.formatUnit(this.size,'b')}),new Element('a',{'class':'file-remove',href:'#',html:MooTools.lang.get('FancyUpload','remove'),title:MooTools.lang.get('FancyUpload','removeTitle'),events:{click:function(){this.remove();return false;}.bind(this)}}),new Element('span',{'class':'file-name','html':MooTools.lang.get('FancyUpload','fileName').substitute(this)}),this.info).inject(this.base.list);},validate:function(){return(this.parent()&&this.base.options.validateFile(this));},onStart:function(){this.element.addClass('file-uploading');this.base.currentProgress.cancel().set(0);this.base.currentTitle.set('html',MooTools.lang.get('FancyUpload','currentFile').substitute(this));},onProgress:function(){this.base.overallProgress.start(this.base.percentLoaded);this.base.currentText.set('html',MooTools.lang.get('FancyUpload','currentProgress').substitute({rate:(this.progress.rate)?Swiff.Uploader.formatUnit(this.progress.rate,'bps'):'- B',bytesLoaded:Swiff.Uploader.formatUnit(this.progress.bytesLoaded,'b'),timeRemaining:(this.progress.timeRemaining)?Swiff.Uploader.formatUnit(this.progress.timeRemaining,'s'):'-'}));this.base.currentProgress.start(this.progress.percentLoaded);},onComplete:function(){this.element.removeClass('file-uploading');this.base.currentText.set('html','Upload completed');this.base.currentProgress.start(100);if(this.response.error){var msg=MooTools.lang.get('FancyUpload','errors')[this.response.error]||'{error} #{code}';this.errorMessage=msg.substitute($extend({name:this.name,size:Swiff.Uploader.formatUnit(this.size,'b')},this.response));var args=[this,this.errorMessage,this.response];this.fireEvent('error',args).base.fireEvent('fileError',args);}else{this.base.fireEvent('fileSuccess',[this,this.response.text||'']);}},onError:function(){this.element.addClass('file-failed');var error=MooTools.lang.get('FancyUpload','fileError').substitute(this);this.info.set('html','<strong>'+error+':</strong> '+this.errorMessage);},onRemove:function(){this.element.getElements('a').setStyle('visibility','hidden');this.element.fade('out').retrieve('tween').chain(Element.destroy.bind(Element,this.element));}});(function(){var phrases={'progressOverall':'Overall Progress ({total})','currentTitle':'File Progress','currentFile':'Uploading "{name}"','currentProgress':'Upload: {bytesLoaded} with {rate}, {timeRemaining} remaining.','fileName':'{name}','remove':'Remove','removeTitle':'Click to remove this entry.','fileError':'Upload failed','validationErrors':{'duplicate':'{name} already added.','sizeLimitMin':'{name} ({size}) is too small, the minimal file size is {fileSizeMin}.','sizeLimitMax':'{name} ({size}) is too big, the maximal file size is {fileSizeMax}.','fileListMax':'{name} could not be added, amount of {fileListMax} files exceeded.','fileListSizeMax':'{name} ({size}) is too big, overall filesize of {fileListSizeMax} exceeded.'},'errors':{'httpStatus':'Server returned HTTP-Status <code>#{code}</code>','securityError':'Security error occurred ({text})','ioError':'Error caused a send or load operation to fail ({text})'}};if(('en4'in window)&&$type(en4)&&$type(en4.core.language)){$H(phrases).each(function(value,key){if($type(value)=='string'){phrases[key]=en4.core.language.translate(value);}else if($type(value)=='object'){$H(value).each(function(pvalue,pkey){if($type(value)=='string'){phrases[key][pkey]=en4.core.language.translate(pvalue);}});}});}
if(MooTools.lang){MooTools.lang.set('en-US','FancyUpload',phrases);}else{MooTools.lang={data:{'FancyUpload':phrases},get:function(from,key){return this.data[from][key];},set:function(locale,from,data){data[from]=data;}};}})();;(function(){var $='id'in document?document.id:window.$;Composer.Plugin.Link=new Class({Extends:Composer.Plugin.Interface,name:'link',options:{title:'Add Link',lang:{},requestOptions:{},imageMaxAspect:(10/3),imageMinAspect:(3/10),imageMinSize:48,imageMaxSize:5000,imageMinPixels:2304,imageMaxPixels:1000000,imageTimeout:5000,monitorDelay:600,debug:false},initialize:function(options){this.params=new Hash(this.params);this.parent(options);},attach:function(){this.parent();this.makeActivator();this.monitorLastContent='';this.monitorLastMatch='';this.monitorLastKeyPress=$time();this.getComposer().addEvent('editorKeyPress',function(){this.monitorLastKeyPress=$time();}.bind(this));return this;},detach:function(){this.parent();if(this.interval)$clear(this.interval);return this;},activate:function(){if(this.active)return;this.parent();this.makeMenu();this.makeBody();this.elements.formInput=new Element('input',{'id':'compose-link-form-input','class':'compose-form-input','type':'text'}).inject(this.elements.body);this.elements.formSubmit=new Element('button',{'id':'compose-link-form-submit','class':'compose-form-submit','html':this._lang('Attach'),'events':{'click':function(e){e.stop();this.doAttach();}.bind(this)}}).inject(this.elements.body);this.elements.formInput.focus();},deactivate:function(){if(!this.active)return;this.parent();this.request=false;},poll:function(){if(this.getComposer().hasActivePlugin())return;if($time()<this.monitorLastKeyPress+this.options.monitorDelay)return;var content=this.getComposer().getContent();if(content==this.monitorLastContent)return;this.monitorLastContent=content;var m=content.match(/http:\/\/([-\w\.]+)+(:\d+)?(\/([-#:\w/_\.]*(\?\S+)?)?)?/);if($type(m)&&$type(m[0])&&this.monitorLastMatch!=m[0])
{this.monitorLastMatch=m[0];this.activate();this.elements.formInput.value=this.monitorLastMatch;this.doAttach();}},doAttach:function(){var val=this.elements.formInput.value;if(!val){return;}
if(!val.match(/^[a-zA-Z]{1,5}:\/\//))
{val='http://'+val;}
this.params.set('uri',val)
if(val==''){e.stop();return;}
var options=$merge({'data':{'format':'json','uri':val},'onComplete':this.doProcessResponse.bind(this)},this.options.requestOptions);this.makeLoading('empty');this.request=new Request.JSON(options);this.request.send();},doProcessResponse:function(responseJSON,responseText){if($type(responseJSON)!='object'){responseJSON={'status':false};}
this.params.set('uri',responseJSON.url);var uristr=responseJSON.url;if(uristr.substr(0,23)=='https://docs.google.com'){var title=uristr;var description='Google Document';}else{var title=responseJSON.title||responseJSON.url;var description=responseJSON.description||responseJSON.title||responseJSON.url;}
var images=responseJSON.images||[];this.params.set('title',title);this.params.set('description',description);this.params.set('images',images);this.params.set('loadedImages',[]);this.params.set('thumb','');if(images.length>0){this.doLoadImages();}else{this.doShowPreview();}},doLoadImages:function(){var interval=(function(){if(this.options.debug){console.log('Timeout reached');}
this.doShowPreview();}).delay(this.options.imageTimeout,this);this.params.loadedImages=[];this.params.set('assets',new Asset.images(this.params.get('images'),{'properties':{'class':'compose-link-image'},'onProgress':function(counter,index){this.params.loadedImages[index]=this.params.images[index];if(this.options.debug){console.log('Loaded - ',this.params.images[index]);}}.bind(this),'onError':function(counter,index){delete this.params.images[index];}.bind(this),'onComplete':function(){$clear(interval);this.doShowPreview();}.bind(this)}));},doShowPreview:function(){var self=this;this.elements.body.empty();this.makeFormInputs();if(this.params.loadedImages.length>0){var tmp=new Array();this.elements.previewImages=new Element('div',{'id':'compose-link-preview-images','class':'compose-preview-images'}).inject(this.elements.body);this.params.assets.each(function(element,index){if(!$type(this.params.loadedImages[index]))return;element.addClass('compose-preview-image-invisible').inject(this.elements.previewImages);if(!this.checkImageValid(element)){delete this.params.images[index];delete this.params.loadedImages[index];element.destroy();}else{element.removeClass('compose-preview-image-invisible').addClass('compose-preview-image-hidden');tmp.push(this.params.loadedImages[index]);element.erase('height');element.erase('width');}}.bind(this));this.params.loadedImages=tmp;if(this.params.loadedImages.length<=0){this.elements.previewImages.destroy();}}
this.elements.previewInfo=new Element('div',{'id':'compose-link-preview-info','class':'compose-preview-info'}).inject(this.elements.body);this.elements.previewTitle=new Element('div',{'id':'compose-link-preview-title','class':'compose-preview-title'}).inject(this.elements.previewInfo);this.elements.previewTitleLink=new Element('a',{'href':this.params.uri,'html':this.params.title,'events':{'click':function(e){e.stop();self.handleEditTitle(this);}}}).inject(this.elements.previewTitle);this.elements.previewDescription=new Element('div',{'id':'compose-link-preview-description','class':'compose-preview-description','html':this.params.description,'events':{'click':function(e){e.stop();self.handleEditDescription(this);}}}).inject(this.elements.previewInfo);if(this.params.loadedImages.length>0){this.elements.previewOptions=new Element('div',{'id':'compose-link-preview-options','class':'compose-preview-options'}).inject(this.elements.previewInfo);if(this.params.loadedImages.length>1){this.elements.previewChoose=new Element('div',{'id':'compose-link-preview-options-choose','class':'compose-preview-options-choose','html':'<span>'+this._lang('Choose Image:')+'</span>'}).inject(this.elements.previewOptions);this.elements.previewPrevious=new Element('a',{'id':'compose-link-preview-options-previous','class':'compose-preview-options-previous','href':'javascript:void(0);','html':'&#171; '+this._lang('Last'),'events':{'click':this.doSelectImagePrevious.bind(this)}}).inject(this.elements.previewChoose);this.elements.previewCount=new Element('span',{'id':'compose-link-preview-options-count','class':'compose-preview-options-count'}).inject(this.elements.previewChoose);this.elements.previewPrevious=new Element('a',{'id':'compose-link-preview-options-next','class':'compose-preview-options-next','href':'javascript:void(0);','html':this._lang('Next')+' &#187;','events':{'click':this.doSelectImageNext.bind(this)}}).inject(this.elements.previewChoose);}
this.elements.previewNoImage=new Element('div',{'id':'compose-link-preview-options-none','class':'compose-preview-options-none'}).inject(this.elements.previewOptions);this.elements.previewNoImageInput=new Element('input',{'id':'compose-link-preview-options-none-input','class':'compose-preview-options-none-input','type':'checkbox','events':{'click':this.doToggleNoImage.bind(this)}}).inject(this.elements.previewNoImage);this.elements.previewNoImageLabel=new Element('label',{'for':'compose-link-preview-options-none-input','html':this._lang('Don\'t show an image'),'events':{}}).inject(this.elements.previewNoImage);this.setImageThumb(this.elements.previewImages.getChildren()[0]);}},checkImageValid:function(element){var size=element.getSize();var sizeAlt={x:element.get('width'),y:element.get('height')};var width=sizeAlt.x||size.x;var height=sizeAlt.y||size.y;var pixels=width*height;var aspect=width/height;if(this.options.debug){console.log(element.get('src'),sizeAlt,size,width,height,pixels,aspect);}
if(aspect>this.options.imageMaxAspect){if(this.options.debug){console.log('Aspect greater than max - ',element.get('src'),aspect,this.options.imageMaxAspect);}
return false;}else if(aspect<this.options.imageMinAspect){if(this.options.debug){console.log('Aspect less than min - ',element.get('src'),aspect,this.options.imageMinAspect);}
return false;}
if(width<this.options.imageMinSize){if(this.options.debug){console.log('Width less than min - ',element.get('src'),width,this.options.imageMinSize);}
return false;}else if(height<this.options.imageMinSize){if(this.options.debug){console.log('Height less than min - ',element.get('src'),height,this.options.imageMinSize);}
return false;}
if(width>this.options.imageMaxSize){if(this.options.debug){console.log('Width greater than max - ',element.get('src'),width,this.options.imageMaxSize);}
return false;}else if(height>this.options.imageMaxSize){if(this.options.debug){console.log('Height greater than max - ',element.get('src'),height,this.options.imageMaxSize);}
return false;}
if(pixels<this.options.imageMinPixels){if(this.options.debug){console.log('Pixel count less than min - ',element.get('src'),pixels,this.options.imageMinPixels);}
return false;}else if(pixels>this.options.imageMaxPixels){if(this.options.debug){console.log('Pixel count greater than max - ',element.get('src'),pixels,this.options.imageMaxPixels);}
return false;}
return true;},doSelectImagePrevious:function(){if(this.elements.imageThumb&&this.elements.imageThumb.getPrevious()){this.setImageThumb(this.elements.imageThumb.getPrevious());}},doSelectImageNext:function(){if(this.elements.imageThumb&&this.elements.imageThumb.getNext()){this.setImageThumb(this.elements.imageThumb.getNext());}},doToggleNoImage:function(){if(!$type(this.params.thumb)){this.params.thumb=this.elements.imageThumb.src;this.setFormInputValue('thumb',this.params.thumb);this.elements.previewImages.setStyle('display','');if(this.elements.previewChoose)this.elements.previewChoose.setStyle('display','');}else{delete this.params.thumb;this.setFormInputValue('thumb','');this.elements.previewImages.setStyle('display','none');if(this.elements.previewChoose)this.elements.previewChoose.setStyle('display','none');}},setImageThumb:function(element){if(this.elements.imageThumb){this.elements.imageThumb.addClass('compose-preview-image-hidden');}
if(element){element.removeClass('compose-preview-image-hidden');this.elements.imageThumb=element;this.params.thumb=element.src;this.setFormInputValue('thumb',element.src);if(this.elements.previewCount){var index=this.params.loadedImages.indexOf(element.src);if(index<0){index=0;}
this.elements.previewCount.set('html',' | '+this._lang('%d of %d',index+1,this.params.loadedImages.length)+' | ');}}else{this.elements.imageThumb=false;delete this.params.thumb;}},makeFormInputs:function(){this.ready();this.parent({'uri':this.params.uri,'title':this.params.title,'description':this.params.description,'thumb':this.params.thumb});},handleEditTitle:function(element){element.setStyle('display','none');var input=new Element('input',{'type':'text','value':element.get('text').trim(),'events':{'blur':function(){if(input.value.trim()!=''){this.params.title=input.value;element.set('text',this.params.title);this.setFormInputValue('title',this.params.title);}
element.setStyle('display','');input.destroy();}.bind(this)}}).inject(element,'after');input.focus();},handleEditDescription:function(element){element.setStyle('display','none');var input=new Element('textarea',{'html':element.get('text').trim(),'events':{'blur':function(){if(input.value.trim()!=''){this.params.description=input.value;element.set('text',this.params.description);this.setFormInputValue('description',this.params.description);}
element.setStyle('display','');input.destroy();}.bind(this)}}).inject(element,'after');input.focus();}});})();;var Observer=new Class({Implements:[Options,Events],options:{periodical:false,delay:1000},initialize:function(el,onFired,options){this.element=$(el)||$$(el);this.addEvent('onFired',onFired);this.setOptions(options);this.bound=this.changed.bind(this);this.resume();},changed:function(){var value=this.element.get('value');if($equals(this.value,value))return;this.clear();this.value=value;this.timeout=this.onFired.delay(this.options.delay,this);},setValue:function(value){this.value=value;this.element.set('value',value);return this.clear();},onFired:function(){this.fireEvent('onFired',[this.value,this.element]);},clear:function(){$clear(this.timeout||null);return this;},pause:function(){if(this.timer)$clear(this.timer);else this.element.removeEvent('keyup',this.bound);return this.clear();},resume:function(){this.value=this.element.get('value');if(this.options.periodical)this.timer=this.changed.periodical(this.options.periodical,this);else this.element.addEvent('keyup',this.bound);return this;}});var $equals=function(obj1,obj2){return(obj1==obj2||JSON.encode(obj1)==JSON.encode(obj2));};;var Autocompleter=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:true,width:'inherit',maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:true,className:'autocompleter-choices',zIndex:42,delay:1,observerOptions:{},fxOptions:{},autoSubmit:false,overflow:false,overflowMargin:25,selectFirst:true,filter:null,filterCase:false,filterSubset:false,forceSelect:false,selectMode:true,choicesMatch:null,multiple:false,separator:', ',separatorSplit:/\s*[,;]\s*/,autoTrim:false,allowDupes:false,cache:true,relative:true,tokenFormat:'object',tokenIdKey:'id',tokenValueKey:'label',prefetchOnInit:false,alwaysOpen:false,ignoreKeys:false,ignoreOverlayFix:false},initialize:function(element,options){this.element=$(element);this.setOptions(options);this.build();this.observer=new Observer(this.element,this.prefetch.bind(this),$merge({'delay':this.options.delay},this.options.observerOptions));this.queryValue=null;if(this.options.filter)this.filter=this.options.filter.bind(this);var mode=this.options.selectMode;this.typeAhead=(mode=='type-ahead');this.selectMode=(mode===true)?'selection':mode;this.cached=[];if(this.options.prefetchOnInit)this.prefetch.delay(this.options.delay+50,this);},build:function(){if($(this.options.customChoices)){this.choices=this.options.customChoices;}else{this.choices=new Element('ul',{'class':this.options.className,'styles':{'zIndex':this.options.zIndex}}).inject(document.body);this.relative=false;if(this.options.relative){this.choices.inject(this.element,'after');this.relative=this.element.getOffsetParent();}
if(!this.options.ignoreOverlayFix)this.fix=new OverlayFix(this.choices);}
if(!this.options.separator.test(this.options.separatorSplit)){this.options.separatorSplit=this.options.separator;}
if(!this.options.alwaysOpen){this.fx=(!this.options.fxOptions)?null:new Fx.Tween(this.choices,$merge({'property':'opacity','link':'cancel','duration':200},this.options.fxOptions)).addEvent('onStart',Chain.prototype.clearChain).set(0);}
this.element.setProperty('autocomplete','off').addEvent((Browser.Engine.trident||Browser.Engine.webkit)?'keydown':'keypress',this.onCommand.bind(this)).addEvent('click',this.onCommand.bind(this,[false]));if(!this.options.alwaysOpen){this.element.addEvent('focus',this.toggleFocus.create({bind:this,arguments:true,delay:100})).addEvent('blur',this.toggleFocus.create({bind:this,arguments:false,delay:100}));}},destroy:function(){if(this.fix)this.fix.destroy();this.choices=this.selected=this.choices.destroy();},toggleFocus:function(state){this.focussed=state;if(!state)this.hideChoices(true);this.fireEvent((state)?'onFocus':'onBlur',[this.element]);},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift&&!this.options.ignoreKeys){switch(e.key){case'enter':e.stop();if(!this.selected){if(!this.options.customChoices){this.element.value='';}
return true;}
if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}
break;case'up':case'down':var value=this.element.value;if(!this.prefetch()&&this.queryValue!==null){var up=(e.key=='up');this.choiceOver((this.selected||this.choices)[(this.selected)?((up)?'getPrevious':'getNext'):((up)?'getLast':'getFirst')](this.options.choicesMatch),true);this.element.value=value;}
return false;case'esc':this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;case'tab':if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}else{this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;}}}
this.fireEvent('onCommand',e);return true;},setSelection:function(finish){var tokenInfo=this.selected.retrieve('autocompleteChoice');var input=(this.options.tokenFormat=='object'?tokenInfo[this.options.tokenValueKey]:tokenInfo);var value=input;var start=this.queryValue.length,end=input.length;if((input.substr(0,start)||'').toLowerCase()!=(this.queryValue||'').toLowerCase())start=0;if(this.options.multiple){var split=this.options.separatorSplit;value=this.element.value;start+=this.queryIndex;end+=this.queryIndex;var old=value.substr(this.queryIndex).split(split,1)[0];value=value.substr(0,this.queryIndex)+input+value.substr(this.queryIndex+old.length);if(finish){var tokens=value.split(this.options.separatorSplit).filter(function(entry){return this.test(entry);},/[^\s,]+/);if(!this.options.allowDupes)tokens=[].combine(tokens);var sep=this.options.separator;value=tokens.join(sep)+sep;end=value.length;}}
if(this.options.autocompleteType=='tag')this.observer.setValue(value);this.opted=value;if(finish||this.selectMode=='pick')start=end;$try(function(){this.element.selectRange(start,end)}.bind(this));this.fireEvent('onSelection',[this.element,this.selected,value,input]);},showChoices:function(){var match=this.options.choicesMatch,first=this.choices.getFirst(match);this.selected=this.selectedValue=null;if(this.fix){var pos=this.element.getCoordinates(this.relative),width=this.options.width||'auto';this.choices.setStyles({'width':(width===true||width=='inherit')?pos.width:width});}
if(!first)return;if(!this.visible){this.visible=true;this.choices.setStyle('display','');if(this.fx)this.fx.start(1);this.fireEvent('onShow',[this.element,this.choices]);}
if(this.options.selectFirst||this.typeAhead||first.inputValue==this.queryValue)this.choiceOver(first,this.typeAhead);var items=this.choices.getChildren(match),max=this.options.maxChoices;var styles={'overflowY':'hidden','height':''};this.overflown=false;if(items.length>max){var item=items[max-1];styles.overflowY='scroll';styles.height=item.getCoordinates(this.choices).bottom;this.overflown=true;};this.choices.setStyles(styles);if(this.fix)this.fix.show();if(this.options.visibleChoices){var scroll=document.getScroll(),size=document.getSize(),coords=this.choices.getCoordinates();if(coords.right>scroll.x+size.x)scroll.x=coords.right-size.x;if(coords.bottom>scroll.y+size.y)scroll.y=coords.bottom-size.y;window.scrollTo(Math.min(scroll.x,coords.left),Math.min(scroll.y,coords.top));}},hideChoices:function(clear){if(clear){var value=this.element.value;if(this.options.forceSelect)value=this.opted;if(this.options.autoTrim){value=value.split(this.options.separatorSplit).filter($arguments(0)).join(this.options.separator);}
this.observer.setValue(value);}
if(!this.visible)return;this.visible=false;if(this.selected)this.selected.removeClass('autocompleter-selected');this.observer.clear();var hide=function(){this.choices.setStyle('display','none');if(this.fix)this.fix.hide();}.bind(this);if(this.fx)this.fx.start(0).chain(hide);else hide();this.fireEvent('onHide',[this.element,this.choices]);},prefetch:function(){var value=this.element.value,query=value;if(this.options.multiple){var split=this.options.separatorSplit;var values=value.split(split);var index=this.element.getSelectedRange().start;var toIndex=value.substr(0,index).split(split);var last=toIndex.length-1;index-=toIndex[last].length;query=values[last];}
if(query.length<this.options.minLength){this.hideChoices();}else{if(query===this.queryValue||(this.visible&&query==this.selectedValue)){if(this.visible)return false;this.showChoices();}else{this.queryValue=query;this.queryIndex=index;if(!this.fetchCached())this.query();}}
return true;},fetchCached:function(){switch(true){case(!this.options.cache):case(!this.cachedQueryValue||this.queryValue.length<this.cachedQueryValue.length):case(this.queryValue.indexOf(this.cachedQueryValue)==-1):return false;break;}
if(this.cached.length<this.options.maxChoices)
{this.update(this.filter(this.cached));return true;}
var newChoices=this.filter(this.cached,this.queryValue);if(newChoices.length>=this.cached.length)
{this.update(this.filter(this.cached));return true;}
return false;},update:function(tokens){$(this.choices).empty();this.cached=tokens;this.cachedQueryValue=this.queryValue;var type=tokens&&$type(tokens);if(!type||(type=='array'&&!tokens.length)||(type=='hash'&&!tokens.getLength())){(this.options.emptyChoices||this.hideChoices).call(this);}else{if(this.options.maxChoices<tokens.length&&!this.options.overflow)tokens.length=this.options.maxChoices;tokens.each(this.options.injectChoice||function(token){tokenValue=(this.options.tokenFormat=='object'?token[this.options.tokenValueKey]:token);var choice=new Element('li',{'html':this.markQueryValue(tokenValue)});this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},this);this.showChoices();}},choiceOver:function(choice,selection){if(!choice||choice==this.selected)return;if(this.selected)this.selected.removeClass('autocompleter-selected');this.selected=choice.addClass('autocompleter-selected');this.fireEvent('onSelect',[this.element,this.selected,selection]);if(!this.selectMode)this.opted=this.element.value;if(!selection)return;this.selectedValue=this.selected.retrieve('autocompleteChoice');if(this.overflown){var coords=this.selected.getCoordinates(this.choices),margin=this.options.overflowMargin,top=this.choices.scrollTop,height=this.choices.offsetHeight,bottom=top+height;if(coords.top-margin<top&&top)this.choices.scrollTop=Math.max(coords.top-margin,0);else if(coords.bottom+margin>bottom)this.choices.scrollTop=Math.min(coords.bottom-height+margin,bottom);}
if(this.selectMode)this.setSelection();},choiceSelect:function(choice){if(choice)this.choiceOver(choice);this.setSelection(true);this.queryValue=false;if(!this.options.alwaysOpen){this.hideChoices();}else{this.observer.setValue('');this.prefetch.delay(this.options.delay,this);}
this.fireEvent('onChoiceSelect',choice);if(this.options.autocompleteType=='message'){this.element.value='';var token=choice.retrieve('autocompleteChoice');if(token.friends){var friend_ids="";for(var id in token.friends){if(friend_ids=="")friend_ids=id;else friend_ids=friend_ids+","+id;}
this.doAddValueToHidden(token.label,friend_ids,'toValues',true,' tag_friend');}
else this.doAddValueToHidden(choice.id,token.id,'toValues',true);}},doAddValueToHidden:function(name,toID,hideLoc,newItem,list){var hiddenInputField=document.getElementById(hideLoc);var previousToValues=hiddenInputField.value;if(this.checkSpanExists(name,toID)){if(previousToValues==''){document.getElementById(hideLoc).value=toID;}
else{document.getElementById(hideLoc).value=previousToValues+","+toID;}
this.doPushSpan(name,toID,newItem,hideLoc,list);}},doPushSpan:function(name,toID,newItem,hideLoc,list){var myElement=new Element("span");if(newItem){myElement.id="tospan_"+name+"_"+toID;myElement.innerHTML=name+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\");'>x</a>";}
else{myElement.id="tospan_"+name+"_"+toID;myElement.innerHTML=name+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\");'>x</a>";}
$('toValues-wrapper').setStyle('height','auto');if(list==null)list="";myElement.addClass("tag"+list);document.getElementById('toValues-element').appendChild(myElement);this.fireEvent('push');},checkToValue:function(toID,toValues){var checkValue=true;var checkMulti=toID.search(/,/);var x;var toValueArray=toValues.split(",");if(checkMulti!=-1){var recipientsArray=toID.split(",");var multiBool=false;for(var i=0;i<recipientsArray.length;i++){var tempBool=true;for(var x=0;x<toValueArray.length;x++){if(toValueArray[x]==recipientsArray[i]){tempBool=false;}}
multiBool=multiBool||tempBool;}
checkValue=multiBool;}
else{for(x in toValueArray)
{if(toValueArray[x]==toID){checkValue=false;}}}
return checkValue;},checkSpanExists:function(name,toID){var span_id="tospan_"+name+"_"+toID;if($(span_id)){return false;}
else return true;},filter:function(tokens,queryValue){queryValue=queryValue||this.queryValue;tokens=tokens||this.tokens;var regex=new RegExp(((this.options.filterSubset)?'':'^')+queryValue.escapeRegExp(),(this.options.filterCase)?'':'i');if(this.options.tokenFormat=='object'){var key=this.options.tokenValueKey;return tokens.filter(function(token){return regex.test(token[key]);});}else{return tokens.filter(function(token){return regex.test(token);});}
return tokens;},markQueryValue:function(str){return(!this.options.markQuery||!this.queryValue)?str:str.replace(new RegExp('('+((this.options.filterSubset)?'':'^')+this.queryValue.escapeRegExp()+')',(this.options.filterCase)?'':'i'),'<span class="autocompleter-queried">$1</span>');},addChoiceEvents:function(el){return el.addEvents({'mouseover':this.choiceOver.bind(this,el),'click':this.choiceSelect.bind(this,el)});}});var OverlayFix=new Class({initialize:function(el){if(Browser.Engine.trident){this.element=$(el);this.relative=this.element.getOffsetParent();this.fix=new Element('iframe',{'frameborder':'0','scrolling':'no','src':'javascript:false;','styles':{'position':'absolute','border':'none','display':'none','filter':'progid:DXImageTransform.Microsoft.Alpha(opacity=0)'}}).inject(this.element,'after');}},show:function(){if(this.fix){var coords=this.element.getCoordinates(this.relative);delete coords.right;delete coords.bottom;this.fix.setStyles($extend(coords,{'display':'','zIndex':(this.element.getStyle('zIndex')||1)-1}));}
return this;},hide:function(){if(this.fix)this.fix.setStyle('display','none');return this;},destroy:function(){if(this.fix)this.fix=this.fix.destroy();}});Element.implement({getSelectedRange:function(){if(!Browser.Engine.trident)return{start:this.selectionStart,end:this.selectionEnd};var pos={start:0,end:0};var range=this.getDocument().selection.createRange();if(!range||range.parentElement()!=this)return pos;var dup=range.duplicate();if(this.type=='text'){pos.start=0-dup.moveStart('character',-100000);pos.end=pos.start+range.text.length;}else{var value=this.value;var offset=value.length-value.match(/[\n\r]*$/)[0].length;dup.moveToElementText(this);dup.setEndPoint('StartToEnd',range);pos.end=offset-dup.text.length;dup.setEndPoint('StartToStart',range);pos.start=offset-dup.text.length;}
return pos;},selectRange:function(start,end){if(Browser.Engine.trident){var diff=this.value.substr(start,end-start).replace(/\r/g,'').length;start=this.value.substr(0,start).replace(/\r/g,'').length;var range=this.createTextRange();range.collapse(true);range.moveEnd('character',start+diff);range.moveStart('character',start);range.select();}else{this.focus();this.setSelectionRange(start,end);}
return this;}});Autocompleter.Base=Autocompleter;;Autocompleter.Local=new Class({Extends:Autocompleter,options:{minLength:0,delay:200},initialize:function(element,tokens,options){this.parent(element,options);this.tokens=tokens;},query:function(){this.update(this.filter());}});;Autocompleter.Request=new Class({Extends:Autocompleter,options:{postData:{},ajaxOptions:{},postVar:'value',delay:250},query:function(){var data=$unlink(this.options.postData)||{};data[this.options.postVar]=this.queryValue;var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','');var cls=this.options.indicatorClass;if(cls)this.element.addClass(cls);this.fireEvent('onRequest',[this.element,this.request,data,this.queryValue]);this.request.send({'data':data});},queryResponse:function(){var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','none');var cls=this.options.indicatorClass;if(cls)this.element.removeClass(cls);return this.fireEvent('onComplete',[this.element,this.request]);}});Autocompleter.Request.JSON=new Class({Extends:Autocompleter.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.JSON($merge({'url':url,'link':'cancel'},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(response){this.parent();this.update(response);}});Autocompleter.Request.HTML=new Class({Extends:Autocompleter.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.HTML($merge({'url':url,'link':'cancel','update':this.choices},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(tree,elements){this.parent();if(!elements||!elements.length){this.hideChoices();}else{this.choices.getChildren(this.options.choicesMatch).each(this.options.injectChoice||function(choice){var value=choice.innerHTML;choice.inputValue=value;this.addChoiceEvents(choice.set('html',this.markQueryValue(value)));},this);this.showChoices();}}});Autocompleter.Ajax={Base:Autocompleter.Request,Json:Autocompleter.Request.JSON,Xhtml:Autocompleter.Request.HTML};;(function(){var $='id'in document?document.id:window.$;Composer.Plugin.Tag=new Class({Extends:Composer.Plugin.Interface,name:'tag',options:{'enabled':false,requestOptions:{},'suggestOptions':{'minLength':0,'maxChoices':100,'delay':250,'selectMode':'pick','multiple':false,'filterSubset':true,'tokenFormat':'object','tokenValueKey':'label','injectChoice':$empty,'onPush':$empty,'prefetchOnInit':true,'alwaysOpen':false,'ignoreKeys':true}},initialize:function(options){this.params=new Hash(this.params);this.parent(options);},suggest:false,attach:function(){if(!this.options.enabled)return;this.parent();this.getComposer().addEvent('editorKeyPress',this.monitor.bind(this));this.getComposer().addEvent('editorClick',this.monitor.bind(this));return this;},detach:function(){if(!this.options.enabled)return;this.parent();this.getComposer().removeEvent('editorKeyPress',this.monitor.bind(this));this.getComposer().removeEvent('editorClick',this.monitor.bind(this));if(this.interval)$clear(this.interval);return this;},activate:$empty,deactivate:$empty,poll:function(){},monitor:function(e){(function(){var start=this.getComposer().selection.getRange().startOffset;var content=this.getComposer().getContent();var atIndexes=content.allIndexesOf('@');var currentIndex=false;var nextIndex=false;atIndexes.each(function(atIndex){if(atIndex>start)
{if(nextIndex==false)nextIndex=atIndex;return;}
currentIndex=atIndex;});if(currentIndex===false){this.endSuggest();return;}
if(!nextIndex)nextIndex=content.length;var segment=content.substring(currentIndex+1,nextIndex);this.positions={start:currentIndex,end:nextIndex};var spaceIndex=segment.indexOf(' ');if(spaceIndex>0){if(currentIndex+spaceIndex<start){this.endSuggest();return;}else{this.positions.end=spaceIndex;segment=segment.substring(0,spaceIndex);}}
if(segment==''){this.endSuggest();return;}
this.doSuggest(segment);}).delay(5,this);},doSuggest:function(text){this.currentText=text;var suggest=this.getSuggest();var input=this.getHiddenInput();input.set('value',text);input.value=text;suggest.prefetch();},endSuggest:function(){this.currentText='';this.positions={};if(this.suggest){this.getSuggest().destroy();delete this.suggest;}},getHiddenInput:function(){if(!this.hiddenInput){this.hiddenInput=new Element('input',{'type':'text','styles':{'display':'none'}}).inject(document.body);}
return this.hiddenInput;},getSuggest:function(){if(!this.suggest){var width=this.getComposer().elements.body.getSize().x;this.choices=new Element('div',{'styles':{'position':'absolute','background-color':'#fff','border':'1px solid #aaa','width':width+'px'}}).inject(this.getComposer().elements.body,'after');var self=this;var options=$merge(this.options.suggestOptions,{'customChoices':this.choices,'injectChoice':function(token){var choice=new Element('li',{'class':'autocompleter-choices','html':token.photo||'','id':token.guid});new Element('div',{'html':this.markQueryValue(token.label),'class':'autocompleter-choice'}).inject(choice);new Element('input',{'type':'hidden','value':JSON.encode(token)}).inject(choice);this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},'onChoiceSelect':function(choice){var data=JSON.decode(choice.getElement('input').value);var replaceString='@'+self.currentText;var newString='<a href="'+data.url+'">'+data.label+'</a>&nbsp;';var content=self.getComposer().getContent();content=content.replace(replaceString,newString);self.getComposer().setContent(content);},'emptyChoices':function(){this.fireEvent('onHide',[this.element,this.choices]);},'onCommand':function(e){switch(e.key){case'enter':break;}}});if(this.options.suggestProto=='local'){this.suggest=new Autocompleter.Local(this.getHiddenInput(),this.options.suggestParam,options);}else if(this.options.suggestProto=='request.json'){this.suggest=new Autocompleter.Request.JSON(this.getHiddenInput(),this.options.suggestParam,options);}}
return this.suggest;}});})();;(function(){var $='id'in document?document.id:window.$;Composer.Plugin.Video=new Class({Extends:Composer.Plugin.Interface,name:'video',options:{title:'Add Video',lang:{},requestOptions:{},imageMaxAspect:(10/3),imageMinAspect:(3/10),imageMinSize:48,imageMaxSize:5000,imageMinPixels:2304,imageMaxPixels:1000000,imageTimeout:5000,monitorDelay:250},initialize:function(options){this.elements=new Hash(this.elements);this.params=new Hash(this.params);this.parent(options);},attach:function(){this.parent();this.makeActivator();return this;},detach:function(){this.parent();return this;},activate:function(){if(this.active)return;this.parent();this.makeMenu();this.makeBody();this.elements.formInput=new Element('select',{'id':'compose-video-form-type','class':'compose-form-input','option':'test','events':{'change':this.updateVideoFields.bind(this)}}).inject(this.elements.body);var options=0;$('compose-video-form-type').options[options++]=new Option(this._lang('Choose Source'),'0');if(this.options.youtubeEnabled==1){$('compose-video-form-type').options[options++]=new Option(this._lang('YouTube'),'1');}
$('compose-video-form-type').options[options++]=new Option(this._lang('Vimeo'),'2');this.elements.formInput=new Element('input',{'id':'compose-video-form-input','class':'compose-form-input','type':'text','style':'display:none;'}).inject(this.elements.body);if(DetectMobileQuick()||DetectIpad()){if(this.options.allowed==1&&this.options.type!='message'){$('compose-video-form-type').options[options++]=new Option(this._lang('My Device'),'3');}
this.elements.previewDescription=new Element('div',{'id':'compose-video-upload','class':'compose-video-upload','html':this._lang('To upload a video from your device, please use our full uploader.'),'style':'display:none;'}).inject(this.elements.body);}
else{if(this.options.allowed==1&&this.options.type!='message'){$('compose-video-form-type').options[options++]=new Option(this._lang('My Computer'),'3');}
this.elements.previewDescription=new Element('div',{'id':'compose-video-upload','class':'compose-video-upload','html':this._lang('To upload a video from your computer, please use our full uploader.'),'style':'display:none;'}).inject(this.elements.body);}
this.elements.formSubmit=new Element('button',{'id':'compose-video-form-submit','class':'compose-form-submit','style':'display:none;','html':this._lang('Attach'),'events':{'click':function(e){e.stop();this.doAttach();}.bind(this)}}).inject(this.elements.body);this.elements.formInput.focus();},deactivate:function(){if(this.params.video_id)
new Request.JSON({url:en4.core.basePath+'video/index/delete',data:{format:'json',video_id:this.params.video_id}}).send();if(!this.active)return;this.parent();},doAttach:function(e){var val=this.elements.formInput.value;if(!val)
{return;}
if(!val.match(/^[a-zA-Z]{1,5}:\/\//))
{val='http://'+val;}
this.params.set('uri',val)
if(val==''){e.stop();return;}
var video_element=document.getElementById("compose-video-form-type");var type=video_element.value;var options=$merge({'data':{'format':'json','uri':val,'type':type},'onComplete':this.doProcessResponse.bind(this)},this.options.requestOptions);this.makeLoading('empty');this.request=new Request.JSON(options);this.request.send();},doProcessResponse:function(responseJSON,responseText){if(($type(responseJSON)!='hash'&&$type(responseJSON)!='object')||$type(responseJSON.src)!='string'||$type(parseInt(responseJSON.video_id))!='number'){if(this.elements.loading)this.elements.loading.destroy();this.makeError(responseJSON.message);this.elements.ignoreValidation=new Element('a',{'href':this.params.uri,'html':this.params.title,'events':{'click':function(e){e.stop();self.doAttach(this);}}}).inject(this.elements.previewTitle);return;}
var title=responseJSON.title||this.params.get('uri').replace('http://','');this.params.set('title',responseJSON.title);this.params.set('description',responseJSON.description);this.params.set('photo_id',responseJSON.photo_id);this.params.set('video_id',responseJSON.video_id);this.elements.preview=Asset.image(responseJSON.src,{'id':'compose-video-preview-image','class':'compose-preview-image','onload':this.doImageLoaded.bind(this)});},doImageLoaded:function(){var self=this;if(this.elements.loading)this.elements.loading.destroy();this.elements.preview.erase('width');this.elements.preview.erase('height');this.elements.preview.inject(this.elements.body);this.elements.previewInfo=new Element('div',{'id':'compose-video-preview-info','class':'compose-preview-info'}).inject(this.elements.body);this.elements.previewTitle=new Element('div',{'id':'compose-video-preview-title','class':'compose-preview-title'}).inject(this.elements.previewInfo);this.elements.previewTitleLink=new Element('a',{'href':this.params.uri,'html':this.params.title,'events':{'click':function(e){e.stop();self.handleEditTitle(this);}}}).inject(this.elements.previewTitle);this.elements.previewDescription=new Element('div',{'id':'compose-video-preview-description','class':'compose-preview-description','html':this.params.description,'events':{'click':function(e){e.stop();self.handleEditDescription(this);}}}).inject(this.elements.previewInfo);this.makeFormInputs();},makeFormInputs:function(){this.ready();this.parent({'photo_id':this.params.photo_id,'video_id':this.params.video_id,'title':this.params.title,'description':this.params.description});},updateVideoFields:function(element){var video_element=document.getElementById("compose-video-form-type");var url_element=document.getElementById("compose-video-form-input");var post_element=document.getElementById("compose-video-form-submit");var upload_element=document.getElementById("compose-video-upload");$('compose-video-form-input').value="";if(video_element.value==0)
{upload_element.style.display="none";post_element.style.display="none";url_element.style.display="none";}
if(video_element.value==1||video_element.value==2)
{upload_element.style.display="none";post_element.style.display="block";url_element.style.display="block";url_element.focus();}
if(video_element.value==3)
{upload_element.style.display="block";post_element.style.display="none";url_element.style.display="none";}},handleEditTitle:function(element){element.setStyle('display','none');var input=new Element('input',{'type':'text','value':htmlspecialchars_decode(element.get('html').trim()),'events':{'blur':function(){if(input.value.trim()!=''){this.params.title=input.value;element.set('html',this.params.title);this.setFormInputValue('title',this.params.title);}
element.setStyle('display','');input.destroy();}.bind(this)}}).inject(element,'after');input.focus();},handleEditDescription:function(element){element.setStyle('display','none');var input=new Element('textarea',{'html':htmlspecialchars_decode(element.get('html').trim()),'events':{'blur':function(){if(input.value.trim()!=''){this.params.description=input.value;element.set('html',this.params.description);this.setFormInputValue('description',this.params.description);}
else{this.params.description='';element.set('html','');this.setFormInputValue('description','');}
element.setStyle('display','');input.destroy();}.bind(this)}}).inject(element,'after');input.focus();}});})();