var Lasso=new Class({Implements:[Options,Events],active:false,options:{autoHide:true,cropMode:false,globalTrigger:false,min:false,max:false,ratio:false,contain:false,trigger:null,border:'#999',color:'#7389AE',opacity:.3,zindex:10000,bgimage:'./blank.gif'},binds:{},initialize:function(options){this.setOptions(options);this.box=new Element('div',{'styles':{'display':'none','position':'absolute','z-index':this.options.zindex}}).inject((this.container)?this.container:document.body);this.overlay=new Element('div',{'class':'lasso-overlay','styles':{'position':'relative','background':'url('+this.options.bgimage+')','height':'100%','width':'100%','z-index':this.options.zindex+1}}).inject(this.box);this.mask=new Element('div',{'styles':{'position':'absolute','background-color':this.options.color,'opacity':this.options.opacity,'height':'100%','width':'100%','z-index':this.options.zindex-1}});if(this.options.cropMode){this.mask.setStyle('z-index',this.options.zindex-2).inject(this.container);this.options.trigger=this.mask;}else{this.mask.inject(this.overlay);}
this.trigger=$(this.options.trigger);var antStyles={'position':'absolute','width':1,'height':1,'overflow':'hidden','z-index':this.options.zindex+1};if(this.options.border.test(/\.(jpe?g|gif|png)/))antStyles.backgroundImage='url('+this.options.border+')';else var antBorder='1px dashed '+this.options.border;this.marchingAnts={};['left','right','top','bottom'].each(function(side,idx){switch(side){case'left':style=$merge(antStyles,{top:0,left:-1,height:'100%'});break;case'right':style=$merge(antStyles,{top:0,right:-1,height:'100%'});break;case'top':style=$merge(antStyles,{top:-1,left:0,width:'100%'});break;case'bottom':style=$merge(antStyles,{bottom:-1,left:0,width:'100%'});break;}
if(antBorder)style['border-'+side]=antBorder;this.marchingAnts[side]=new Element('div',{'styles':style}).inject(this.overlay);},this);this.binds.start=this.start.bindWithEvent(this);this.binds.move=this.move.bindWithEvent(this);this.binds.end=this.end.bindWithEvent(this);this.attach();document.body.onselectstart=function(e){e=new Event(e).stop();return false;};this.removeDOMSelection=(document.selection&&document.selection.empty)?function(){document.selection.empty();}:(window.getSelection)?function(){var s=window.getSelection();if(s&&s.removeAllRanges)s.removeAllRanges();}:$lambda(false);this.resetCoords();},attach:function(){this.trigger.addEvent('mousedown',this.binds.start);},detach:function(){if(this.active)this.end();this.trigger.removeEvent('mousedown',this.binds.start);},start:function(event){if((!this.options.autoHide&&event.target==this.box)||(!this.options.globalTrigger&&(this.trigger!=event.target)))return false;this.active=true;document.addEvents({'mousemove':this.binds.move,'mouseup':this.binds.end});this.resetCoords();if(this.options.contain)this.getContainCoords();if(this.container)this.getRelativeOffset();this.setStartCoords(event.page);this.fireEvent('start');return true;},move:function(event){if(!this.active)return false;this.removeDOMSelection();var s=this.coords.start,m=event.page,box=this.coords.box={},c=this.coords.container;if(this.container){m.y-=this.offset.top;m.x-=this.offset.left;}
var f=this.flip={y:(s.y>m.y),x:(s.x>m.x)};box.y=(f.y)?[m.y,s.y]:[s.y,m.y];box.x=(f.x)?[m.x,s.x]:[s.x,m.x];if(this.options.contain){if(box.y[0]<c.y[0])box.y[0]=c.y[0];if(box.y[1]>c.y[1])box.y[1]=c.y[1];if(box.x[0]<c.x[0])box.x[0]=c.x[0];if(box.x[1]>c.x[1])box.x[1]=c.x[1];}
if(this.options.max){if(box.x[1]-box.x[0]>this.options.max[0]){if(f.x)box.x[0]=box.x[1]-this.options.max[0];else box.x[1]=box.x[0]+this.options.max[0];}
if(box.y[1]-box.y[0]>this.options.max[1]){if(f.y)box.y[0]=box.y[1]-this.options.max[1];else box.y[1]=box.y[0]+this.options.max[1];}}
if(this.options.ratio){var ratio=this.options.ratio;var r={x:(box.x[1]-box.x[0])/ratio[0],y:(box.y[1]-box.y[0])/ratio[1]};if(r.x>r.y){if(f.x)box.x[0]=box.x[1]-(r.y*ratio[0]);else box.x[1]=box.x[0]+(r.y*ratio[0]);}else if(r.x<r.y){if(f.y)box.y[0]=box.y[1]-(r.x*ratio[1]);else box.y[1]=box.y[0]+(r.x*ratio[1]);}}
this.refresh();return true;},refresh:function(){var c=this.coords,box=this.coords.box,cc=this.coords.container;c.w=box.x[1]-box.x[0];c.h=box.y[1]-box.y[0];c.top=box.y[0];c.left=box.x[0];this.box.setStyles({'display':'block','top':c.top,'left':c.left,'width':c.w,'height':c.h});this.fireEvent('resize',this.getRelativeCoords());},end:function(event){if(!this.active)return false;this.active=false;document.removeEvents({'mousemove':this.binds.move,'mouseup':this.binds.end});if(this.options.autoHide)this.resetCoords();else if(this.options.min){if(this.coords.w<this.options.min[0]||this.coords.h<this.options.min[1])this.resetCoords();}
var ret=(this.options.autoHide)?null:this.getRelativeCoords();this.fireEvent('complete',ret);return true;},setStartCoords:function(coords){if(this.container){coords.y-=this.offset.top;coords.x-=this.offset.left;}
this.coords.start=coords;this.coords.w=0;this.coords.h=0;this.box.setStyles({'display':'block','top':this.coords.start.y,'left':this.coords.start.x});},resetCoords:function(){this.coords={start:{x:0,y:0},move:{x:0,y:0},end:{x:0,y:0},w:0,h:0};this.box.setStyles({'display':'none','top':0,'left':0,'width':0,'height':0});this.getContainCoords();},getRelativeCoords:function(){var box=this.coords.box,cc=$merge(this.coords.container),c=this.coords;if(!this.options.contain)cc={x:[0,0],y:[0,0]};return{x:(box.x[0]-cc.x[0]).toInt(),y:(box.y[0]-cc.y[0]).toInt(),w:(c.w).toInt(),h:(c.h).toInt()};},getContainCoords:function(){var tc=this.trigger.getCoordinates(this.container);this.coords.container={y:[tc.top,tc.top+tc.height],x:[tc.left,tc.left+tc.width]};},getRelativeOffset:function(){this.offset=this.container.getCoordinates();},reset:function(){this.detach();},destroy:function(){this.detach();this.mask.destroy();this.overlay.destroy();this.box.destroy();}});;Lasso.Crop=new Class({Extends:Lasso,options:{autoHide:false,cropMode:true,contain:true,handleSize:8,preset:false,handleStyle:{'border':'1px solid #000','background-color':'#ccc',opacity:.75},handlePreventsDefault:true},initialize:function(img,options){this.img=$(img);if(this.img.get('tag')!='img')return false;var coords=this.img.getCoordinates();var widthFix=coords.width-2;var heightFix=coords.height-2;this.container=new Element('div',{'id':'lassoMask','styles':{'position':'relative','width':widthFix,'height':heightFix,'background':'url('+this.img.get('src')+') no-repeat'}}).inject(this.img,'after');this.img.setStyle('display','none');options.p=this.container;this.crop=new Element('span',{styles:{'position':'absolute','top':0,'left':0,'width':coords.width,'height':coords.height,'padding':0,'margin':0,'z-index':this.options.zindex-1,'background-image':'url('+this.img.get('src')+')'}}).inject(this.container);this.parent(options);this.binds.handleMove=this.handleMove.bind(this);this.binds.handleEnd=this.handleEnd.bind(this);this.binds.handles={};this.handles={};this.handlesGrid={'NW':[0,0],'N':[0,1],'NE':[0,2],'W':[1,0],'E':[1,2],'SW':[2,0],'S':[2,1],'SE':[2,2]};['NW','N','NE','W','E','SW','S','SE'].each(function(handle){var grid=this.handlesGrid[handle];this.binds.handles[handle]=this.handleStart.bindWithEvent(this,[handle,grid[0],grid[1]]);this.handles[handle]=new Element("div",{'styles':$merge({'position':'absolute','display':'block','visibility':'hidden','width':this.options.handleSize,'height':this.options.handleSize,'overflow':'hidden','cursor':(handle.toLowerCase()+'-resize'),'z-index':this.options.zindex+2},this.options.handleStyle),'events':{'mousedown':this.binds.handles[handle]}}).inject(this.box,'bottom');this.handles[handle].style.visibility='hidden';},this);this.binds.drag=this.handleStart.bindWithEvent(this,['DRAG',1,1]);this.overlay.addEvent('mousedown',this.binds.drag);this.setDefault();},setDefault:function(){if(!this.options.preset)return this.resetCoords();this.getContainCoords();this.getRelativeOffset();var c=this.coords.container,d=this.options.preset;this.coords.start={x:d[0],y:d[1]};this.active=true;this.move({page:{x:d[2]+this.offset.left,y:d[3]+this.offset.top}});this.active=false;},handleStart:function(event,handle,row,col){this.currentHandle={'handle':handle,'row':row,'col':col};document.addEvents({'mousemove':this.binds.handleMove,'mouseup':this.binds.handleEnd});event.page.y-=this.offset.top;event.page.x-=this.offset.left;this.coords.hs={'s':event.page,'b':$merge(this.coords.box)};this.active=true;if(this.options.handlePreventsDefault){event.stop();}},handleMove:function(event){var box=this.coords.box,c=this.coords.container,m=event.page,cur=this.currentHandle,s=this.coords.start;m.y-=this.offset.top;m.x-=this.offset.left;if(cur.handle=='DRAG'){var hs=this.coords.hs,xm=m.x-hs.s.x,ym=m.y-hs.s.y,diff;box.y[0]=hs.b.y[0]+ym;box.y[1]=hs.b.y[1]+ym;box.x[0]=hs.b.x[0]+xm;box.x[1]=hs.b.x[1]+xm;if((diff=box.y[0]-c.y[0])<0){box.y[0]-=diff;box.y[1]-=diff;}
if((diff=box.y[1]-c.y[1])>0){box.y[0]-=diff;box.y[1]-=diff;}
if((diff=box.x[0]-c.x[0])<0){box.x[0]-=diff;box.x[1]-=diff;}
if((diff=box.x[1]-c.x[1])>0){box.x[0]-=diff;box.x[1]-=diff;}
return this.refresh();}
if(cur.row==0&&box.y[1]<m.y){cur.row=2;}
if(cur.row==2&&box.y[0]>m.y){cur.row=0;}
if(cur.col==0&&box.x[1]<m.x){cur.col=2;}
if(cur.col==2&&box.x[0]>m.x){cur.col=0;}
if(cur.row==0||cur.row==2){s.y=(cur.row)?box.y[0]:box.y[1];if(cur.col==0){s.x=box.x[1];}
if(cur.col==1){s.x=box.x[0];m.x=box.x[1];}
if(cur.col==2){s.x=box.x[0];}}
if(!this.options.ratio){if(cur.row==1){if(cur.col==0){s.y=box.y[0];m.y=box.y[1];s.x=box.x[1];}
else if(cur.col==2){s.y=box.y[0];m.y=box.y[1];s.x=box.x[0];}}}
m.y+=this.offset.top;m.x+=this.offset.left;this.move(event);if(this.options.handlePreventsDefault){event.stop();}},handleEnd:function(event){document.removeEvents({'mousemove':this.binds.handleMove,'mouseup':this.binds.handleEnd});this.active=false;this.currentHandle=false;if(this.options.min&&(this.coords.w<this.options.min[0]||this.coords.h<this.options.min[1])){if(this.options.preset)this.setDefault();else this.resetCoords();}
if(this.options.handlePreventsDefault){event.stop();}},end:function(event){if(!this.parent(event))return false;if(this.options.min&&(this.coords.w<this.options.min[0]||this.coords.h<this.options.min[1])){this.setDefault();}},resetCoords:function(){this.parent();this.coords.box={x:[0,0],y:[0,0]};this.hideHandlers();this.crop.setStyle('clip','rect(0px 0px 0px 0px)');},showHandlers:function(){var box=this.coords.box;if(this.options.min&&(this.coords.w<this.options.min[0]||this.coords.h<this.options.min[1]))this.hideHandlers();else{var tops=[],lefts=[],pxdiff=(this.options.handleSize/2)+1;for(var cell=0,cells=2;cell<=cells;cell++){tops[cell]=((cell==0)?0:((cell==2)?box.y[1]-box.y[0]:(box.y[1]-box.y[0])/2))-pxdiff;lefts[cell]=((cell==0)?0:((cell==2)?box.x[1]-box.x[0]:(box.x[1]-box.x[0])/2))-pxdiff;}
for(var handleID in this.handlesGrid){var grid=this.handlesGrid[handleID],handle=this.handles[handleID];if(!this.options.ratio||(grid[0]!=1&&grid[1]!=1)){if(this.options.min&&this.options.max){if((this.options.min[0]==this.options.max[0])&&(grid[1]%2)==0)continue;if(this.options.min[1]==this.options.max[1]&&(grid[0]%2)==0)continue;}
handle.setStyles({'visibility':'visible','top':tops[grid[0]],'left':lefts[grid[1]]});}}}},hideHandlers:function(){for(handle in this.handles){this.handles[handle].setStyle('visibility','hidden');}},refresh:function(){this.parent();var box=this.coords.box,cc=this.coords.container;if(Browser.Engine.trident&&Browser.Engine.version<5&&this.currentHandle&&this.currentHandle.col===1)
this.overlay.setStyle('width','100.1%').setStyle('width','100%');this.crop.setStyle('clip','rect('+(box.y[0])+'px '+(box.x[1])+'px '+(box.y[1])+'px '+(box.x[0])+'px )');this.showHandlers();},destroy:function(){this.parent();this.img.inject(this.container,'after');this.img.setStyle('display','');this.container.destroy();}});;var Tagger=new Class({Implements:[Events,Options],options:{'title':false,'description':false,'transImage':'application/modules/Core/externals/images/trans.gif','existingTags':[],'tagListElement':false,'linkElement':false,'noTextTagHref':true,'guid':false,'enableCreate':false,'enableDelete':false,'createRequestOptions':{'url':'','data':{'format':'json'}},'deleteRequestOptions':{'url':'','data':{'format':'json'}},'cropOptions':{'preset':[10,10,58,58],'min':[48,48],'max':[128,128],'handleSize':8,'opacity':.6,'color':'#7389AE','border':'externals/moolasso/crop.gif'},'suggestProto':'local','suggestParam':[],'suggestOptions':{'minLength':0,'maxChoices':100,'delay':250,'selectMode':'pick','multiple':false,'className':'message-autosuggest','filterSubset':true,'tokenFormat':'object','tokenValueKey':'label','injectChoice':$empty,'onPush':$empty,'prefetchOnInit':true,'alwaysOpen':true,'ignoreKeys':true}},initialize:function(el,options){el=$(el);if(el.get('tag')!='img'){this.image=el.getElement('img');}else{this.image=el;}
this.element=el;this.count=0;this.setOptions(options);this.options.existingTags.each(this.addTag.bind(this));},begin:function(){if(!this.options.enableCreate)return;this.getCrop();this.getForm();this.getSuggest();this.fireEvent('onBegin');},end:function(){if(this.crop){this.crop.destroy();delete this.crop;}
if(this.form){this.form.destroy();delete this.form;}
if(this.suggest){delete this.suggest;}
this.fireEvent('onEnd');},getCrop:function(){if(!this.crop){var options=$merge(this.options.cropOptions,{});this.crop=new Lasso.Crop(this.image,options);this.crop.addEvent('resize',this.onMove.bind(this));this.crop.refresh();}
return this.crop;},getForm:function(){if(!this.form){this.form=new Element('div',{'id':'tagger_form','class':'tagger_form','styles':{'position':'absolute','z-index':'100000','width':'150px'}}).inject(this.element,'after');if(this.options.title){new Element('div',{'class':'media_photo_tagform_titlebar','html':this.options.title}).inject(this.form);}
this.formContainer=new Element('div',{'class':'media_photo_tagform_container'}).inject(this.form);if(this.options.description){new Element('div',{'class':'media_photo_tagform_text','html':this.options.description}).inject(this.formContainer);}
this.input=new Element('input',{'id':'tagger_input','class':'tagger_input','type':'text','styles':{}}).inject(this.formContainer);this.choices=new Element('div',{'class':'tagger_list'}).inject(this.formContainer);var submitContainer=new Element('div',{'class':'media_photo_tagform_submits'}).inject(this.formContainer);var self=this;new Element('a',{'id':'tag_save','href':'javascript:void(0);','html':en4.core.language.translate('Save'),'events':{'click':function(){var data={};data.label=self.input.value;if($type(data.label)&&data.label!=''){data.extra=self.coords;self.createTag(data);}}}}).inject(submitContainer);new Element('a',{'id':'tag_cancel','href':'javascript:void(0);','html':en4.core.language.translate('Cancel'),'events':{'click':function(){this.end();}.bind(this)}}).inject(submitContainer);this.input.focus();}
return this.form;},getSuggest:function(){if(!this.suggest){var self=this;var options=$merge(this.options.suggestOptions,{'overflow':true,'maxChoices':4,'customChoices':this.choices,'injectChoice':function(token){var choice=new Element('li',{'class':'autocompleter-choices','html':token.photo||'','id':token.guid});new Element('div',{'html':this.markQueryValue(token.label),'class':'autocompleter-choice'}).inject(choice);new Element('input',{'type':'hidden','value':JSON.encode(token)}).inject(choice);this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},'onChoiceSelect':function(choice){var data=JSON.decode(choice.getElement('input').value);data.extra=self.coords;self.createTag(data);},'emptyChoices':function(){this.fireEvent('onHide',[this.element,this.choices]);},'onCommand':function(e){switch(e.key){case'enter':self.createTag({label:self.input.value,extra:self.coords});break;}}});if(this.options.suggestProto=='local'){this.suggest=new Autocompleter.Local(this.input,this.options.suggestParam,options);}else if(this.options.suggestProto=='request.json'){this.suggest=new Autocompleter.Request.JSON(this.input,this.options.suggestParam,options);}}
return this.suggest;},getTagList:function(){if(!this.tagList){if(!this.options.tagListElement){this.tagList=new Element('div',{'class':'tag_list'}).inject(this.element,'after');}else{this.tagList=$(this.options.tagListElement);}}
return this.tagList;},onMove:function(coords){this.coords=coords;var pos={x:0,y:0};var form=this.getForm();form.setStyles({'top':pos.y+coords.y+20,'left':pos.x+coords.x+coords.w+20});},addTag:function(params){if('object'!=$type(params)){return;}
var baseX=0,baseY=0,baseW=0,baseH=0;["x","y","w","h"].each(function(key){params.extra[key]=parseInt(params.extra[key]);});if(this.options.noTextTagHref&&params.tag_type=='core_tag'){delete params.href;}
var tag=new Element('div',{'id':'tag_'+params.id,'class':'tag_div','html':'<img src="'+this.options.transImage+'" width="100%" height="100%" />','styles':{'position':'absolute','width':params.extra.w,'height':params.extra.h,'top':baseY+params.extra.y,'left':baseX+params.extra.x},'events':{'mouseover':function(){this.showTag(params.id);}.bind(this),'mouseout':function(){this.hideTag(params.id);}.bind(this)}}).inject(this.element,'after');var label=new Element("span",{'id':'tag_label_'+params.id,'class':'tag_label','html':params.text,'styles':{'position':'absolute'}}).inject(this.element,'after');var labelPos={};labelPos.top=(baseY+params.extra.y+tag.getSize().y);labelPos.left=Math.round((baseX+params.extra.x)+(tag.getSize().x/2)-(label.getSize().x/2));if(this.element.getSize().y<labelPos.top.toInt()+20){labelPos.top=baseY+params.extra.y-label.getSize().y;}
label.setStyles(labelPos);this.hideTag(params.id);var isFirst=(!$type(this.count)||this.count==0);this.getTagList().setStyle('display','');if(!isFirst)new Element('span',{'id':'tag_comma_'+params.id,'class':'tag_comma','html':','}).inject(this.getTagList());var info=new Element('span',{'id':'tag_info_'+params.id,'class':'tag_info media_tag_listcontainer'}).inject(this.getTagList());var activator=new Element('a',{'id':'tag_activator_'+params.id,'class':'tag_activator','href':params.href||null,'html':params.text,'events':{'mouseover':function(){this.showTag(params.id);}.bind(this),'mouseout':function(){this.hideTag(params.id);}.bind(this)}}).inject(info);if(this.checkCanRemove(params.id))
{info.appendText(' (');var destroyer=new Element('a',{'id':'tag_destroyer_'+params.id,'class':'tag_destroyer albums_tag_delete','href':'javascript:void(0);','html':en4.core.language.translate('delete'),'events':{'click':function(){this.removeTag(params.id);}.bind(this)}}).inject(info);info.appendText(')');}
this.count++;},createTag:function(params){if(!this.options.enableCreate)return;var requestOptions=$merge(this.options.createRequestOptions,{'data':$merge(params,{}),'onComplete':function(responseJSON){this.addTag(responseJSON);}.bind(this)});var request=new Request.JSON(requestOptions);request.send();this.end();},removeTag:function(id){if(!this.checkCanRemove(id))return;var next=$('tag_info_'+id).getNext();if(next&&next.get('html').trim()==',')next.destroy();$('tag_'+id).destroy();$('tag_label_'+id).destroy();$('tag_info_'+id).destroy();this.count--;var requestOptions=$merge(this.options.deleteRequestOptions,{'data':{'tagmap_id':id},'onComplete':function(responseJSON){}.bind(this)});var request=new Request.JSON(requestOptions);request.send();},checkCanRemove:function(id){var tagData;this.options.existingTags.each(function(datum){if(datum.tagmap_id==id){tagData=datum;}});if(this.options.enableDelete)return true;if(tagData){if(tagData.tag_type+'_'+tagData.tag_id==this.options.guid)return true;if(tagData.tagger_type+'_'+tagData.tagger_id==this.options.guid)return true;}
return false;},showTag:function(id){$('tag_'+id).removeClass('tag_div_hidden');$('tag_label_'+id).removeClass('tag_label_hidden');},hideTag:function(id){$('tag_'+id).addClass('tag_div_hidden');$('tag_label_'+id).addClass('tag_label_hidden');}});;function he_show_message(message,type,delay){var text='';var duration=400;var delay=(delay==undefined)?3000:delay;text=message;if(window.$message_container==undefined){window.$message_container=new Element('div',{'class':'he_message_container'});$(document.body).adopt(window.$message_container);}
var className='he_msg_text';if(type=='error'){className='he_msg_error';}else if(type=='notice'){className='he_msg_notice';}else{className='he_msg_text';}
var $message=new Element('div',{'class':className,'styles':{'opacity':0}});var $close_btn=new Element('a',{'class':'he_close','href':'javascript://','events':{'click':function(){$message.fade('out');$message.removeClass('visible');window.setTimeout(function(){$message.dispose();if(window.$message_container.getElements('.visible').length==0){window.$message_container.empty();};},duration);}}});$message.addClass('visible');$message.adopt($close_btn);$message.adopt('html',new Element('span',{'html':message}));window.$message_container.adopt($message);$message.set('tween',{duration:duration});$message.fade('in');window.setTimeout(function(){$message.fade('out');$message.removeClass('visible');window.setTimeout(function(){if(window.$message_container.getElements('.visible').length==0){window.$message_container.empty();};},duration);},delay);}
function he_show_image(src,element)
{if(!src){return false;}
var $element=(element)?$(element):$('he_temp_photo_start');if(!$element){$element=new Element('div',{'id':'he_temp_photo_start'});$element.setStyles({'position':'fixed','top':'50%','left':'50%'});$$('body')[0].grab($element);}
var close_title=(typeof(en4.core.language.translate)=='undefined')?language.translate('close'):en4.core.language.translate('close');var instance=new Imagezoom({'image':src,'startElement':$element,'closeText':close_title});instance.show();}
function he_replace_form_error(msg)
{var $container=$$('.global_form .errors li');if($container.length!=1){return false;}
$container.set('html',msg);var $error_link=$container.getElement('a.smoothbox');if($error_link){Smoothbox.bind($error_link);}}
function he_add_lang_vars(data)
{if(!data){return;}
var obj_link=en4.core.language.options.lang;for(var key in data){obj_link[key]=data[key];}}
function object_to_query_string(object)
{var query="";for(key in object){query+='&params['+key+']='+object[key];}
return query;}
var HEContacts=new Class({Implements:[Events,Options],options:{m:'hecore',l:'',c:'',t:'',params:{},nli:0,keyword:'',p:1,ipp:30,total:0,contacts:[],itemClass:'item',filterField:'contacts_filter',filterSubmit:'contacts_filter_submit',container:'he_contacts_list',activeClass:'active',hiddenClass:'hidden',disabledClass:'disabled',visibleClass:'visible',listType:'all',contactsCountNode:'selected_contacts_count',submitButtonNode:'submit_contacts',selectAllNode:'select_all_contacs',moreNode:'contacts_more',listTypeAll:'he_contacts_list_all',listTypeSelected:'he_contacts_list_selected',format:'json'},url:'hecore/index/contacts',block:false,$filter:null,$container:null,$items:null,$selectedCount:null,$submit:null,$filterSubmit:null,$selectAll:null,$more:null,$listAll:null,$listSelected:null,needPagination:false,onLoad:false,onClose:false,width:550,height:390,initialize:function(options){this.setOptions(options);},box:function(){var self=this;var url=this.url+this.getQuery();var $element=new Element('a',{'href':url,'class':'smoothbox'});Smoothbox.open($element,{'mode':'Request',width:this.width,height:this.height,'onLoad':function(){self.init();if(self.onLoad){self.onLoad();self.onLoad=false;}},'onClose':function(){if(self.onClose){self.onClose();self.onClose=false;}}});},getQuery:function(){var query=object_to_query_string(this.options.params);return'?m='+this.options.m+'&l='+this.options.l+'&c='+this.options.c+'&t='+this.options.t+'&nli='+this.options.nli+query;},init:function(){this.$filter=$(this.options.filterField);this.$container=$(this.options.container);this.$selectedCount=$(this.options.contactsCountNode);this.$submit=$(this.options.submitButtonNode);this.$filterSubmit=$(this.options.filterSubmit);this.$selectAll=$(this.options.selectAllNode);this.$more=$(this.options.moreNode);this.$listAll=$(this.options.listTypeAll);this.$listSelected=$(this.options.listTypeSelected);this.$items=$$(this.$container.getElements('.'+this.options.itemClass));$('TB_ajaxContent').addClass('hecore_he_list_window');var self=this;if(this.$items.length>0){this.$items.removeEvents('click').addEvent('click',function(){this.blur();self.chooseContact(this);});}
if(this.$submit){this.$submit.removeEvents('click').addEvent('click',function(){self.submit();});}
if(this.$more){this.$more.removeEvents('click').addEvent('click',function(){self.more();});}
if(this.$listAll){this.$listAll.removeEvents('click').addEvent('click',function(){self.chooseList('all');});}
if(this.$listSelected){this.$listSelected.removeEvents('click').addEvent('click',function(){self.chooseList('selected');});}
if(this.$filterSubmit){this.$filterSubmit.removeEvents('click').addEvent('click',function(){self.search();});}
if(this.$selectAll){this.$selectAll.removeEvents('click').addEvent('click',function(){var value=this.checked?1:0;self.chooseAll(value);});}
if(this.$filter){this.$filter.removeEvents('keyup').addEvent('keyup',function(event){if(event.code==13){self.search();}});}},chooseList:function(type){this.options.listType=type;switch(type){case'all':this.$listSelected.removeClass(this.options.activeClass);this.$listAll.addClass(this.options.activeClass);this.$items.removeClass(this.options.hiddenClass);this.$items.setStyle('opacity',1);if(this.needPagination){this.$more.removeClass(this.options.hiddenClass);}
break;case'selected':this.$listSelected.addClass(this.options.activeClass);this.$listAll.removeClass(this.options.activeClass);this.$items.addClass(this.options.hiddenClass);if(this.$more){this.$more.addClass(this.options.hiddenClass);}
var $items=$$(this.$container.getElements('.'+this.options.activeClass));$items.removeClass(this.options.hiddenClass);break;}},chooseContact:function($node){$node=$($node);if(!$node){return;}
if($node.hasClass(this.options.disabledClass)){return;}
var contactId=parseInt($node.id.substr(8));if(this.options.contacts.indexOf(contactId)==-1){this.select($node,contactId);}else{this.deselect($node,contactId);}
var self=this;this.initCount();setTimeout(function(){self.no_result();},650);},select:function($node,contactId){$node=$($node);if(!$node){return;}
if($node.hasClass(this.options.disabledClass)){return;}
if(!contactId){contactId=parseInt($node.id.substr(8));}
$node=$($node);if(!$node.hasClass(this.options.activeClass)){$node.addClass(this.options.activeClass);}
if(this.options.contacts.indexOf(contactId)==-1){this.options.contacts.push(contactId);}
if(this.options.listType=='selected'){this.show($node,true);}},deselect:function($node,contactId){$node=$($node);if(!$node){return;}
if($node.hasClass(this.options.disabledClass)){return;}
if(!contactId){contactId=parseInt($node.id.substr(8));}
$node=$($node);if($node.hasClass(this.options.activeClass)){$node.removeClass(this.options.activeClass);}
if(this.options.contacts.indexOf(contactId)>-1){this.options.contacts.splice(this.options.contacts.indexOf(contactId),1);}
if(this.options.listType=='selected'){this.hide($node,true);}},initCount:function(){if(this.$selectedCount){this.$selectedCount.set('text',this.options.contacts.length)}},submit:function(){eval("window.parent."+this.options.c+"(["+this.options.contacts.toString()+"])");window.parent.Smoothbox.close();},chooseAll:function(choose){var self=this;if(choose){$$(this.$items).each(function($item){$item=$($item);if($item.hasClass(self.options.disabledClass)){return;}
self.select($item);});}else{$$(this.$items).each(function($item){$item=$($item);if($item.hasClass(self.options.disabledClass)){return;}
self.deselect($item);});}
this.initCount();},search:function(){this.options.keyword=this.$filter.value;this.options.p=1;if(this.options.listType!='all'){this.chooseList('all');}
this.getItems(true);},more:function(){this.options.p++;this.getItems();},getItems:function(replace){if(replace===undefined){replace=false;}
if(this.block){return false;}
this.block=true;var self=this;new Request.JSON({url:self.url,method:'post',data:self.options,onSuccess:function(response){self.block=false;self.respond(response,replace);}}).send();},respond:function(response,replace){if(replace===undefined){replace=false;}
if(replace){this.$container.set('html',response.html);}else{var html=this.$container.get('html')+response.html;this.$container.set('html',html);}
if(this.$more){this.needPagination=response.need_pagination;if(!this.needPagination){this.$more.addClass(this.options.hiddenClass);}else{this.$more.removeClass(this.options.hiddenClass);}}
this.init();},hide:function($node,fx){var self=this;$node=$($node);if(!$node){return;}
var func=function(){if(!$node.hasClass(self.options.hiddenClass)){$node.addClass(self.options.hiddenClass);}}
if(fx){setTimeout(func,650);$node.tween('opacity',[1,0]);}else{$node.setStyle('opacity',0);func();}},show:function($node,fx){var self=this;$node=$($node);if(!$node){return;}
var func=function(){if($node.hasClass(self.options.hiddenClass)){$node.removeClass(self.options.hiddenClass);}
if($node.hasClass(self.options.disabledClass)){$node.setStyle('opacity',.5);}}
$node.setStyle('visibility','visible');if(fx){setTimeout(func,650);if($node.hasClass(this.options.disabledClass)){$node.tween('opacity',[0,.5]);}else{$node.tween('opacity',[0,1]);}}else{$node.setStyle('opacity',1);func();}},no_result:function(){if($$('.visible').length==0){this.show($('no_result'));}else{this.hide($('no_result'));}}});var he_contacts={callback:'',contacts:[],title:'',list_type:'',keyword:'',params:{},onLoad:false,onClose:false,width:550,height:390,box:function(module,list,callback,title,params,not_logged_in){this.params=params;not_logged_in=not_logged_in===undefined?0:1;var options={c:callback,listType:"all",m:module,l:list,p:1,params:params,nli:not_logged_in};window.HE_CONTACTS=new HEContacts(options);if(this.onLoad){window.HE_CONTACTS.onLoad=this.onLoad;}
if(this.onClose){window.HE_CONTACTS.onClose=this.onClose;}
window.HE_CONTACTS.width=this.width;window.HE_CONTACTS.height=this.height;window.HE_CONTACTS.box();},init:function(){var self=this;if(!$('contacts_filter')){return;}
$('contacts_filter').addEvent('keyup',function(){self.keyword=this.value;self.search_contacts();});var contacts=[];for(var i=0;i<this.contacts.length;i++){contacts.push(parseInt(this.contacts[i]));}
this.contacts=contacts;},search_contacts:function(){var self=this;var selector="";if(this.list_type=='selected'){selector='#he_contacts_list .active';$$('#he_contacts_list .item').removeClass('visible');$$('#he_contacts_list .item').removeClass('hidden');$$('#he_contacts_list .item').addClass('hidden');$$('#he_contacts_list .active').addClass('visible');$$('#he_contacts_list .active').removeClass('hidden');}else{selector='#he_contacts_list .item';}
var $items=$$(selector);$items.each(function($item){if(!$item.getElement('span.name').get('html').test(self.keyword,'i')){self.hide($item);}else{self.show($item);}});self.no_result();},choose_contact:function(contact_id){if($("contact_"+contact_id).hasClass("disabled")){return;}
if(this.contacts.indexOf(contact_id)==-1){$("contact_"+contact_id).addClass("active");this.contacts[this.contacts.length]=contact_id;}
else{$("contact_"+contact_id).removeClass("active");this.contacts.splice(this.contacts.indexOf(contact_id),1);if(this.list_type=='selected'){this.hide($("contact_"+contact_id),true);}}
var self=this;if($('selected_contacts_count')!=undefined){$('selected_contacts_count').set('text',self.contacts.length)}
setTimeout(function(){self.no_result();},650);},choose_all_contacts:function($el){var $list_items=$('he_contacts_list').getChildren('a');for(var i in $list_items)
{if(typeof $list_items[i].getProperty=='function'){$id=parseInt($list_items[i].getProperty('id').substr(8));if($el.checked){if(this.contacts.indexOf($id)==-1){this.choose_contact($id);}
if($('checkbox_'+$id)!=undefined&&!$('checkbox_'+$id).checked){$('checkbox_'+$id).checked=true;}}
else
if(this.contacts.indexOf($id)!=-1){this.choose_contact($id);if($('checkbox_'+$id)!=undefined&&$('checkbox_'+$id).checked){$('checkbox_'+$id).checked=false;}}}}
if($('selected_contacts_count')!=undefined){$('selected_contacts_count').set('text',this.contacts.length)}},add_class:function($el,css_class,$el2){$el.addClass(css_class);$el2.removeClass(css_class);},no_result:function(){if($$('.visible').length==0){this.show($('no_result'));}else{this.hide($('no_result'));}},send:function(){eval("window.parent."+this.callback+"(["+this.contacts.toString()+"])");window.parent.Smoothbox.close();},hide:function($element,fx){var func=function(){if(!$element.hasClass('hidden')){$element.addClass('hidden');}
$element.removeClass('visible');}
if(fx){setTimeout(func,650);$element.tween('opacity',[1,0]);}else{$element.setStyle('visibility','hidden');$element.setStyle('opacity',0);func();}},show:function($element,fx){var func=function(){if(!$element.hasClass('visible')){$element.addClass('visible');}
$element.removeClass('hidden');if($element.hasClass('disabled')){$element.setStyle('opacity',.5);}}
if(fx){setTimeout(func,650);if($element.hasClass('disabled')){$element.tween('opacity',[0,.5]);}else{$element.tween('opacity',[0,1]);}}else{$element.setStyle('visibility','visible');$element.setStyle('opacity',1);func();}},showElements:function($elements){var self=this;$elements.each(function($element){self.show($element);});},hideElements:function($elements){var self=this;$elements.each(function($element){self.hide($element);});},select:function(type){var self=this;if(this.list_type==type){return;}
this.list_type=type;this.search_contacts();}}
function form_redirect_level(url,$formElement)
{$$($formElement.form.elements).each(function($el){$el.disabled=true;});window.location.href=url+'?level_id='+$formElement.value;}
var he_list={list_type:'',keyword:'',page:1,ajax_url:'',module:'',list:'',params:{},onLoad:false,onClose:false,width:550,height:390,box:function(module,list,title,params){this.params=params;var self=this;var not_logged_in=0;var query=object_to_query_string(params);var $el=new Element('a',{'href':'hecore/index/list?m='+module+'&l='+list+'&t='+title+'&nli='+not_logged_in+query,'class':'smoothbox'});Smoothbox.open($el,{'mode':'Request',width:this.width,height:this.height,'onLoad':function(){self.init();if(self.onLoad){self.onLoad();self.onLoad=false;}
if(self.onClose){self.onClose();self.onClose=false;}}});},init:function(){var self=this;$('TB_ajaxContent').addClass('hecore_he_list_window');$('list_filter_btn').addEvent('click',function(){self.page=1;self.get_items();});$('list_filter').addEvent('keydown',function(event){if(event.key=='enter'){self.page=1;self.get_items();}});},select:function(list_type){if(list_type==this.list_type){return;}
this.keyword='';this.page=1;this.list_type=list_type;this.get_items();},get_items:function(){var self=this;this.keyword=$('list_filter').value;$('he_list').innerHTML='';$('he_contacts_loading').setStyle('display','block');if(this.params.list_type){this.params.list_type=self.list_type;}
var query=object_to_query_string(this.params);new Request.JSON({'url':self.ajax_url+'?nocache='+Math.random()+query,'method':'post','data':{'format':'json','keyword':self.keyword,'list_type':self.list_type,'p':self.page,'m':self.module,'l':self.list},onSuccess:function(response){$('he_list').innerHTML=response.html;$('he_contacts_loading').setStyle('display','none');}}).send();},set_page:function(page){this.page=page;this.get_items();}}
function he_show_confirm(title,message,callback,options)
{if(window.$he_confirm_container==undefined){window.$he_confirm_container=new Element('div',{'class':'he_confirm_container'});var $link=window.$he_confirm_container;var $title=new Element('div',{'class':'he_confirm_title'});var $description=new Element('div',{'class':'he_confirm_desc'});if(typeof(en4.core.language.translate)=='undefined'){var confirm_label=language.translate('Confirm');var or_label=language.translate('or');var cancel_label=language.translate('Cancel');}else{var confirm_label=en4.core.language.translate('Confirm');var or_label=en4.core.language.translate('or');var cancel_label=en4.core.language.translate('Cancel');}
var $tools=new Element('div',{'class':'he_confirm_tools'});var $confirm_btn=new Element('button',{'class':'confirm_btn','html':confirm_label});var $or_text=new Element('span',{'class':'or_btn','html':or_label});var $cancel_btn=new Element('a',{'class':'cancel_btn','href':'javascript://','html':cancel_label});$tools.adopt($confirm_btn,$or_text,$cancel_btn);$link.adopt($title,$description,$tools);var $hidden_cont=new Element('div',{'class':'display_none'});$hidden_cont.adopt($link);$(document.body).adopt($hidden_cont);}
var $link=window.$he_confirm_container;if(title&&title.length>0){$link.getElement('.he_confirm_title').removeClass('display_none').set('html',title);}else{$link.getElement('.he_confirm_title').addClass('display_none');}
if(message&&message.length>0){$link.getElement('.he_confirm_desc').removeClass('display_none').set('html',message);}else{$link.getElement('.he_confirm_desc').addClass('display_none');}
if(options&&options.confirm_label!=undefined)
$link.getElement('.he_confirm_tools .confirm_btn').set('html',options.confirm_label);if(options&&options.cancel_label!=undefined)
$link.getElement('.he_confirm_tools .cancel_btn').set('html',options.cancel_label);if(options&&options.or_label!=undefined)
$link.getElement('.he_confirm_tools .or_btn').set('html',options.or_label);var width=(options&&options.width)?options.width:500;var height=(options&&options.height)?options.height:100;Smoothbox.open($link,{mode:'Inline',width:width,height:height});$('TB_ajaxContent').getElement('.he_confirm_tools .cancel_btn').addEvent('click',function(){Smoothbox.close();});if(callback&&typeof(callback)=='function'){$('TB_ajaxContent').getElement('.he_confirm_tools .confirm_btn').addEvent('click',function(){Smoothbox.close();callback();});}}
var he_friend={link:'settings_toggler',$link:null,form:'settings_form',$form:null,container:'he_friend_conatainer',$container:null,ipp:'friends_ipp',$ipp:null,loader:'he_friends_loader',$loader:null,privacy:'friends_privacy',$privacy:null,list:'friend_list',$list:null,url:{},init:function(){var self=this;this.$link=$(this.link);this.$form=$(this.form);this.$container=$(this.container);this.$ipp=$(this.ipp);this.$loader=$(this.loader);this.$privacy=$(this.privacy);this.$list=$(this.list);this.$link.addEvent('click',function(){self.toggle_settings();});this.$link.addEvent('focus',function(){this.blur();});this.$ipp.addEvent('change',function(){self.change_ipp(this.value);});this.$privacy.addEvent('change',function(){self.change_privacy(this.value);});this.$list.addEvent('click',function(){self.list_box();});},list_box:function(){he_contacts.box('hecore','getFriends','he_friend.save_friends',en4.core.language.translate('Choose Friends'),{'object':window.en4.core.subject.type,'object_id':window.en4.core.subject.id},0);},see_all:function(list_type){he_list.box('hecore','getMutualFriends',en4.core.language.translate('Friends'),{'object':window.en4.core.subject.type,'object_id':window.en4.core.subject.id,'list_type':list_type});},toggle_settings:function(){if(this.$link.getParent().hasClass('active')){this.$link.getParent().removeClass('active');}else{this.$link.getParent().addClass('active');}
if(this.$form.hasClass('hidden')){this.$form.removeClass('hidden');}else{this.$form.addClass('hidden');}},change_ipp:function(value){var self=this;var url=this.url.change_ipp;this.show_loader();new Request.JSON({'url':url+'?&rand='+Math.random(),'method':'post','data':{'format':'json','value':value},onSuccess:function(response){self.$container.set('html',response.html);self.hide_loader();}}).send();},change_privacy:function(value){var self=this;var url=this.url.change_privacy;this.$privacy.disabled=true;new Request.JSON({'url':url+'?&rand='+Math.random(),'method':'post','data':{'format':'json','value':value},onSuccess:function(response){self.$privacy.disabled=false;}}).send();},show_loader:function(){this.$loader.removeClass('hidden');this.$container.addClass('hidden');},hide_loader:function(){this.$loader.addClass('hidden');this.$container.removeClass('hidden');},save_friends:function(user_ids){var self=this;var url=this.url.save_list;this.show_loader();new Request.JSON({'url':url+'?&rand='+Math.random(),'method':'post','data':{'format':'json','value':user_ids},onSuccess:function(response){self.$container.set('html',response.html);self.hide_loader();}}).send();}}
var HETips=new Class({Implements:[Events,Options],options:{url:'',ajax:true,cache:true,delay:300,className:'he-tool-tip',id:'he-tool-tip-id',display:'top',htmlElement:'',visibleOnHover:true},elements:null,cache:{},tip:null,timeout:null,block:false,request:null,show:true,initialize:function(elements,options){try{if(Hetips&&!Hetips.isCustomTipsEnabled(elements,options)){return false;}}catch(e){}
this.elements=elements;this.setOptions(options);this.tip=this.getTipBlock();this.bind();},getTipBlock:function(){var self=this;if($(this.options.id)){return $(this.options.id);}
var $container=new Element('div',{'class':self.options.className+' hidden','id':self.options.id,'style':'position:absolute;'});var $header=new Element('div',{'class':'he-tip-title'});var $content=new Element('div',{'class':'he-tip'});var $footer=new Element('div',{'class':'he-tip-footer'});var $clr=new Element('div',{'class':'clr'});$container.appendChild($header);$container.appendChild($content);$container.appendChild($footer);$container.appendChild($clr);$$('body')[0].appendChild($container);return $container;},bind:function(){var self=this;$$(this.elements).each(function($item){self.bindItem($item);});},bindItem:function($item){var self=this;$item=$($item);$item.addEvents({'mouseover':function(){var id=this.id;var element=this;self.show=true;self.timeout=window.setTimeout(function(){self.hint(id,element);},self.options.delay);},'mouseout':function(){window.clearTimeout(self.timeout);self.show=false;self.timeout=window.setTimeout(function(){self.hideTip();},self.options.delay);}});},hint:function(id,element){var self=this;if(this.options.htmlElement){this.show=true;var html=$(element).getParent().getElement(this.options.htmlElement).innerHTML;this.showTip(html,element);this.block=false;return;}
if(this.cache[id]&&this.options.cache){this.show=true;this.showTip(this.cache[id],element);this.block=false;return;}
if(this.block&&this.options.ajax){return;}
this.block=true;self.showTip('',element);this.request=new Request.JSON({'method':'post','url':self.options.url+'?rand='+Math.random(),'data':{'id':id,'format':'json'},onSuccess:function(response){self.cache[id]=response.html;self.showTip(response.html,element);self.block=false;self.fireEvent('onRequestSuccess',[response,element]);}}).send();},getPos:function($element){var data=$($element).getPosition();return data;},showTip:function(html,element){if(html==''){html='<span class="loader_icon">&nbsp;</span>';this.tip.addClass('he_loader');}else{this.tip.removeClass('he_loader');}
this.tip=$(this.tip);element=$(element);var data=this.getPos(element);var x=data.x;var y=data.y;this.tip.getElements('.he-tip')[0].set('html',html);this.tip.style.left=x+'px';this.tip.style.top=y+'px';if(html!=''&&this.show){this.tip.removeClass('hidden');}
this.tip.style.top=(parseInt(this.tip.style.top)-$(this.tip).getSize().y)+'px';var self=this;this.tip.removeEvents('mouseover').removeEvents('mouseout').addEvents({'mouseover':function(){if(self.options.visibleOnHover){window.clearTimeout(self.timeout);}},'mouseout':function(){self.timeout=window.setTimeout(function(){self.hideTip();},self.options.delay);}});this.fireEvent('onShow',[this.tip,element]);},hideTip:function(){this.tip.addClass('hidden');this.fireEvent('onHide',[this.tip]);},getDocHeight:function(){var D=document;return Math.max(Math.max(D.body.scrollHeight,D.documentElement.scrollHeight),Math.max(D.body.offsetHeight,D.documentElement.offsetHeight),Math.max(D.body.clientHeight,D.documentElement.clientHeight));}});;function initImageZoom(_options,$object){var options=$extend({rel:'imagezoom'},_options||{});var elements=$$(document.links).filter(function(el){if((el.rel)&&(el.rel.indexOf(options.rel)!=-1))
return true;else
return false;});for(var i=0;i<elements.length;i++){var el=elements[i];el.addEvent("click",function(){this.blur();var sEl=this;var imgCap="";if(this.getElements("img").length>0)
sEl=this.getElements("img")[0];if((sEl.alt)&&(sEl.alt!=""))
imgCap=sEl.alt;else if(sEl.title)
imgCap=sEl.title;else if(sEl.parentNode.title)
imgCap=sEl.parentNode.title;var _options=$extend({image:this.href,caption:imgCap,startElement:sEl},options||{});_options.image=this.href;_options.caption=imgCap;var $object=new Imagezoom(_options);$object.preloadImage();$object.show();return false;});}}
var Imagezoom=function(_options){var options=$extend({image:false,caption:"",enableCaptions:true,startElement:false,x:10,y:10,initWidth:50,initHeight:50,draggable:true,loadImage:"application/modules/Hecore/externals/images/imagezoom/loading.gif",loadDelay:150,duration:800,closeDuration:500,transition:Fx.Transitions.Cubic.easeOut,startOpacity:0.6,closeText:'Close',rel:'imagezoom',showCaptionBar:true,overlay:false,overlayColor:"#000",overlayOpacity:.75},_options||{});var box=document.createElement("div");var instance=this;var tl=document.createElement("div");tl.className="s s_tl";var tr=document.createElement("div");tr.className="s s_tr";var bl=document.createElement("div");bl.className="s s_bl";var br=document.createElement("div");br.className="s s_br";var top=document.createElement("div");top.className="s s_top";var bottom=document.createElement("div");bottom.className="s s_bottom";var left=document.createElement("div");left.className="s s_left";var right=document.createElement("div");right.className="s s_right";this.preloadImage=function(){if(options.image!=false){var img=new Image();img.src=options.image;img.style.visibility="hidden";img.style.position="absolute";img.style.top="-9999999999px";img.setAttribute("id","imagezoom-"+options.image);$$('body')[0].appendChild(img);}}
this.getImage=function(){if(($('imagezoom-'+options.image))&&($('imagezoom-'+options.image).width!="0")){var img=$('imagezoom-'+options.image).clone();img.setAttribute("id","");img.style.position="relative";img.style.top="0px";img.style.visibility="visible";}else{instance.preloadImage();window.setTimeout(function(){instance.getImage();},50);}
return img;}
this.show=function(){if(options.image!=false){box.style.position="absolute";box.style.overflow="hidden";box.setAttribute("id","imagezoom-open-"+options.image);if(options.startElement!=false)
options.startElement.blur();var x=options.x;var y=options.y;var boxWidth=options.initWidth;var boxHeight=options.initHeight;if(options.startElement!=false){x=options.startElement.getPosition().x;y=options.startElement.getPosition().y;boxWidth=options.startElement.offsetWidth;boxHeight=options.startElement.offsetHeight;}
box.style.left=x+"px";box.style.top=y+"px";box.style.width=boxWidth+"px";box.style.height=boxHeight+"px";var fx=new Fx.Morph(box);fx.set({opacity:options.startOpacity});box.className="imagezoom";$$('body')[0].appendChild(box);box.style.cursor="pointer";box.addEvent("click",function(){var fx=new Fx.Morph(box,{duration:200});fx.start({opacity:0}).chain(function(){$$('body')[0].removeChild(box);});});this.loadImage();}}
this.loadImage=function(){if(box.getElements(".loading").length==0){var loading=new Image();loading.src=options.loadImage;loading.className="loading";box.appendChild(loading);}
if($('imagezoom-'+options.image)){var el=$('imagezoom-'+options.image);if(el.width!="0"){var newEl=new Image();newEl.src=options.image;window.setTimeout(function(){instance.insertImage(newEl)},options.loadDelay);}else{window.setTimeout(function(){instance.loadImage();},50);}}else{instance.preloadImage();window.setTimeout(function(){instance.loadImage();},50);}}
this.insertImage=function(img){box.removeEvents("click");box.style.cursor="default";box.style.overflow="visible";var w=img.width;var h=img.height;var maxSize=window.getSize();if(maxSize){var maxH=maxSize.y-40;if(h>maxH){w=w*maxH/h;h=maxH;}}
img.style.width=w+"px";img.style.height=h+"px";img.className='image';var ptop=(window.getSize().y/2)+window.getScroll().y-(h/2);var pleft=(window.getSize().x/2)+window.getScroll().x-(w/2);var fx=new Fx.Morph(box,{duration:options.duration,transition:options.transition});fx.start({top:ptop,left:pleft,width:w,height:h,opacity:1}).chain(function(){if(options.overlay==true){if(!$('imagezoom_overlay')){var overlay=$(document.createElement("div"));overlay.setAttribute("id","imagezoom_overlay");overlay.style.backgroundColor=options.overlayColor;overlay.setOpacity(0);$$('body')[0].appendChild(overlay);}else{var overlay=$('imagezoom_overlay');}
overlay.style.width=window.getScrollSize().x+"px";overlay.style.height=window.getScrollSize().y+"px";var overlayfx=new Fx.Morph(overlay,{duration:600});overlayfx.start({opacity:options.overlayOpacity});}
var close=$(document.createElement("div"));close.innerHTML="<span>"+options.closeText+"</span>";close.className="close";close.addEvent("click",function(){instance.close(true);});var loading=box.getElements(".loading");if(loading.length>0)
box.removeChild(loading[0]);var elements=[close,tl,tr,bl,br,top,bottom,left,right,img];for(var i=0;i<elements.length;i++){var elFx=new Fx.Morph(elements[i],{duration:600});if(!Browser.Engine.trident){elFx.set({opacity:0});}
box.adopt(elements[i]);if(!Browser.Engine.trident){elFx.start({opacity:1});}}
var caption;if((options.caption!="")&&(options.enableCaptions==true)){caption=document.createElement("div");caption.className="caption";caption.innerHTML="<p>"+options.caption+"</p>";box.appendChild(caption);}
instance.addSetNavigation();if(box.getElements(".caption").length>0){caption=box.getElements(".caption")[0];var cfx=new Fx.Morph(caption,{duration:200});cfx.set({opacity:0});if(options.showCaptionBar==true){caption.className+=" visibleCaption";var cStartFx=new Fx.Morph(caption,{duration:600});cStartFx.start({opacity:1});}
box.addEvent("mouseenter",function(){cfx.start({opacity:1}).chain(function(){caption.className+=" visibleCaption";});});box.addEvent("mouseleave",function(){cfx.start({opacity:0}).chain(function(){caption.className=caption.className.replace(/visibleCaption/g,"");});});close.addEvent("mouseenter",function(){cfx.start({opacity:0}).chain(function(){caption.className=caption.className.replace(/visibleCaption/g,"");});});box.getElements(".image")[0].addEvent("click",function(){var action="show";if(caption.className.indexOf("visibleCaption")!=-1)
action="hide";if(action=="show")
cfx.start({opacity:1}).chain(function(){caption.className+=" visibleCaption";});else
cfx.start({opacity:0}).chain(function(){caption.className=caption.className.replace(/visibleCaption/g,"");});});}
top.style.width=box.offsetWidth+"px";bottom.style.width=box.offsetWidth+"px";left.style.height=box.offsetHeight+"px";right.style.height=box.offsetHeight+"px";if(options.draggable==true)
var move=new Drag.Move(box,{handle:img});});}
this.addSetNavigation=function(){var links=$$(document.links).filter(function(link){if((link.rel)&&(link.rel.indexOf(options.rel)!=-1))
return true;else
return false;});var set=false;for(var i=0;i<links.length;i++){if((links[i].href.indexOf(options.image)!=-1)&&(links[i].rel)&&(links[i].rel.indexOf(options.rel+'['!=-1))){var rel=links[i].getAttribute("rel");set=instance.scanRel("after",options.rel+"[",this.scanRel("before","]",rel));}}
if(set!=false){var prevLink=false;var nextLink=false;var setLinks=new Array();for(i=0;i<links.length;i++){if(links[i].rel.indexOf(options.rel+"["+set+"]")!=-1){setLinks[setLinks.length]=links[i];}}
for(i=0;i<setLinks.length;i++){var link=setLinks[i];if((link.href.indexOf(options.image)!=-1)&&(link.rel)&&(link.rel.indexOf(options.rel!=-1))){if(i!=0)
prevLink=setLinks[i-1];if(i!=setLinks.length-1)
nextLink=setLinks[i+1];}}
if((prevLink!=false)||(nextLink!=false)){if(box.getElements(".caption").length==0){var caption=document.createElement("div");caption.className="caption";box.appendChild(caption);}else{var caption=box.getElements(".caption")[0];}}
if(prevLink!=false){var previousButton=$(document.createElement("div"));previousButton.className="previous";var prevCap='';if(prevLink.title)
prevCap=prevLink.title;var prevEl=prevLink;if(prevLink.getElements("img").length>0)
prevEl=prevLink.getElements("img")[0];previousButton.addEvent("click",function(){var newOptions=$unlink(options);var imagezoomPrev=new Imagezoom($extend(newOptions,{image:prevLink.href,caption:prevCap,rel:options.rel,startElement:prevEl,showCaptionBar:true}));instance.close();imagezoomPrev.show();});caption.appendChild(previousButton);}
if(nextLink!=false){var nextButton=$(document.createElement("div"));nextButton.className="next";var nextCap='';if(nextLink.title)
nextCap=nextLink.title;var nextEl=nextLink;if(nextLink.getElements("img").length>0)
nextEl=nextLink.getElements("img")[0];nextButton.addEvent("click",function(){var newOptions=$unlink(options);var imagezoomNext=new Imagezoom($extend(newOptions,{image:nextLink.href,caption:nextCap,rel:options.rel,startElement:nextEl,showCaptionBar:true}));instance.close();imagezoomNext.show();});caption.appendChild(nextButton);}}}
this.scanRel=function(where,needle,string){var newstring='';if(where=="after"){var startpos=string.indexOf(needle)+needle.length;var endpos=string.length;}else if(where=="before"){var startpos=0;var endpos=string.indexOf(needle);}
for(var i=startpos;i<endpos;i++){newstring+=string.charAt(i);}
return newstring;}
this.close=function(hideOverlay){var img=box.getElements(".image")[0];box.removeChild(img);var close=box.getElements(".close")[0];box.removeChild(close);var caption=box.getElements(".caption");if(caption.length>0)
box.removeChild(caption[0]);var s=box.getElements(".s");for(var i=0;i<s.length;i++)
box.removeChild(s[i]);var x=options.x;var y=options.y;var boxWidth=options.initWidth;var boxHeight=options.initHeight;if(options.startElement!=false){x=options.startElement.getPosition().x;y=options.startElement.getPosition().y;boxWidth=options.startElement.offsetWidth;boxHeight=options.startElement.offsetHeight;}
if((hideOverlay==true)&&($('imagezoom_overlay'))){var oFx=new Fx.Morph($('imagezoom_overlay'),{duration:options.closeDuration});oFx.start({opacity:0}).chain(function(){$$('body')[0].removeChild($('imagezoom_overlay'));});}
var fx=new Fx.Morph(box,{duration:options.closeDuration});fx.start({left:x,top:y,width:boxWidth,height:boxHeight,opacity:options.startOpacity}).chain(function(){fx.start({opacity:0}).chain(function(){$$('body')[0].removeChild(box);});});}}