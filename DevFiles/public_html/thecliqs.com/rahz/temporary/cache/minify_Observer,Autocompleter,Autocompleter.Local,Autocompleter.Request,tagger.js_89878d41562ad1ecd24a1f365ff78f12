var Observer=new Class({Implements:[Options,Events],options:{periodical:false,delay:1000},initialize:function(el,onFired,options){this.element=$(el)||$$(el);this.addEvent('onFired',onFired);this.setOptions(options);this.bound=this.changed.bind(this);this.resume();},changed:function(){var value=this.element.get('value');if($equals(this.value,value))return;this.clear();this.value=value;this.timeout=this.onFired.delay(this.options.delay,this);},setValue:function(value){this.value=value;this.element.set('value',value);return this.clear();},onFired:function(){this.fireEvent('onFired',[this.value,this.element]);},clear:function(){$clear(this.timeout||null);return this;},pause:function(){if(this.timer)$clear(this.timer);else this.element.removeEvent('keyup',this.bound);return this.clear();},resume:function(){this.value=this.element.get('value');if(this.options.periodical)this.timer=this.changed.periodical(this.options.periodical,this);else this.element.addEvent('keyup',this.bound);return this;}});var $equals=function(obj1,obj2){return(obj1==obj2||JSON.encode(obj1)==JSON.encode(obj2));};;var Autocompleter=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:true,width:'inherit',maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:true,className:'autocompleter-choices',zIndex:42,delay:1,observerOptions:{},fxOptions:{},autoSubmit:false,overflow:false,overflowMargin:25,selectFirst:true,filter:null,filterCase:false,filterSubset:false,forceSelect:false,selectMode:true,choicesMatch:null,multiple:false,separator:', ',separatorSplit:/\s*[,;]\s*/,autoTrim:false,allowDupes:false,cache:true,relative:true,tokenFormat:'object',tokenIdKey:'id',tokenValueKey:'label',prefetchOnInit:false,alwaysOpen:false,ignoreKeys:false,ignoreOverlayFix:false},initialize:function(element,options){this.element=$(element);this.setOptions(options);this.build();this.observer=new Observer(this.element,this.prefetch.bind(this),$merge({'delay':this.options.delay},this.options.observerOptions));this.queryValue=null;if(this.options.filter)this.filter=this.options.filter.bind(this);var mode=this.options.selectMode;this.typeAhead=(mode=='type-ahead');this.selectMode=(mode===true)?'selection':mode;this.cached=[];if(this.options.prefetchOnInit)this.prefetch.delay(this.options.delay+50,this);},build:function(){if($(this.options.customChoices)){this.choices=this.options.customChoices;}else{this.choices=new Element('ul',{'class':this.options.className,'styles':{'zIndex':this.options.zIndex}}).inject(document.body);this.relative=false;if(this.options.relative){this.choices.inject(this.element,'after');this.relative=this.element.getOffsetParent();}
if(!this.options.ignoreOverlayFix)this.fix=new OverlayFix(this.choices);}
if(!this.options.separator.test(this.options.separatorSplit)){this.options.separatorSplit=this.options.separator;}
if(!this.options.alwaysOpen){this.fx=(!this.options.fxOptions)?null:new Fx.Tween(this.choices,$merge({'property':'opacity','link':'cancel','duration':200},this.options.fxOptions)).addEvent('onStart',Chain.prototype.clearChain).set(0);}
this.element.setProperty('autocomplete','off').addEvent((Browser.Engine.trident||Browser.Engine.webkit)?'keydown':'keypress',this.onCommand.bind(this)).addEvent('click',this.onCommand.bind(this,[false]));if(!this.options.alwaysOpen){this.element.addEvent('focus',this.toggleFocus.create({bind:this,arguments:true,delay:100})).addEvent('blur',this.toggleFocus.create({bind:this,arguments:false,delay:100}));}},destroy:function(){if(this.fix)this.fix.destroy();this.choices=this.selected=this.choices.destroy();},toggleFocus:function(state){this.focussed=state;if(!state)this.hideChoices(true);this.fireEvent((state)?'onFocus':'onBlur',[this.element]);},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift&&!this.options.ignoreKeys){switch(e.key){case'enter':e.stop();if(!this.selected){if(!this.options.customChoices){this.element.value='';}
return true;}
if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}
break;case'up':case'down':var value=this.element.value;if(!this.prefetch()&&this.queryValue!==null){var up=(e.key=='up');this.choiceOver((this.selected||this.choices)[(this.selected)?((up)?'getPrevious':'getNext'):((up)?'getLast':'getFirst')](this.options.choicesMatch),true);this.element.value=value;}
return false;case'esc':this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;case'tab':if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}else{this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;}}}
this.fireEvent('onCommand',e);return true;},setSelection:function(finish){var tokenInfo=this.selected.retrieve('autocompleteChoice');var input=(this.options.tokenFormat=='object'?tokenInfo[this.options.tokenValueKey]:tokenInfo);var value=input;var start=this.queryValue.length,end=input.length;if((input.substr(0,start)||'').toLowerCase()!=(this.queryValue||'').toLowerCase())start=0;if(this.options.multiple){var split=this.options.separatorSplit;value=this.element.value;start+=this.queryIndex;end+=this.queryIndex;var old=value.substr(this.queryIndex).split(split,1)[0];value=value.substr(0,this.queryIndex)+input+value.substr(this.queryIndex+old.length);if(finish){var tokens=value.split(this.options.separatorSplit).filter(function(entry){return this.test(entry);},/[^\s,]+/);if(!this.options.allowDupes)tokens=[].combine(tokens);var sep=this.options.separator;value=tokens.join(sep)+sep;end=value.length;}}
if(this.options.autocompleteType=='tag')this.observer.setValue(value);this.opted=value;if(finish||this.selectMode=='pick')start=end;$try(function(){this.element.selectRange(start,end)}.bind(this));this.fireEvent('onSelection',[this.element,this.selected,value,input]);},showChoices:function(){var match=this.options.choicesMatch,first=this.choices.getFirst(match);this.selected=this.selectedValue=null;if(this.fix){var pos=this.element.getCoordinates(this.relative),width=this.options.width||'auto';this.choices.setStyles({'width':(width===true||width=='inherit')?pos.width:width});}
if(!first)return;if(!this.visible){this.visible=true;this.choices.setStyle('display','');if(this.fx)this.fx.start(1);this.fireEvent('onShow',[this.element,this.choices]);}
if(this.options.selectFirst||this.typeAhead||first.inputValue==this.queryValue)this.choiceOver(first,this.typeAhead);var items=this.choices.getChildren(match),max=this.options.maxChoices;var styles={'overflowY':'hidden','height':''};this.overflown=false;if(items.length>max){var item=items[max-1];styles.overflowY='scroll';styles.height=item.getCoordinates(this.choices).bottom;this.overflown=true;};this.choices.setStyles(styles);if(this.fix)this.fix.show();if(this.options.visibleChoices){var scroll=document.getScroll(),size=document.getSize(),coords=this.choices.getCoordinates();if(coords.right>scroll.x+size.x)scroll.x=coords.right-size.x;if(coords.bottom>scroll.y+size.y)scroll.y=coords.bottom-size.y;window.scrollTo(Math.min(scroll.x,coords.left),Math.min(scroll.y,coords.top));}},hideChoices:function(clear){if(clear){var value=this.element.value;if(this.options.forceSelect)value=this.opted;if(this.options.autoTrim){value=value.split(this.options.separatorSplit).filter($arguments(0)).join(this.options.separator);}
this.observer.setValue(value);}
if(!this.visible)return;this.visible=false;if(this.selected)this.selected.removeClass('autocompleter-selected');this.observer.clear();var hide=function(){this.choices.setStyle('display','none');if(this.fix)this.fix.hide();}.bind(this);if(this.fx)this.fx.start(0).chain(hide);else hide();this.fireEvent('onHide',[this.element,this.choices]);},prefetch:function(){var value=this.element.value,query=value;if(this.options.multiple){var split=this.options.separatorSplit;var values=value.split(split);var index=this.element.getSelectedRange().start;var toIndex=value.substr(0,index).split(split);var last=toIndex.length-1;index-=toIndex[last].length;query=values[last];}
if(query.length<this.options.minLength){this.hideChoices();}else{if(query===this.queryValue||(this.visible&&query==this.selectedValue)){if(this.visible)return false;this.showChoices();}else{this.queryValue=query;this.queryIndex=index;if(!this.fetchCached())this.query();}}
return true;},fetchCached:function(){switch(true){case(!this.options.cache):case(!this.cachedQueryValue||this.queryValue.length<this.cachedQueryValue.length):case(this.queryValue.indexOf(this.cachedQueryValue)==-1):return false;break;}
if(this.cached.length<this.options.maxChoices)
{this.update(this.filter(this.cached));return true;}
var newChoices=this.filter(this.cached,this.queryValue);if(newChoices.length>=this.cached.length)
{this.update(this.filter(this.cached));return true;}
return false;},update:function(tokens){$(this.choices).empty();this.cached=tokens;this.cachedQueryValue=this.queryValue;var type=tokens&&$type(tokens);if(!type||(type=='array'&&!tokens.length)||(type=='hash'&&!tokens.getLength())){(this.options.emptyChoices||this.hideChoices).call(this);}else{if(this.options.maxChoices<tokens.length&&!this.options.overflow)tokens.length=this.options.maxChoices;tokens.each(this.options.injectChoice||function(token){tokenValue=(this.options.tokenFormat=='object'?token[this.options.tokenValueKey]:token);var choice=new Element('li',{'html':this.markQueryValue(tokenValue)});this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},this);this.showChoices();}},choiceOver:function(choice,selection){if(!choice||choice==this.selected)return;if(this.selected)this.selected.removeClass('autocompleter-selected');this.selected=choice.addClass('autocompleter-selected');this.fireEvent('onSelect',[this.element,this.selected,selection]);if(!this.selectMode)this.opted=this.element.value;if(!selection)return;this.selectedValue=this.selected.retrieve('autocompleteChoice');if(this.overflown){var coords=this.selected.getCoordinates(this.choices),margin=this.options.overflowMargin,top=this.choices.scrollTop,height=this.choices.offsetHeight,bottom=top+height;if(coords.top-margin<top&&top)this.choices.scrollTop=Math.max(coords.top-margin,0);else if(coords.bottom+margin>bottom)this.choices.scrollTop=Math.min(coords.bottom-height+margin,bottom);}
if(this.selectMode)this.setSelection();},choiceSelect:function(choice){if(choice)this.choiceOver(choice);this.setSelection(true);this.queryValue=false;if(!this.options.alwaysOpen){this.hideChoices();}else{this.observer.setValue('');this.prefetch.delay(this.options.delay,this);}
this.fireEvent('onChoiceSelect',choice);if(this.options.autocompleteType=='message'){this.element.value='';var token=choice.retrieve('autocompleteChoice');if(token.friends){var friend_ids="";for(var id in token.friends){if(friend_ids=="")friend_ids=id;else friend_ids=friend_ids+","+id;}
this.doAddValueToHidden(token.label,friend_ids,'toValues',true,' tag_friend');}
else this.doAddValueToHidden(choice.id,token.id,'toValues',true);}},doAddValueToHidden:function(name,toID,hideLoc,newItem,list){var hiddenInputField=document.getElementById(hideLoc);var previousToValues=hiddenInputField.value;if(this.checkSpanExists(name,toID)){if(previousToValues==''){document.getElementById(hideLoc).value=toID;}
else{document.getElementById(hideLoc).value=previousToValues+","+toID;}
this.doPushSpan(name,toID,newItem,hideLoc,list);}},doPushSpan:function(name,toID,newItem,hideLoc,list){var myElement=new Element("span");if(newItem){myElement.id="tospan_"+name+"_"+toID;myElement.innerHTML=name+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\");'>x</a>";}
else{myElement.id="tospan_"+name+"_"+toID;myElement.innerHTML=name+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\");'>x</a>";}
$('toValues-wrapper').setStyle('height','auto');if(list==null)list="";myElement.addClass("tag"+list);document.getElementById('toValues-element').appendChild(myElement);this.fireEvent('push');},checkToValue:function(toID,toValues){var checkValue=true;var checkMulti=toID.search(/,/);var x;var toValueArray=toValues.split(",");if(checkMulti!=-1){var recipientsArray=toID.split(",");var multiBool=false;for(var i=0;i<recipientsArray.length;i++){var tempBool=true;for(var x=0;x<toValueArray.length;x++){if(toValueArray[x]==recipientsArray[i]){tempBool=false;}}
multiBool=multiBool||tempBool;}
checkValue=multiBool;}
else{for(x in toValueArray)
{if(toValueArray[x]==toID){checkValue=false;}}}
return checkValue;},checkSpanExists:function(name,toID){var span_id="tospan_"+name+"_"+toID;if($(span_id)){return false;}
else return true;},filter:function(tokens,queryValue){queryValue=queryValue||this.queryValue;tokens=tokens||this.tokens;var regex=new RegExp(((this.options.filterSubset)?'':'^')+queryValue.escapeRegExp(),(this.options.filterCase)?'':'i');if(this.options.tokenFormat=='object'){var key=this.options.tokenValueKey;return tokens.filter(function(token){return regex.test(token[key]);});}else{return tokens.filter(function(token){return regex.test(token);});}
return tokens;},markQueryValue:function(str){return(!this.options.markQuery||!this.queryValue)?str:str.replace(new RegExp('('+((this.options.filterSubset)?'':'^')+this.queryValue.escapeRegExp()+')',(this.options.filterCase)?'':'i'),'<span class="autocompleter-queried">$1</span>');},addChoiceEvents:function(el){return el.addEvents({'mouseover':this.choiceOver.bind(this,el),'click':this.choiceSelect.bind(this,el)});}});var OverlayFix=new Class({initialize:function(el){if(Browser.Engine.trident){this.element=$(el);this.relative=this.element.getOffsetParent();this.fix=new Element('iframe',{'frameborder':'0','scrolling':'no','src':'javascript:false;','styles':{'position':'absolute','border':'none','display':'none','filter':'progid:DXImageTransform.Microsoft.Alpha(opacity=0)'}}).inject(this.element,'after');}},show:function(){if(this.fix){var coords=this.element.getCoordinates(this.relative);delete coords.right;delete coords.bottom;this.fix.setStyles($extend(coords,{'display':'','zIndex':(this.element.getStyle('zIndex')||1)-1}));}
return this;},hide:function(){if(this.fix)this.fix.setStyle('display','none');return this;},destroy:function(){if(this.fix)this.fix=this.fix.destroy();}});Element.implement({getSelectedRange:function(){if(!Browser.Engine.trident)return{start:this.selectionStart,end:this.selectionEnd};var pos={start:0,end:0};var range=this.getDocument().selection.createRange();if(!range||range.parentElement()!=this)return pos;var dup=range.duplicate();if(this.type=='text'){pos.start=0-dup.moveStart('character',-100000);pos.end=pos.start+range.text.length;}else{var value=this.value;var offset=value.length-value.match(/[\n\r]*$/)[0].length;dup.moveToElementText(this);dup.setEndPoint('StartToEnd',range);pos.end=offset-dup.text.length;dup.setEndPoint('StartToStart',range);pos.start=offset-dup.text.length;}
return pos;},selectRange:function(start,end){if(Browser.Engine.trident){var diff=this.value.substr(start,end-start).replace(/\r/g,'').length;start=this.value.substr(0,start).replace(/\r/g,'').length;var range=this.createTextRange();range.collapse(true);range.moveEnd('character',start+diff);range.moveStart('character',start);range.select();}else{this.focus();this.setSelectionRange(start,end);}
return this;}});Autocompleter.Base=Autocompleter;;Autocompleter.Local=new Class({Extends:Autocompleter,options:{minLength:0,delay:200},initialize:function(element,tokens,options){this.parent(element,options);this.tokens=tokens;},query:function(){this.update(this.filter());}});;Autocompleter.Request=new Class({Extends:Autocompleter,options:{postData:{},ajaxOptions:{},postVar:'value',delay:250},query:function(){var data=$unlink(this.options.postData)||{};data[this.options.postVar]=this.queryValue;var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','');var cls=this.options.indicatorClass;if(cls)this.element.addClass(cls);this.fireEvent('onRequest',[this.element,this.request,data,this.queryValue]);this.request.send({'data':data});},queryResponse:function(){var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','none');var cls=this.options.indicatorClass;if(cls)this.element.removeClass(cls);return this.fireEvent('onComplete',[this.element,this.request]);}});Autocompleter.Request.JSON=new Class({Extends:Autocompleter.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.JSON($merge({'url':url,'link':'cancel'},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(response){this.parent();this.update(response);}});Autocompleter.Request.HTML=new Class({Extends:Autocompleter.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.HTML($merge({'url':url,'link':'cancel','update':this.choices},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(tree,elements){this.parent();if(!elements||!elements.length){this.hideChoices();}else{this.choices.getChildren(this.options.choicesMatch).each(this.options.injectChoice||function(choice){var value=choice.innerHTML;choice.inputValue=value;this.addChoiceEvents(choice.set('html',this.markQueryValue(value)));},this);this.showChoices();}}});Autocompleter.Ajax={Base:Autocompleter.Request,Json:Autocompleter.Request.JSON,Xhtml:Autocompleter.Request.HTML};;var Tagger=new Class({Implements:[Events,Options],options:{'title':false,'description':false,'transImage':'application/modules/Core/externals/images/trans.gif','existingTags':[],'tagListElement':false,'linkElement':false,'noTextTagHref':true,'guid':false,'enableCreate':false,'enableDelete':false,'createRequestOptions':{'url':'','data':{'format':'json'}},'deleteRequestOptions':{'url':'','data':{'format':'json'}},'cropOptions':{'preset':[10,10,58,58],'min':[48,48],'max':[128,128],'handleSize':8,'opacity':.6,'color':'#7389AE','border':'externals/moolasso/crop.gif'},'suggestProto':'local','suggestParam':[],'suggestOptions':{'minLength':0,'maxChoices':100,'delay':250,'selectMode':'pick','multiple':false,'className':'message-autosuggest','filterSubset':true,'tokenFormat':'object','tokenValueKey':'label','injectChoice':$empty,'onPush':$empty,'prefetchOnInit':true,'alwaysOpen':true,'ignoreKeys':true}},initialize:function(el,options){el=$(el);if(el.get('tag')!='img'){this.image=el.getElement('img');}else{this.image=el;}
this.element=el;this.count=0;this.setOptions(options);this.options.existingTags.each(this.addTag.bind(this));},begin:function(){if(!this.options.enableCreate)return;this.getCrop();this.getForm();this.getSuggest();this.fireEvent('onBegin');},end:function(){if(this.crop){this.crop.destroy();delete this.crop;}
if(this.form){this.form.destroy();delete this.form;}
if(this.suggest){delete this.suggest;}
this.fireEvent('onEnd');},getCrop:function(){if(!this.crop){var options=$merge(this.options.cropOptions,{});this.crop=new Lasso.Crop(this.image,options);this.crop.addEvent('resize',this.onMove.bind(this));this.crop.refresh();}
return this.crop;},getForm:function(){if(!this.form){this.form=new Element('div',{'id':'tagger_form','class':'tagger_form','styles':{'position':'absolute','z-index':'100000','width':'150px'}}).inject(this.element,'after');if(this.options.title){new Element('div',{'class':'media_photo_tagform_titlebar','html':this.options.title}).inject(this.form);}
this.formContainer=new Element('div',{'class':'media_photo_tagform_container'}).inject(this.form);if(this.options.description){new Element('div',{'class':'media_photo_tagform_text','html':this.options.description}).inject(this.formContainer);}
this.input=new Element('input',{'id':'tagger_input','class':'tagger_input','type':'text','styles':{}}).inject(this.formContainer);this.choices=new Element('div',{'class':'tagger_list'}).inject(this.formContainer);var submitContainer=new Element('div',{'class':'media_photo_tagform_submits'}).inject(this.formContainer);var self=this;new Element('a',{'id':'tag_save','href':'javascript:void(0);','html':en4.core.language.translate('Save'),'events':{'click':function(){var data={};data.label=self.input.value;if($type(data.label)&&data.label!=''){data.extra=self.coords;self.createTag(data);}}}}).inject(submitContainer);new Element('a',{'id':'tag_cancel','href':'javascript:void(0);','html':en4.core.language.translate('Cancel'),'events':{'click':function(){this.end();}.bind(this)}}).inject(submitContainer);this.input.focus();}
return this.form;},getSuggest:function(){if(!this.suggest){var self=this;var options=$merge(this.options.suggestOptions,{'overflow':true,'maxChoices':4,'customChoices':this.choices,'injectChoice':function(token){var choice=new Element('li',{'class':'autocompleter-choices','html':token.photo||'','id':token.guid});new Element('div',{'html':this.markQueryValue(token.label),'class':'autocompleter-choice'}).inject(choice);new Element('input',{'type':'hidden','value':JSON.encode(token)}).inject(choice);this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},'onChoiceSelect':function(choice){var data=JSON.decode(choice.getElement('input').value);data.extra=self.coords;self.createTag(data);},'emptyChoices':function(){this.fireEvent('onHide',[this.element,this.choices]);},'onCommand':function(e){switch(e.key){case'enter':self.createTag({label:self.input.value,extra:self.coords});break;}}});if(this.options.suggestProto=='local'){this.suggest=new Autocompleter.Local(this.input,this.options.suggestParam,options);}else if(this.options.suggestProto=='request.json'){this.suggest=new Autocompleter.Request.JSON(this.input,this.options.suggestParam,options);}}
return this.suggest;},getTagList:function(){if(!this.tagList){if(!this.options.tagListElement){this.tagList=new Element('div',{'class':'tag_list'}).inject(this.element,'after');}else{this.tagList=$(this.options.tagListElement);}}
return this.tagList;},onMove:function(coords){this.coords=coords;var pos={x:0,y:0};var form=this.getForm();form.setStyles({'top':pos.y+coords.y+20,'left':pos.x+coords.x+coords.w+20});},addTag:function(params){if('object'!=$type(params)){return;}
var baseX=0,baseY=0,baseW=0,baseH=0;["x","y","w","h"].each(function(key){params.extra[key]=parseInt(params.extra[key]);});if(this.options.noTextTagHref&&params.tag_type=='core_tag'){delete params.href;}
var tag=new Element('div',{'id':'tag_'+params.id,'class':'tag_div','html':'<img src="'+this.options.transImage+'" width="100%" height="100%" />','styles':{'position':'absolute','width':params.extra.w,'height':params.extra.h,'top':baseY+params.extra.y,'left':baseX+params.extra.x},'events':{'mouseover':function(){this.showTag(params.id);}.bind(this),'mouseout':function(){this.hideTag(params.id);}.bind(this)}}).inject(this.element,'after');var label=new Element("span",{'id':'tag_label_'+params.id,'class':'tag_label','html':params.text,'styles':{'position':'absolute'}}).inject(this.element,'after');var labelPos={};labelPos.top=(baseY+params.extra.y+tag.getSize().y);labelPos.left=Math.round((baseX+params.extra.x)+(tag.getSize().x/2)-(label.getSize().x/2));if(this.element.getSize().y<labelPos.top.toInt()+20){labelPos.top=baseY+params.extra.y-label.getSize().y;}
label.setStyles(labelPos);this.hideTag(params.id);var isFirst=(!$type(this.count)||this.count==0);this.getTagList().setStyle('display','');if(!isFirst)new Element('span',{'id':'tag_comma_'+params.id,'class':'tag_comma','html':','}).inject(this.getTagList());var info=new Element('span',{'id':'tag_info_'+params.id,'class':'tag_info media_tag_listcontainer'}).inject(this.getTagList());var activator=new Element('a',{'id':'tag_activator_'+params.id,'class':'tag_activator','href':params.href||null,'html':params.text,'events':{'mouseover':function(){this.showTag(params.id);}.bind(this),'mouseout':function(){this.hideTag(params.id);}.bind(this)}}).inject(info);if(this.checkCanRemove(params.id))
{info.appendText(' (');var destroyer=new Element('a',{'id':'tag_destroyer_'+params.id,'class':'tag_destroyer albums_tag_delete','href':'javascript:void(0);','html':en4.core.language.translate('delete'),'events':{'click':function(){this.removeTag(params.id);}.bind(this)}}).inject(info);info.appendText(')');}
this.count++;},createTag:function(params){if(!this.options.enableCreate)return;var requestOptions=$merge(this.options.createRequestOptions,{'data':$merge(params,{}),'onComplete':function(responseJSON){this.addTag(responseJSON);}.bind(this)});var request=new Request.JSON(requestOptions);request.send();this.end();},removeTag:function(id){if(!this.checkCanRemove(id))return;var next=$('tag_info_'+id).getNext();if(next&&next.get('html').trim()==',')next.destroy();$('tag_'+id).destroy();$('tag_label_'+id).destroy();$('tag_info_'+id).destroy();this.count--;var requestOptions=$merge(this.options.deleteRequestOptions,{'data':{'tagmap_id':id},'onComplete':function(responseJSON){}.bind(this)});var request=new Request.JSON(requestOptions);request.send();},checkCanRemove:function(id){var tagData;this.options.existingTags.each(function(datum){if(datum.tagmap_id==id){tagData=datum;}});if(this.options.enableDelete)return true;if(tagData){if(tagData.tag_type+'_'+tagData.tag_id==this.options.guid)return true;if(tagData.tagger_type+'_'+tagData.tagger_id==this.options.guid)return true;}
return false;},showTag:function(id){$('tag_'+id).removeClass('tag_div_hidden');$('tag_label_'+id).removeClass('tag_label_hidden');},hideTag:function(id){$('tag_'+id).addClass('tag_div_hidden');$('tag_label_'+id).addClass('tag_label_hidden');}});