var Hetips={};Hetips.profileUrlEnabled=false;Hetips.attach=function()
{Hetips.elements=new Hetips.Storage();var prepare_links=[];$$('a:not(.Hetips_liketips):not(.hetips_tips_active)').each(function(item){var href=item.get('href');if(Hetips.profileUrlEnabled){var parent=/invite|albums|blogs|classfields|chat|forum|polls|groups|events|pages|videos|usernotes|music|register|logout|members|classified|faq/i;var user_href=href.replace(en4.core.baseUrl,"");if(user_href.indexOf('/')===-1&&user_href.indexOf('javascript:')===-1){if(!parent.test(user_href)&&!item.getParent('.hetips-liketips')&&item.getParent('.layout_user_home_links')===null&&item.getParent('.layout_user_home_photo')===null&&(item.get('class')||'').indexOf('menu_core_mini')){item.addClass('hetips_tips_active');item.setStyle('display','inline-block');prepare_links[prepare_links.length]=item;}}}
if(href&&href.indexOf("content_")===-1&&item.getParent('.paginationControl')===null&&item.getParent().get('.feed_item_option_share')===null&&(item.get('class')||'').indexOf('like_suggest')===-1&&item.getParent('.like_list')===null&&(item.get('class')||'').indexOf('wall_liketips')===-1&&item.getParent('.wall-liketips')===null&&item.getParent('.likes')===null&&item.getParent('.he-tool-tip')===null&&(item.getParent().get('class')||'').indexOf('he_like')&&(item.getParent().get('class')||'').indexOf('_admin_list')){if(href.indexOf(en4.core.baseUrl+'profile/')!==-1||href.indexOf(en4.core.baseUrl+'page/')!==-1||href.indexOf(en4.core.baseUrl+'group/')!==-1){if(!item.get('id')||(item.get('id')&&item.get('id').indexOf('like_action_item')===-1&&item.get('id')&&item.get('id').indexOf('owner_user_')===-1)){if(!item.getParent('.hetips-liketips')){if((item.get('class')||'').indexOf('buttonlink')===-1&&(item.get('class')||'').indexOf('menu_core_mini')){if((item.getParent().get('class')||'').indexOf('index_browse')===-1&&item.getParent('.tl-block')===null&&item.getParent('.layout_user_home_links')===null&&item.getParent('.layout_user_home_photo')===null||(item.getParent().get('class')||'').indexOf('he_')===0){item.addClass('hetips_tips_active');item.setStyle('display','inline-block');prepare_links[prepare_links.length]=item;}}}}}}});for(var i=0;prepare_links.length>i;i++){prepare_links[i]
Hetips.elementClass(Hetips.LikeTips,prepare_links[i]);}};Hetips.Storage=new Class({items:{},initialize:function()
{this.items=new Hash();},add:function(key,object)
{if(this.items[key]){return;}
this.items[key]=object;return this;},get:function(key)
{var options=Array.prototype.slice.call(arguments||[]);if(options.length>1){key=options.join("_");}
return this.items[key];},getAll:function()
{return this.items},remove:function(key)
{this.items.erase(key);return this;}});Hetips.elementClass=function()
{var options=Array.prototype.slice.call(arguments||[]);var newClass=options[0];if(!newClass||($type(newClass)!='class')){return;}
var name=newClass.prototype.name;if(!name){return;}
if($type($(options[1]))=='element'){var element=$(options[1]);var key=name+'_'+(window.$uid||Slick.uidOf)(element);var instance=Hetips.elements.get(key);if(instance){return instance;}
newClass._prototyping=true;newClass.$prototyping=true;instance=new newClass();delete newClass._prototyping;delete newClass.$prototyping;newClass.prototype.initialize.apply(instance,options.slice(1));Hetips.elements.add(key,instance);return instance;}};Hetips.TipFx=new Class({Implements:[Events,Options],options:{class_var:'',is_arrow:true,relative_element:null,delay:1},timeout:null,mouseActive:false,initialize:function(element,options)
{this.setOptions(options);this.element=$(element);this.createDom();},createDom:function()
{var self=this;if($type($(this.element))!='element'){return;}
this.$container=new Element('div',{'class':'hetips-tips '+(this.options.class_var||''),style:'display:none'});this.$inner=new Element('div',{'class':'container','html':(this.options.html||'')});if(!Hetips.isLightTheme()){this.$container.addClass('night_theme');}
if(this.options.is_arrow){this.$arrow_container=new Element('div',{'class':'arrow_container'});this.$arrow=new Element('div',{'class':'arrow'});}
this.$inner.inject(this.$container);if(this.options.is_arrow){this.$arrow.inject(this.$arrow_container);this.$arrow_container.inject(this.$container);}
this.$container.inject(Hetips.externalDiv());window.addEvent('resize',function(){this.build();}.bind(this));this.build();var mouseover=function(){this.mouseActive=true;if(this.options.delay){window.clearTimeout(this.timeout);this.timeout=window.setTimeout(function(){this.build();this.$container.setStyle('display','');this.fireEvent('mouseover');}.bind(this),this.options.delay);}else{this.build();this.$container.setStyle('display','');this.fireEvent('mouseover');}}.bind(this);this.element.addEvent('mouseover',mouseover);this.$container.addEvent('mouseover',mouseover);var mouseout=function(e){this.mouseActive=false;if(this.options.delay){window.clearTimeout(this.timeout);this.timeout=window.setTimeout(function(){if(e&&$(e.relatedTarget)){}
this.$container.setStyle('display','none');this.fireEvent('mouseout');}.bind(this),this.options.delay);}else{this.$container.setStyle('display','none');this.fireEvent('mouseout');}}.bind(this);this.element.addEvent('mouseout',mouseout);this.$container.addEvent('mouseout',mouseout);this.fireEvent('complete');},build:function()
{if(!this.element.isVisible()){return;}
var dir='ltr';if($$('html')[0]){dir=$$('html')[0].get('dir');}
this.$container.setStyle('display','');var e_pos=this.element.getCoordinates();var c_pos=this.$container.getCoordinates();var w_pos=this.options.relative_element||$$('body')[0].getSize();this.$container.setStyle('display','none').setStyle('padding-bottom',2);var rebuild=function(left,top){if(left){this.$container.setStyle('left',e_pos.left);if(this.options.is_arrow){var left=(e_pos.width/2-2.5).toInt();if(left>c_pos.width/2-2.5){left=10;}
this.$arrow.setStyle('left',left);}}else{this.$container.setStyle('left',e_pos.left-(c_pos.width-e_pos.width));if(this.options.is_arrow){var right=(e_pos.width/2-2.5).toInt();if(right>c_pos.width/2-2.5){right=10;}
this.$arrow.setStyle('right',right);}}
if(top){this.$container.setStyle('top',e_pos.top-c_pos.height-1);if(this.options.is_arrow){this.$arrow_container.inject(this.$inner,'after');this.$arrow.addClass('bottom');}}else{this.$container.setStyle('top',e_pos.top+e_pos.height+1);if(this.options.is_arrow){this.$arrow_container.inject(this.$inner,'before');this.$arrow.addClass('top');}}
this.fireEvent('build');}.bind(this);if(this.options.top!=undefined&&this.options.left!=undefined){rebuild(this.options.left,this.options.top);}else{rebuild(1,1);}}});Hetips.liketips_enabled=true;Hetips.liketips=new Hetips.Storage();Hetips.loaders=[];Hetips.LikeTips=new Class({Extends:Hetips.TipFx,name:'Hetips.LikeTips',is_loading:false,options:{class_var:'hetips-liketips',html:'<div class="data"><span class="hetips-loading">&nbsp;</span>'+en4.core.language.translate('HETIPS_LOADING')+'</div>',delay:250},initialize:function(element,options)
{this.parent(element,options);var query='';var result=element.href.replace('http://'+document.domain+''+en4.core.baseUrl,'').replace('https://'+document.domain+''+en4.core.baseUrl,'');if(result){result=result.split('/');result[0]=result[0]=='profile'?'user':result[0];query+=result.length==1?'type/user/id/'+result[0]:'type/'+result[0]+'/id/'+result[1];}
var self=this;var guid=query;var loadContent=function(){var element=Hetips.liketips.get(guid);if(element){if(element.get('html')==''){self.$container.setStyle('display','none');return;}
element.inject(Hetips.externalDiv());self.$inner.empty();element.inject(self.$inner);self.build();if(self.mouseActive){self.$container.setStyle('display','block');}
return;}
if(Hetips.loaders.contains(guid)){return;}
Hetips.loaders[Hetips.loaders.length]=guid;Hetips.requestHTML(en4.core.baseUrl+'hetips/index/index/'+query,function(html){var element=new Element('div',{'class':''});element.set('html',html);Hetips.liketips.add(guid,element);loadContent();});};this.addEvent('mouseover',loadContent);}});Hetips.lightHexColor=function(hex)
{if(hex[0]=="#")hex=hex.substr(1);if(hex.length==3){var temp=hex;hex='';temp=/^([a-f0-9])([a-f0-9])([a-f0-9])$/i.exec(temp).slice(1);for(var i=0;i<3;i++)hex+=temp[i]+temp[i];}
var result=/^([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(hex);if(!result){return 150;}
var triplets=result.slice(1);return 0.213*parseInt(triplets[0],16)+0.715*parseInt(triplets[1],16)+0.072*parseInt(triplets[2],16);};Hetips.lightDiv=null;Hetips.isLightTheme=function()
{if(!Hetips.lightDiv){Hetips.lightDiv=new Element('div',{style:'display:none','class':'hetips-theme-foreground'});Hetips.lightDiv.inject(Hetips.externalDiv());}
var hex=Hetips.lightDiv.getStyle('background-color');if(hex=='transparent'){hex=Hetips.lightDiv.removeClass('hetips-theme-foreground').addClass('hetips-theme-background').getStyle('background-color');}
return Hetips.lightHexColor(hex)>100;};Hetips.$external_div=null;Hetips.externalDiv=function(){if(!this.$external_div||$type(this.$external_div)!='element'){this.$external_div=new Element('div',{'class':'hetips-element-external'});this.$external_div.inject($$('body')[0]);}
return this.$external_div;};Hetips.requestHTML=function(url,callback,$container,data)
{data=$merge({'format':'html'},data);Hetips.is_request=true;var request=new Request.HTML({'url':url,'method':'get','data':data,'evalScripts':false,'onComplete':function(responseTree,responseElements,responseHTML,responseJavaScript){Hetips.is_request=false;if($container&&$type($container)=='element'){$container.set('html',responseHTML);}
if($type(callback)=='function'){callback(responseHTML);}
eval(responseJavaScript);Smoothbox.bind($$('body')[0]);en4.core.runonce.trigger();}});request.send();};;(function(){var $='id'in document?document.id:window.$;soundManager.onready(function(){if(soundManager.supported()){soundManager.createSound({id:'_chat_ding',url:en4.core.staticBaseUrl+'application/modules/Chat/externals/ding.mp3',autoLoad:true,volume:50});}});ChatHandler=new Class({Implements:[Events,Options],options:{debug:false,baseUrl:'/',identity:false,delay:3000,requestTimeout:10000,admin:false,idleTimeout:60000,enableChat:true,chatOptions:{identity:1,operator:false},enableIM:true,imOptions:{container:false,memberIm:false}},state:false,chatstate:0,imstate:0,activestate:1,fresh:true,rooms:{},lastEventTime:false,initialize:function(options){this.setOptions(options);this.options.requestTimeout=Math.round(this.options.delay*0.5);if(this.options.delay<1000)this.options.delay=1000;if(this.options.requestTimeout<1000)this.options.requestTimeout=1000;this.rooms=new Hash();},start:function(){this.state=true;if(this.options.enableIM){this.startIm(this.options.imOptions);}
if(this.options.enableChat){this.startChat(this.options.chatOptions);}
this.addEvent('onEvent_reconfigure',this.onReconfigure.bind(this));this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this.activestate=1;this.status(1);}.bind(this),'onStateIdle':function(){this.activestate=0;this.status(2);}.bind(this)});this.loop();},startIm:function(options){if($type(this.im)){return;}
this.options.imOptions=$merge(this.options.imOptions,options);this.im=new ChatHandler_Whispers(this,this.options.imOptions);this.imstate=1;var savedState=Cookie.read('en4_chat_imstate',{path:en4.core.basePath});if(savedState==0){this.im.items.settings.toggleOnline();}},startChat:function(options){var identity=options.identity||Cookie.read('en4_chat_room_last',{path:en4.core.basePath})||1;options.identity=identity;if(!identity||$type(this.rooms.get(identity)))return;if(this.rooms.getLength()>0){var count=0;this.rooms.each(function(room){count++;this.leave(room.options.identity).addEvent('complete',function(){room.destroy();this.rooms.erase(room.options.identity);count--;if(count<=0){this.options.chatOptions=$merge(this.options.chatOptions,options);this.rooms.set(identity,new ChatHandler_Room(this,this.options.chatOptions));}}.bind(this));}.bind(this));return;}
this.options.chatOptions=$merge(this.options.chatOptions,options);this.rooms.set(identity,new ChatHandler_Room(this,this.options.chatOptions));this.chatstate=1;},stop:function(){this.state=false;},loop:function(){if(!this.state||(!this.imstate&&!this.chatstate)){this.loop.delay(this.options.delay,this);return;}
try{var request=this.ping();var completed=false;var cancelled=false;var timeoutFunctionDelay=false;request.addEvents({'complete':function(){completed=true;if(timeoutFunctionDelay){$clear(timeoutFunctionDelay);}
if(!cancelled){this.loop.delay(this.options.delay,this);}}.bind(this),'cancel':function(){cancelled=true;if(!completed){this.loop();}}.bind(this)});var timeoutFunc=function(){if(!completed&&!cancelled){request.cancel();}}.bind(this);timeoutFunctionDelay=timeoutFunc.delay(this.options.requestTimeout,this);}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}},ping:function(){this._log({'type':'cmd.ping'});var fresh=this.fresh;this.fresh=false;var extraData={};this.fireEvent('onPingBefore',extraData);var request=new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=ping',timeout:this.options.requestTimeout,noCache:true,data:$merge({'format':'json','fresh':fresh,'lastEventTime':this.lastEventTime||null},extraData),onSuccess:this.onPingResponse.bind(this)});request.send();return request;},join:function(room_id){this._log({'type':'cmd.join','room_id':room_id});var request=new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=join',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json','room_id':room_id},onSuccess:this.onJoinResponse.bindWithEvent(this,room_id)});request.send();return request;},leave:function(room_id){this._log({'type':'cmd.leave','room_id':room_id});var request=new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=leave',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json','room_id':room_id},onSuccess:this.onLeaveResponse.bindWithEvent(this,room_id)});request.send();return request;},send:function(room_id,message,callback){this._log({'type':'cmd.send','room_id':room_id,'message':message});return(new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=send',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json','room_id':room_id,'message':message},onSuccess:this.onSendResponse.bindWithEvent(this,[room_id,callback])})).send();},whisper:function(user_id,message,callback){this._log({'type':'cmd.whisper','user_id':user_id,'message':message});return(new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=whisper',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json','user_id':user_id,'message':message},onSuccess:this.onWhisperResponse.bindWithEvent(this,[user_id,callback])})).send();},whisperClose:function(user_id){this._log({'type':'cmd.whisperClose','user_id':user_id});return(new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=whisper-close',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json','user_id':user_id},onSuccess:this.onWhisperCloseResponse.bind(this)})).send();},status:function(state,type){this._log({'type':'cmd.status','state':state});return(new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=status',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json','status':state,'type':type},onSuccess:this.onStatusResponse.bind(this)})).send();},list:function(){this._log({'type':'cmd.list'});return(new Request.JSON({url:this.options.baseUrl+'?m=lite&module=chat&action=list',timeout:this.options.requestTimeout,noCache:true,data:{'format':'json'},onSuccess:this.onListResponse.bind(this)})).send();},onPingResponse:function(responseJSON){this._log({'type':'resp.ping','data':responseJSON});try{if($type(responseJSON)=='object'){if($type(responseJSON.lastEventTime)&&responseJSON.lastEventTime){this.lastEventTime=responseJSON.lastEventTime;}
if($type(responseJSON.users)=='object'){for(var x in responseJSON.users){var data=responseJSON.users[x];this.fireEvent('onEvent_presence',data);}}
if($type(responseJSON.whispers)=='object'){for(var x in responseJSON.whispers){this.fireEvent('onEvent_chat',responseJSON.whispers[x]);}}
if($type(responseJSON.events)=='object'){for(var x in responseJSON.events){var type=responseJSON.events[x].type;var eventName='onEvent_'+type;if(type=='chat'&&responseJSON.events[x].sender_id!=en4.user.viewer.id&&'object'==$type(soundManager)){try{soundManager.getSoundById('_chat_ding').play();}catch(e){}}
this.fireEvent(eventName,responseJSON.events[x]);}}}}
catch(e)
{this._log({type:'error',data:e});}
if($type(responseJSON.status)&&responseJSON.status){this.fireEvent('onPingSuccess',responseJSON);}else{this.fireEvent('onPingFailure',responseJSON);}},onJoinResponse:function(responseJSON,room_id){this._log({'type':'resp.join','data':responseJSON,'room_id':room_id});responseJSON.room_id=room_id;this.fireEvent('onJoin',responseJSON);},onLeaveResponse:function(responseJSON,room_id){this._log({'type':'resp.leave','data':responseJSON,'room_id':room_id});responseJSON.room_id=room_id;this.fireEvent('onLeave',responseJSON);},onSendResponse:function(responseJSON,room_id,callback){this._log({'type':'resp.send','data':responseJSON});if($type(responseJSON.status)&&responseJSON.status){this.fireEvent('onSendSuccess',responseJSON);}else{this.fireEvent('onSendFailure',responseJSON);}
if($type(callback)=='function'){callback(responseJSON,room_id);}},onWhisperResponse:function(responseJSON,user_id,callback){this._log({'type':'resp.whisper','data':responseJSON});if($type(responseJSON.status)&&responseJSON.status){this.fireEvent('onWhisperSuccess',responseJSON);}else{this.fireEvent('onWhisperFailure',responseJSON);}
if($type(callback)=='function'){callback(responseJSON,user_id);}},onWhisperCloseResponse:function(responseJSON){this._log({'type':'resp.whisperClose','data':responseJSON});this.fireEvent('onWhisperClose',responseJSON);},onStatusResponse:function(responseJSON){},onListResponse:function(responseJSON){this.fireEvent('onListRooms',responseJSON);},onReconfigure:function(data){if($type(data.delay)){this.options.delay=data.delay;}
if($type(data.chat_enabled)){if(parseInt(data.chat_enabled)==0){this.rooms.each(function(room){room.destroy();});(new Element('div',{'html':en4.core.language.translate('The chat room has been disabled by the site admin.')}).inject(this.container||$('global_content')||document.body));}
else
{}}
if($type(data.im_enabled)){if(parseInt(data.im_enabled)==0){if($type(this.im)){this.im.destroy();}}}},_log:function(object){if(!this.options.debug){return;}
try{if(typeof(console)&&$type(console)){console.log(object);}}catch(e){}},_supportsContentEditable:function(){return false;if($type(window.DetectMobileQuick)&&$type(window.DetectIpad)){if(DetectMobileQuick()||DetectIpad()){return false;}}
return(true==('contentEditable'in document.body));}});ChatHandler_Room=new Class({Implements:[Events,Options],options:{identity:false,rateMessages:10,rateTimeout:10000,maxLength:1023},handler:false,data:{},elements:{},rate:[],initialize:function(handler,options){this.handler=handler;this.room=new Hash();this.users=new Hash();this.elements=new Hash();this.setOptions(options);this.render();this.attach();this.handler.join(this.options.identity);Cookie.write('en4_chat_room_last',this.options.identity,{path:en4.core.basePath});},destroy:function(){this.detach();this.handler.chatstate=0;this.elements.container.destroy();},attach:function(){this.handler.addEvent('onPingBefore',this.onPingBefore.bind(this));this.handler.addEvent('onJoin',this.onJoin.bind(this));this.handler.addEvent('onLeave',this.onLeave.bind(this));this.handler.addEvent('onEvent_grouppresence',this.onPresence.bind(this));this.handler.addEvent('onEvent_groupchat',this.onGroupChat.bind(this));this.handler.addEvent('onListRooms',this.onListRooms.bind(this));},detach:function(){this.handler.removeEvent('onPingBefore',this.onPingBefore.bind(this));this.handler.removeEvent('onJoin',this.onJoin.bind(this));this.handler.removeEvent('onLeave',this.onLeave.bind(this));this.handler.removeEvent('onEvent_grouppresence',this.onPresence.bind(this));this.handler.removeEvent('onEvent_groupchat',this.onGroupChat.bind(this));this.handler.removeEvent('onListRooms',this.onListRooms.bind(this));},render:function(){var identity=this.options.identity;var self=this;if($('chat_container')){$('chat_container').destroy();}
this.elements.container=new Element('div',{'id':'chat_container_'+identity,'class':'chat_container'}).inject(this.container||$(this.options.container)||$('global_content')||document.body);this.elements.header=new Element('div',{'class':'chat_header'}).inject(this.elements.container);this.elements.headerTitle=new Element('div',{'class':'chat_header_title'}).inject(this.elements.header);var roomList=new Hash(this.options.roomList);if(roomList.getKeys().length>0){this.elements.roomsButton=new Element('span',{'class':'pulldown','events':{'click':function(){if(this.elements.roomsButton.hasClass('pulldown_active')){this.elements.roomsButton.removeClass('pulldown_active').addClass('pulldown');this.handler.list();}else{this.elements.roomsButton.removeClass('pulldown').addClass('pulldown_active');}}.bind(this)}}).inject(this.elements.header);var pulldownWrapper=new Element('div',{'class':'pulldown_contents_wrapper'}).inject(this.elements.roomsButton);var pulldownContainer=new Element('div',{'class':'pulldown_contents'}).inject(pulldownWrapper);this.elements.roomsList=new Element('ul',{}).inject(pulldownContainer);new Element('a',{'href':'javascript:void(0);','html':en4.core.language.translate('Browse Chatrooms')}).inject(this.elements.roomsButton);this.onListRooms(roomList);}
this.elements.usersWrapper=new Element('div',{'id':'chat_users_wrapper_'+identity,'class':'chat_users_wrapper'}).inject(this.elements.container);this.elements.usersList=new Element('ul',{'id':'chat_users_'+identity,'class':'chat_users chat_users_list'}).inject(this.elements.usersWrapper);this.elements.body=new Element('div',{'id':'chat_main_'+identity,'class':'chat_main chat_body'}).inject(this.elements.container);this.elements.messagesWrapper=new Element('div',{'id':'chat_messages_wrapper_'+identity,'class':'chat_messages_wrapper'}).inject(this.elements.body);this.elements.messagesList=new Element('ul',{'id':'chat_messages_'+identity,'class':'chat_messages chat_messages_list'}).inject(this.elements.messagesWrapper);this.elements.inputWrapper=new Element('div',{'id':'chat_input_wrapper_'+identity,'class':'chat_input_wrapper'}).inject(this.elements.body);if(this.handler._supportsContentEditable()){this.elements.input=new Element('div',{'class':'chat_input','html':(Browser.Engine.gecko?'<p><br /></p>':''),'events':{'keypress':function(event){if(event.key=='a'&&event.control){if(Browser.Engine.gecko){fix_gecko_select_all_contenteditable_bug(this,event);}}}}}).inject(this.elements.inputWrapper);this.elements.input.contentEditable=true;}else{this.elements.input=new Element('textarea',{'id':'chat_input_'+identity,'class':'chat_input'}).inject(this.elements.inputWrapper);}
this.elements.input.addEvents({'keypress':function(event){if(event.key=='enter'){event.preventDefault();this.send();}}.bind(this)});},send:function(){var message;if(this.handler._supportsContentEditable()){message=this.elements.input.get('html');if(Browser.Engine.webkit){this.elements.input.destroy();delete this.elements.input;this.elements.input=new Element('div',{'id':'chat_input','class':'chat_input','html':(Browser.Engine.gecko?'<p><br /></p>':'')}).inject(this.elements.inputWrapper);this.elements.input.contentEditable=true;this.elements.input.addEvents({'keypress':function(event){if(event.key=='enter'){event.preventDefault();this.send();}}.bind(this)});}else{this.elements.input.empty();this.elements.input.set('html','<p><br /></p>');}
this.elements.input.focus();message=message.stripTags();}else{message=this.elements.input.get('value');message=message.stripTags();this.elements.input.set('value','');}
message=message.trim();if(message==''){return;}
if(message.length>this.options.maxLength)message=message.substring(0,this.options.maxLength);this.rate=this.rate.filter(function(item){return $time()<item+this.options.rateTimeout;}.bind(this));if(this.rate.length>=this.options.rateMessages){this.onGroupChat({'room_id':this.options.identity,'system':1,'body':en4.core.language.translate('You are sending messages too quickly - please wait a few seconds and try again.')});return;}
this.rate.push($time());var ref={};if(message.indexOf('/')!==0){this.onGroupChat({room_id:this.options.identity,user_id:this.getSelf().identity,body:message},ref);}
this.handler.send(this.options.identity,message,function(responseJSON){if($type(ref.element)){ref.element.set('id','chat_message_'+responseJSON.message_id);}});},getSelf:function(){var self;this.users.each(function(data){if(data.self){self=data;}});if(!$type(self)){self={'identity':0,'title':en4.core.language.translate('You')};}
return self;},onPingBefore:function(data){data.rooms=[this.options.identity];},onJoin:function(data){this.handler._log({type:'chat.join',data:data});this.elements.usersList.empty();this.elements.messagesList.empty();if($type(data.room)=='object'){this.room=$H(data.room);}
if($type(data.users)=='object'){for(var x in data.users){this.onPresence(data.users[x]);}}
this.elements.headerTitle.set('html','<h3>'+en4.core.language.translate(data.room.title)+'</h3>');},onLeave:function(data){if(data.room_id!=this.options.identity)return;this.destroy();},onPresence:function(data){this.handler._log({type:'chat.presence',data:data,self:this.options.identity});if(data.room_id!=this.options.identity)return;if(parseInt(data.state)>0||!this.users.has(data.identity)){this.users.set(data.identity,data);}
var userElId='chat_room_'+this.options.identity+'_user_'+data.identity;var userEl=$(userElId);if(parseInt(data.state)>=1){if(!userEl){userEl=new Element('li',{'id':userElId,'html':'<span class="chat_user_photo"><img src="'+(data.photo||en4.core.staticBaseUrl+'application/modules/User/externals/images/nophoto_user_thumb_icon.png')+'" /></span>'+'<span class="chat_user_name"><a href="'+data.href+'" target="_blank">'+data.title+'</a></span>'}).inject(this.elements.usersList);if(!$type(data.stale)||!data.stale){this.onGroupChat({'system':1,'body':en4.core.language.translate('%1$s has joined the room.','<a href="'+data.href+'" target="_blank">'+data.title+'</a>'),'room_id':this.options.identity});}}
ChatHandler_Utility.applyStateClass(userEl.getElement('.chat_user_name'),parseInt(data.state));}else if(parseInt(data.state)<1){if(userEl){userEl.destroy();if(!$type(data.stale)||parseInt(data.stale)!=1){this.onGroupChat({'system':1,'body':en4.core.language.translate('%1$s has left the room.','<a href="'+data.href+'" target="_blank">'+data.title+'</a>'),'room_id':this.options.identity});}}}},onGroupChat:function(data,ref){this.handler._log({type:'chat.message',data:data});if(data.room_id!=this.options.identity)return;if($type(data.message_id)&&$('chat_message_'+data.message_id)){return;}
var body=data.body;if(body.length>this.options.maxLength)body=body.substring(0,this.options.maxLength);body=ChatHandler_Utility.replaceSmilies(body);var msgWrpr,tmpDivEl;if($type(data.system)&&parseInt(data.system)==1){msgWrpr=new Element('li').inject(this.elements.messagesList);tmpDivEl=new Element('div',{'class':'chat_message_info'}).inject(msgWrpr);var tmpMsgEl=(new Element('span',{'html':body,'class':'chat_message_info_body chat_message_info_body_system'}));tmpMsgEl.inject(tmpDivEl);tmpMsgEl.enableLinks();}
else
{var user=this.users.get(data.user_id);msgWrpr=new Element('li').inject(this.elements.messagesList);(new Element('div',{'class':'chat_message_photo','html':'<a href="'+user.href+'" target="_blank"><img src="'+(user.photo||en4.core.staticBaseUrl+'application/modules/User/externals/images/nophoto_user_thumb_icon.png')+'" alt="" /></a>'})).inject(msgWrpr);var tmpMsgEl=(new Element('div',{'class':'chat_message_info','html':'\n\
  <span class="chat_message_info_author"><a href="'+user.href+'" target="_blank">'+user.title+'</a></span>\n\
  <span class="chat_message_info_body">'+body+'</span>\n\
  '}));tmpMsgEl.inject(msgWrpr);tmpMsgEl.enableLinks();}
if($type(msgWrpr)&&$type(data.message_id)){msgWrpr.set('id','chat_message_'+data.message_id);}
if($type(ref)=='object'){ref.element=msgWrpr;}
this.elements.messagesWrapper.scrollTo(0,this.elements.messagesWrapper.getScrollSize().y);},onListRooms:function(data){if($type(data.rooms)){data=data.rooms;}
this.elements.roomsList.empty();var self=this;$H(data).each(function(room){new Element('li',{'html':en4.core.language.translate(room.title)+' ('+en4.core.language.translate(['%1$s person','%1$s people',room.people],room.people)+')','events':{'click':function(event){self.handler.startChat({identity:room.identity});}}}).inject(this.elements.roomsList);}.bind(this));},onReconfigure:function(data){if($type(data.chat_enabled)&&parseInt(data.chat_enabled)==0){var container=this.container;this.destroy();(new Element('div',{'html':en4.core.language.translate('The chat room has been disabled by the site admin.')}).inject(this.container||$('global_content')||document.body));}}});ChatHandler_Whispers=new Class({Implements:[Events,Options],options:{identity:false,rateMessages:10,rateTimeout:10000,maxLength:1023},handler:false,elements:{},itemOrder:[],rate:[],initialize:function(handler,options){this.handler=handler;this.items=new Hash();this.users=new Hash();this.elements=new Hash();this.setOptions(options);this.render();this.attach();},destroy:function(){this.detach();this.elements.container.destroy();this.handler.imstate=0;},attach:function(){this.handler.addEvent('onPingBefore',this.onPingBefore.bind(this));this.handler.addEvent('onEvent_presence',this.onPresence.bind(this));this.handler.addEvent('onEvent_chat',this.onChat.bind(this));window.addEvent('keypress',this.onCommand.bind(this));},detach:function(){this.handler.removeEvent('onPingBefore',this.onPingBefore.bind(this));this.handler.removeEvent('onEvent_presence',this.onPresence.bind(this));this.handler.removeEvent('onEvent_chat',this.onChat.bind(this));window.removeEvent('keypress',this.onCommand.bind(this));},getSelf:function(){var self;this.users.each(function(data){if(data.self){self=data;}});if(!$type(self)){self={'identity':0,'title':en4.core.language.translate('You')};}
return self;},render:function(){this.container=$(this.options.container)||$(document.body);if($('im_container')){$('im_container').destroy();}
this.elements.container=new Element('ul',{'id':'im_container'}).inject(this.container);this.items.settings=new ChatHandler_Whispers_UI_Settings(this,this.elements.container,{'name':'settings','uid':'settings','title':en4.core.language.translate('Settings'),'showClose':false});this.items.friends=new ChatHandler_Whispers_UI_Friends(this,this.elements.container,{'name':'friends','uid':'friends','title':en4.core.language.translate('Friends Online'),'showClose':false});this.itemOrder.push('friends');},open:function(identity,focus){var uid='convo'+identity;var user=this.users.get(identity);if(!user){return;};if(!$type(this.items[uid])){var name='convo';this.items[uid]=new ChatHandler_Whispers_UI_Conversation(this,this.elements.container,{'name':name,'uid':uid,'title':user.title,'identity':identity});this.itemOrder.push(uid);}
var item=this.items[uid];item.state(user.state);if(focus){item.focus();}
this.resize();},resize:function(){if(this.elements.container.getCoordinates().left<250){this.elements.container.addClass('im_container_crunched');}else{}},onPingBefore:function(data){data.im=(this.handler.imstate==1);},onPresence:function(data){this.handler._log({type:'im.presence',data:data});var user_id=data.identity;var state=parseInt(data.state);if(parseInt(data.state)>0||!this.users.has(user_id)){this.users.set(user_id,data);}
var uid='convo'+user_id;if($type(this.items[uid])){this.items[uid].onPresence(data);}},onChat:function(data){this.handler._log({'type':'im.chat','data':data});var uid='convo'+data.user_id;var name='convo';var user=this.users.get(data.sender_id);if(!user){return;};if(!$type(this.items[uid])){this.open(data.user_id);}
var item=this.items[uid];item.onChat(data,user);},onCommand:function(event){if(event.control&&event.alt&&event.key=='right'){this.seekItem(-1);}
if(event.control&&event.alt&&event.key=='left'){this.seekItem(1);}},seekItem:function(count){var activeIndex=0;this.itemOrder.each(function(uid,index){var item=this.items.get(uid);if(item.isVisible()){activeIndex=index;}}.bind(this));activeIndex+=count;if(activeIndex>=this.itemOrder.length)activeIndex-=this.itemOrder.length
if(activeIndex<0)activeIndex+=this.itemOrder.length
var item=this.items.get(this.itemOrder[activeIndex]);item.focus();}});ChatHandler_Whispers_UI_Abstract=new Class({Implements:[Events,Options],options:{name:'generic',uid:false,title:'Untitled',showClose:true,showHide:true,hiddenByDefault:true},handler:false,container:false,elements:{},initialize:function(handler,container,options){this.handler=handler;this.container=container;this.setOptions(options);this.render();this.attach();this.reposition();},destroy:function(){this.handler.itemOrder.erase(this.options.uid);this.detach();this.elements.main.destroy();},attach:function(){this.handler.addEvent('onItemShow',this.onOtherItemShow.bind(this));},detach:function(){this.handler.removeEvent('onItemShow',this.onOtherItemShow.bind(this));},render:function(){var name=this.options.name;var uid=this.options.uid;this.elements.main=new Element('li',{'class':'im_main im_main_'+name+' im_main_inactive'}).inject(this.container);if(uid)this.elements.main.set('id','im_main_'+uid);this.elements.menu=new Element('div',{'class':'im_menu_wrapper im_menu_'+name+'_wrapper','styles':{}}).inject(this.elements.main);if(uid)this.elements.menu.set('id','im_menu_'+uid+'_wrapper');this.elements.menuHead=new Element('div',{'class':'im_menu_head im_menu_'+name+'_head'}).inject(this.elements.menu);if(uid)this.elements.menuHead.set('id','im_menu_'+uid+'_head');this.elements.menuTitle=new Element('div',{'class':'im_menu_title im_menu_'+name+'_title','html':this.options.title}).inject(this.elements.menuHead);if(uid)this.elements.menuTitle.set('id','im_menu_'+uid+'_title');if(this.options.showHide){this.elements.menuHide=new Element('div',{'class':'im_menu_hide im_menu_'+name+'_hide'}).inject(this.elements.menuHead);if(uid)this.elements.menuHide.set('id','im_item_'+uid+'_hide');this.elements.menuHideLink=new Element('a',{'href':'javascript:void(0);','class':'im_menu_hidelink im_menu_'+name+'_hidelink','html':'<img src="'+en4.core.staticBaseUrl+'application/modules/Chat/externals/images/window_hide.png" />','events':{'click':this.hide.bind(this)}}).inject(this.elements.menuHide);if(uid)this.elements.menuHideLink.set('id','im_menu_'+uid+'_hidelink');}
this.elements.menuHide=new Element('div',{});this.elements.menuBody=new Element('ul',{'class':'im_menu_body im_menu_'+name+'_body'}).inject(this.elements.menu);if(uid)this.elements.menuBody.set('id','im_menu_'+uid+'_body');this.elements.item=new Element('div',{'class':'im_item im_item_'+name,'events':{'click':this.toggle.bind(this)}}).inject(this.elements.main);if(uid)this.elements.item.set('id','im_item_'+uid);this.elements.itemTitle=new Element('span',{'class':'im_item_title im_item_'+name+'_title','html':this.options.title}).inject(this.elements.item);if(uid)this.elements.itemTitle.set('id','im_item_'+uid+'_title');if(this.options.showClose){this.elements.itemClose=new Element('span',{'class':'im_item_close im_item_'+name+'_close'}).inject(this.elements.item);if(uid)this.elements.itemClose.set('id','im_item_'+uid+'_close');this.elements.itemCloseLink=new Element('a',{'href':'javascript:void(0);','class':'im_item_closelink im_item_'+name+'_closelink','html':'<img src="'+en4.core.staticBaseUrl+'application/modules/Chat/externals/images/window_close.png" />','events':{'click':this.close.bind(this)}}).inject(this.elements.itemClose);if(uid)this.elements.itemCloseLink.set('id','im_item_'+uid+'_closelink');}
if(Cookie.read('en4_chat_whispers_active',{path:en4.core.basePath})==this.options.uid){this.show();}else if(this.options.hiddenByDefault){this.hide();}
this.handler.resize();},reposition:function(){this.elements.menu.setStyle('margin-top',0-this.elements.menu.getSize().y);},getBody:function(){return this.elements.menuBody;},isVisible:function(){return!this.elements.main.hasClass('im_main_inactive');},show:function(e){if($type(e)){e.stop();}
if(!this.isVisible()){this.handler.fireEvent('onItemShow',this);Cookie.write('en4_chat_whispers_active',this.options.uid,{path:en4.core.basePath});this.elements.main.addClass('im_main_active').removeClass('im_main_inactive');this.reposition();}},focus:function(e){if($type(e)){e.stop();}
this.show();},hide:function(e){if($type(e)){e.stop();}
if(this.isVisible()){if(Cookie.read('en4_chat_whispers_active',{path:en4.core.basePath})==this.options.uid){Cookie.dispose('en4_chat_whispers_active',{path:en4.core.basePath});}
this.elements.main.addClass('im_main_inactive').removeClass('im_main_active');this.handler.fireEvent('onItemHide',this);}},toggle:function(e){if($type(e)){e.stop();}
if(!this.isVisible()){this.show();}else{this.hide();}
this.handler.resize();},close:function(e){if($type(e)){e.stop();}
if(this.isVisible()){if(Cookie.read('en4_chat_whispers_active',{path:en4.core.basePath})==this.options.uid){Cookie.dispose('en4_chat_whispers_active',{path:en4.core.basePath});}}
this.destroy();this.handler.resize();delete this.handler.items[this.options.uid];},onOtherItemShow:function(item){if(item.options.uid!=this.options.uid){this.hide();}}});ChatHandler_Whispers_UI_Settings=new Class({Extends:ChatHandler_Whispers_UI_Abstract,render:function(){var name=this.options.name;var uid=this.options.uid;this.elements.main=new Element('li',{'class':'im_main im_main_'+name+' im_main_settings_online'}).inject(this.container);if(uid)this.elements.main.set('id','im_main_'+uid);this.elements.tooltip=new Element('span',{'class':'im_item_tooltip_settings','html':en4.core.language.translate('Go Offline')}).inject(this.elements.main);this.elements.item=new Element('span',{'class':'im_item im_item_'+name,'events':{'click':this.toggleOnline.bind(this)}}).inject(this.elements.main);if(uid)this.elements.item.set('id','im_item_'+uid);this.elements.itemTitle=new Element('span',{'class':'im_item_title im_item_'+name+'_title','html':'&nbsp;'}).inject(this.elements.item);if(uid)this.elements.itemTitle.set('id','im_item_'+uid+'_title');},toggleOnline:function(state){if(typeof(state)=='object')state=null;state=state||(1-this.handler.handler.imstate);if(state==0){this.elements.main.addClass('im_main_settings_offline').removeClass('im_main_settings_online');this.handler.handler.imstate=0;this.handler.handler.status(0,'im');this.elements.tooltip.set('text',en4.core.language.translate('Open Chat'));this.handler.items.each(function(item){if(!item.elements.main.hasClass('im_main_'+this.options.name)){item.elements.main.setStyle('display','none');}}.bind(this));}else{this.elements.main.addClass('im_main_settings_online').removeClass('im_main_settings_offline');this.handler.handler.imstate=1;this.handler.handler.status(1,'im');this.elements.tooltip.set('text',en4.core.language.translate('Go Offline'));this.handler.items.each(function(item){if(!item.elements.main.hasClass('im_main_'+this.options.name)){item.elements.main.setStyle('display','');item.reposition();}}.bind(this));}
Cookie.write('en4_chat_imstate',this.handler.handler.imstate,{path:en4.core.basePath});},reposition:$empty,show:$empty,hide:$empty,toggle:$empty,close:$empty,isVisible:$empty});ChatHandler_Whispers_UI_Friends=new Class({Extends:ChatHandler_Whispers_UI_Abstract,attach:function(){this.parent();this.handler.handler.addEvent('onEvent_presence',this.onPresence.bind(this));},detach:function(){this.parent();this.handler.handler.removeEvent('onEvent_presence',this.onPresence.bind(this));},render:function(){this.parent();this.elements.menuCount=new Element('span',{'html':'(0)'}).inject(this.elements.menuTitle);this.elements.itemCount=new Element('span',{'html':'(0)'}).inject(this.elements.itemTitle);this.elements.menuBody.setStyle('display','none');new Element('div',{'class':'im_menu_'+this.options.name+'_none','html':this.handler.options.memberIm?en4.core.language.translate('No members are online.'):en4.core.language.translate('None of your friends are online.')}).inject(this.elements.menu);},onPresence:function(data){var user_id=data.identity;var bodyEl=this.getBody();var userElId='im_user_'+user_id;var userEl=$(userElId);if(data.self==1){return;}
if(parseInt(data.state)>=1){if(!$type(userEl)){userEl=new Element('li',{'id':userElId,'events':{'click':function(){this.handler.open(user_id,true);}.bind(this)},'html':'\n\
<span class="im_menu_friends_photo">\n\
  <img src="'+(data.photo||en4.core.staticBaseUrl+'application/modules/User/externals/images/nophoto_user_thumb_icon.png')+'" alt="" />\n\
</span>\n\
<span class="im_menu_friends_name">\n\
  '+data.title+'\n\
</span>\n\
'}).inject(bodyEl);}
var nameEl=userEl.getElement('.im_menu_friends_name');ChatHandler_Utility.applyStateClass(nameEl,parseInt(data.state));}else{if(userEl){userEl.destroy();}}
this.elements.menuCount.set('html','('+bodyEl.getChildren().length+')')
this.elements.itemCount.set('html','('+bodyEl.getChildren().length+')')
var childrenLength=bodyEl.getChildren().length;var noFriendsEl=this.elements.menu.getElement('.im_menu_'+this.options.name+'_none');if(childrenLength<1&&!noFriendsEl){this.elements.menuBody.setStyle('display','none');new Element('div',{'class':'im_menu_'+this.options.name+'_none','html':this.handler.options.memberIm?en4.core.language.translate('No members are online.'):en4.core.language.translate('None of your friends are online.')}).inject(this.elements.menu);}else if(childrenLength>=1&&noFriendsEl){this.elements.menuBody.setStyle('display','');noFriendsEl.destroy();}
this.reposition();}});ChatHandler_Whispers_UI_Conversation=new Class({Extends:ChatHandler_Whispers_UI_Abstract,flasher:false,unread:0,initialize:function(handler,container,options){this.parent(handler,container,options);this.unread=Cookie.read('en4_whispers_unread_'+this.options.uid,{path:en4.core.basePath})||0;this.checkFlasher();},attach:function(){this.parent();},detach:function(){this.parent();if(this.flasher)$clear(this.flasher);},render:function(){this.parent();this.elements.menuFooter=new Element('div',{'class':'im_menu_footer im_menu_'+this.options.name+'_footer'}).inject(this.elements.menu);if(this.options.uid)this.elements.menuFooter.set('id','im_menu_'+this.options.uid+'_footer');if(this.handler.handler._supportsContentEditable()){this.elements.menuInput=new Element('div',{'class':'im_menu_input im_menu_'+this.options.name+'_input','html':'<p><br /></p>','contentEditable':true,'events':{'keypress':function(event){if(event.key=='a'&&event.control){if(Browser.Engine.gecko){fix_gecko_select_all_contenteditable_bug(this,event);}}}}}).inject(this.elements.menuFooter);}else{this.elements.menuInput=new Element('textarea',{'class':'im_menu_input im_menu_'+this.options.name+'_input'}).inject(this.elements.menuFooter);if(this.options.uid)this.elements.menuInput.set('id','im_menu_'+this.options.uid+'_input');}
this.elements.menuInput.addEvents({'keypress':function(event){if(event.key=='enter'){event.preventDefault();this.send();}}.bind(this)});},focus:function(){this.parent();this.elements.menuInput.focus();this.elements.menuBody.scrollTo(0,this.elements.menuBody.getScrollSize().y);},show:function(e){this.parent(e);this.unread=0;Cookie.dispose('en4_whispers_unread_'+this.options.uid,{path:en4.core.basePath});if(this.flasher){$clear(this.flasher);this.flasher=false;this.unread=0;Cookie.write('en4_whispers_unread_'+this.options.uid,this.unread,{path:en4.core.basePath});this.elements.main.removeClass('im_main_unread');}
if($type(this.elements.menuInput)){this.elements.menuInput.focus();}
if($type(this.elements.menuBody)){this.elements.menuBody.scrollTo(0,this.elements.menuBody.getScrollSize().y);}},send:function(){var message;var data=this.handler.getSelf();if(this.handler.handler._supportsContentEditable()){message=this.elements.menuInput.get('html');if(Browser.Engine.webkit){this.elements.menuInput.destroy();delete this.elements.menuInput;this.elements.menuInput=new Element('div',{'class':'im_menu_input im_menu_'+this.options.name+'_input','html':'<p><br /></p>','contentEditable':true}).inject(this.elements.menuFooter);this.elements.menuInput.addEvents({'keypress':function(event){if(event.key=='enter'){event.preventDefault();this.send();}}.bind(this)});}else{this.elements.menuInput.empty();this.elements.menuInput.set('html','<p><br /></p>');}
this.elements.menuInput.focus();message=message.stripTags();}else{message=this.elements.menuInput.get('value');message=message.stripTags();this.elements.menuInput.set('value','');}
message=message.trim();if(message==''){return;}
if(message.length>this.handler.options.maxLength)message=message.substring(0,this.handler.options.maxLength);this.handler.rate=this.handler.rate.filter(function(item){return $time()<item+this.handler.options.rateTimeout;}.bind(this));if(this.handler.rate.length>=this.handler.options.rateMessages){this.onChat({'system':true,'body':en4.core.language.translate('You are sending messages too quickly - please wait a few seconds and try again.')});return;}
this.handler.rate.push($time());var ref={};this.onChat({'body':message},data,ref);this.handler.handler.whisper(this.options.identity,message,function(responseJSON){if($type(ref.element)){ref.element.set('id','chat_whisper_'+responseJSON.whisper_id);}});},state:function(state){ChatHandler_Utility.applyStateClass(this.elements.itemTitle,parseInt(state));},close:function(e,force){if($type(e)){e.stop();}
if(force){this.parent();}else{this.handler.handler.whisperClose(this.options.identity).addEvent('complete',function(){this.close(null,true);}.bind(this));}},onChat:function(data,user,ref){this.handler.handler._log({'type':'ui.conov.chat','data':data,'user':user});if($type(data.whisper_id)&&$('chat_whisper_'+data.whisper_id)){return;}
var messageEl;var body=data.body;body=ChatHandler_Utility.replaceSmilies(body);if(body.length>this.handler.options.maxLength)body=body.substring(0,this.handler.options.maxLength);if($type(data.system)&&data.system){messageEl=(new Element('li')).inject(this.elements.menuBody);var tmpMsgEl=(new Element('span',{'class':'im_convo_messages_body','html':body}).inject(messageEl));tmpMsgEl.enableLinks();}
else
{if(!this.isVisible()&&!data.stale){this.unread++;Cookie.write('en4_whispers_unread_'+this.options.uid,this.unread,{path:en4.core.basePath});this.checkFlasher();}
messageEl=(new Element('li')).inject(this.elements.menuBody);if($type(data.whisper_id)){messageEl.set('id','chat_whisper_'+data.whisper_id);}
(new Element('span',{'class':'im_convo_messages_author','html':user.title}).inject(messageEl));var tmpMsgEl=(new Element('span',{'class':'im_convo_messages_body','html':body}).inject(messageEl));tmpMsgEl.enableLinks();}
if($type(messageEl)&&$type(ref)=='object'){ref.element=messageEl;}
if(this.isVisible()){this.elements.menuBody.scrollTo(0,this.elements.menuBody.getScrollSize().y);}},onPresence:function(data){this.state(data.state);},checkFlasher:function(){if(!this.flasher&&this.unread>0){this.flasher=(function(){if(this.elements.main.hasClass('im_main_unread')){this.elements.main.removeClass('im_main_unread');}else{this.elements.main.addClass('im_main_unread');}}).periodical(500,this);}}});ChatHandler_Utility={states:$H({0:'offline',1:'online',2:'idle',3:'away'}),classPrefix:'im_state_',getStateClass:function(state){return this.classPrefix+this.states[state];},applyStateClass:function(element,state){this.states.each(function(stateName){element.removeClass(this.classPrefix+stateName);}.bind(this));element.addClass(this.getStateClass(state));},imageSpec:en4.core.staticBaseUrl+'application/modules/Chat/externals/images/smilies/:name:.png',smilies:$H({':?':'confused',':-?':'confused','B)':'cool','8)':'cool','B-)':'cool','8-)':'cool',':\'(':'cry','=\'(':'cry',':"(':'cry',':_(':'cry',':#':'embarrassed',':-#':'embarrassed',':S':'embarrassed',':-S':'embarrassed',':$':'embarrassed',':-$':'embarrassed','^^;':'embarrassed','^_^;':'embarrassed','-_-;':'embarrassed',':(':'frown',':-(':'frown','=(':'frown','=-(':'frown',':D':'grin',':-D':'grin','=D':'grin','lol':'lol','^o^':'lol',':&':'mad',':-&':'mad','>(':'mad','>:(':'mad','>=(':'mad',':&amp;':'mad',':-&amp;':'mad','*:|':'nervous',':|':'neutral','-_-':'neutral','-.-':'neutral',':)':'smile',':-)':'smile',':>':'smile','=)':'smile','^_^':'smile','^.^':'smile',':P':'tongue',':-P':'tongue',';)':'wink',';-)':'wink',';>':'wink'}),replaceSmilies:function(text){this.smilies.each(function(name,val){if(text.indexOf(val)<0)return;var parts=text.split(val);var image='<img src="'+this.imageSpec.replace(':name:',name).escapeQuotes()+'" alt="'+val.escapeQuotes()+'" />';text=parts.join(image);}.bind(this));return text;}};})();
;var isIphone=false;var isTierIphone=false;var isTierRichCss=false;var isTierGenericMobile=false;var engineWebKit="webkit";var deviceIphone="iphone";var deviceIpod="ipod";var deviceIpad="ipad";var deviceMacPpc="macintosh";var deviceAndroid="android";var deviceGoogleTV="googletv";var deviceNuvifone="nuvifone";var deviceSymbian="symbian";var deviceS60="series60";var deviceS70="series70";var deviceS80="series80";var deviceS90="series90";var deviceWinPhone7="windows phone os 7";var deviceWinMob="windows ce";var deviceWindows="windows";var deviceIeMob="iemobile";var devicePpc="ppc";var enginePie="wm5 pie";var deviceBB="blackberry";var vndRIM="vnd.rim";var deviceBBStorm="blackberry95";var deviceBBBold="blackberry97";var deviceBBTour="blackberry96";var deviceBBCurve="blackberry89";var deviceBBTorch="blackberry 98";var devicePalm="palm";var deviceWebOS="webos";var engineBlazer="blazer";var engineXiino="xiino";var deviceKindle="kindle";var vndwap="vnd.wap";var wml="wml";var deviceBrew="brew";var deviceDanger="danger";var deviceHiptop="hiptop";var devicePlaystation="playstation";var deviceNintendoDs="nitro";var deviceNintendo="nintendo";var deviceWii="wii";var deviceXbox="xbox";var deviceArchos="archos";var engineOpera="opera";var engineNetfront="netfront";var engineUpBrowser="up.browser";var engineOpenWeb="openweb";var deviceMidp="midp";var uplink="up.link";var engineTelecaQ='teleca q';var devicePda="pda";var mini="mini";var mobile="mobile";var mobi="mobi";var maemo="maemo";var maemoTablet="tablet";var linux="linux";var qtembedded="qt embedded";var mylocom2="com2";var manuSonyEricsson="sonyericsson";var manuericsson="ericsson";var manuSamsung1="sec-sgh";var manuSony="sony";var manuHtc="htc";var svcDocomo="docomo";var svcKddi="kddi";var svcVodafone="vodafone";var disUpdate="update";var uagent=navigator.userAgent.toLowerCase();function DetectIphone()
{if(uagent.search(deviceIphone)>-1)
{if(DetectIpad()||DetectIpod())
return false;else
return true;}
else
return false;}
function DetectIpod()
{if(uagent.search(deviceIpod)>-1)
return true;else
return false;}
function DetectIpad()
{if(uagent.search(deviceIpad)>-1&&DetectWebkit())
return true;else
return false;}
function DetectIphoneOrIpod()
{if(uagent.search(deviceIphone)>-1||uagent.search(deviceIpod)>-1)
return true;else
return false;}
function DetectAndroid()
{if(uagent.search(deviceAndroid)>-1)
return true;else
return false;}
function DetectAndroidWebKit()
{if(DetectAndroid()&&DetectWebkit())
return true;else
return false;}
function DetectGoogleTV()
{if(uagent.search(deviceGoogleTV)>-1)
return true;else
return false;}
function DetectWebkit()
{if(uagent.search(engineWebKit)>-1)
return true;else
return false;}
function DetectS60OssBrowser()
{if(DetectWebkit())
{if((uagent.search(deviceS60)>-1||uagent.search(deviceSymbian)>-1))
return true;else
return false;}
else
return false;}
function DetectSymbianOS()
{if(uagent.search(deviceSymbian)>-1||uagent.search(deviceS60)>-1||uagent.search(deviceS70)>-1||uagent.search(deviceS80)>-1||uagent.search(deviceS90)>-1)
return true;else
return false;}
function DetectWindowsPhone7()
{if(uagent.search(deviceWinPhone7)>-1)
return true;else
return false;}
function DetectWindowsMobile()
{if(DetectWindowsPhone7())
return false;if(uagent.search(deviceWinMob)>-1||uagent.search(deviceIeMob)>-1||uagent.search(enginePie)>-1)
return true;if((uagent.search(devicePpc)>-1)&&!(uagent.search(deviceMacPpc)>-1))
return true;if(uagent.search(manuHtc)>-1&&uagent.search(deviceWindows)>-1)
return true;else
return false;}
function DetectBlackBerry()
{if(uagent.search(deviceBB)>-1)
return true;if(uagent.search(vndRIM)>-1)
return true;else
return false;}
function DetectBlackBerryWebKit()
{if(uagent.search(deviceBB)>-1&&uagent.search(engineWebKit)>-1)
return true;else
return false;}
function DetectBlackBerryTouch()
{if((uagent.search(deviceBBStorm)>-1)||(uagent.search(deviceBBTorch)>-1))
return true;else
return false;}
function DetectBlackBerryHigh()
{if(DetectBlackBerryWebKit())
return false;if(DetectBlackBerry())
{if(DetectBlackBerryTouch()||uagent.search(deviceBBBold)>-1||uagent.search(deviceBBTour)>-1||uagent.search(deviceBBCurve)>-1)
return true;else
return false;}
else
return false;}
function DetectBlackBerryLow()
{if(DetectBlackBerry())
{if(DetectBlackBerryHigh())
return false;else
return true;}
else
return false;}
function DetectPalmOS()
{if(uagent.search(devicePalm)>-1||uagent.search(engineBlazer)>-1||uagent.search(engineXiino)>-1)
{if(DetectPalmWebOS())
return false;else
return true;}
else
return false;}
function DetectPalmWebOS()
{if(uagent.search(deviceWebOS)>-1)
return true;else
return false;}
function DetectGarminNuvifone()
{if(uagent.search(deviceNuvifone)>-1)
return true;else
return false;}
function DetectSmartphone()
{if(DetectIphoneOrIpod())
return true;if(DetectS60OssBrowser())
return true;if(DetectSymbianOS())
return true;if(DetectWindowsMobile())
return true;if(DetectWindowsPhone7())
return true;if(DetectAndroid())
return true;if(DetectBlackBerry())
return true;if(DetectPalmWebOS())
return true;if(DetectPalmOS())
return true;if(DetectGarminNuvifone())
return true;return false;};function DetectArchos()
{if(uagent.search(deviceArchos)>-1)
return true;else
return false;}
function DetectBrewDevice()
{if(uagent.search(deviceBrew)>-1)
return true;else
return false;}
function DetectDangerHiptop()
{if(uagent.search(deviceDanger)>-1||uagent.search(deviceHiptop)>-1)
return true;else
return false;}
function DetectMaemoTablet()
{if(uagent.search(maemo)>-1)
return true;if(uagent.search(maemoTablet)>-1&&uagent.search(linux)>-1)
return true;else
return false;}
function DetectSonyMylo()
{if(uagent.search(manuSony)>-1)
{if(uagent.search(qtembedded)>-1||uagent.search(mylocom2)>-1)
return true;else
return false;}
else
return false;}
function DetectOperaMobile()
{if(uagent.search(engineOpera)>-1)
{if(uagent.search(mini)>-1||uagent.search(mobi)>-1)
return true;else
return false;}
else
return false;}
function DetectSonyPlaystation()
{if(uagent.search(devicePlaystation)>-1)
return true;else
return false;};function DetectNintendo()
{if(uagent.search(deviceNintendo)>-1||uagent.search(deviceWii)>-1||uagent.search(deviceNintendoDs)>-1)
return true;else
return false;};function DetectXbox()
{if(uagent.search(deviceXbox)>-1)
return true;else
return false;};function DetectGameConsole()
{if(DetectSonyPlaystation())
return true;if(DetectNintendo())
return true;if(DetectXbox())
return true;else
return false;};function DetectKindle()
{if(uagent.search(deviceKindle)>-1)
return true;else
return false;}
function DetectMobileQuick()
{if(DetectIpad())
return false;if(DetectSmartphone())
return true;if(uagent.search(deviceMidp)>-1||DetectBrewDevice())
return true;if(DetectOperaMobile())
return true;if(uagent.search(engineNetfront)>-1)
return true;if(uagent.search(engineUpBrowser)>-1)
return true;if(uagent.search(engineOpenWeb)>-1)
return true;if(DetectDangerHiptop())
return true;if(DetectMaemoTablet())
return true;if(DetectArchos())
return true;if((uagent.search(devicePda)>-1)&&(uagent.search(disUpdate)<0))
return true;if(uagent.search(mobile)>-1)
return true;if(DetectKindle())
return true;return false;};function DetectMobileLong()
{if(DetectMobileQuick())
return true;if(DetectGameConsole())
return true;if(DetectSonyMylo())
return true;if(uagent.search(manuSamsung1)>-1||uagent.search(manuSonyEricsson)>-1||uagent.search(manuericsson)>-1)
return true;if(uagent.search(svcDocomo)>-1)
return true;if(uagent.search(svcKddi)>-1)
return true;if(uagent.search(svcVodafone)>-1)
return true;return false;};function DetectTierIphone()
{if(DetectIphoneOrIpod())
return true;if(DetectAndroid())
return true;if(DetectAndroidWebKit())
return true;if(DetectWindowsPhone7())
return true;if(DetectBlackBerryWebKit())
return true;if(DetectPalmWebOS())
return true;if(DetectGarminNuvifone())
return true;if(DetectMaemoTablet())
return true;else
return false;};function DetectTierRichCss()
{if(DetectMobileQuick())
{if(DetectTierIphone())
return false;if(DetectWebkit())
return true;if(DetectS60OssBrowser())
return true;if(DetectBlackBerryHigh())
return true;if(DetectWindowsMobile())
return true;if(uagent.search(engineTelecaQ)>-1)
return true;else
return false;}
else
return false;};function DetectTierOtherPhones()
{if(DetectMobileLong())
{if(DetectTierIphone())
return false;if(DetectTierRichCss())
return false;else
return true;}
else
return false;};