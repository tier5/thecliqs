(function(){var $='id'in document?document.id:window.$;en4.activity={load:function(next_id,subject_guid){if(en4.core.request.isRequestActive())return;$('feed_viewmore').style.display='none';$('feed_loading').style.display='';en4.core.request.send(new Request.HTML({url:en4.core.baseUrl+'activity/widget/feed',data:{'maxid':next_id,'feedOnly':true,'nolayout':true,'subject':subject_guid}}),{'element':$('activity-feed'),'updateHtmlMode':'append'});},like:function(action_id,comment_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/like',data:{format:'json',action_id:action_id,comment_id:comment_id,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},unlike:function(action_id,comment_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/unlike',data:{format:'json',action_id:action_id,comment_id:comment_id,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},comment:function(action_id,body){if(body.trim()=='')
{return;}
en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/comment',data:{format:'json',action_id:action_id,body:body,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},attachComment:function(formElement){var bind=this;formElement.addEvent('submit',function(event){event.stop();bind.comment(formElement.action_id.value,formElement.body.value);});},viewComments:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/viewComment',data:{format:'json',action_id:action_id,nolist:true}}),{'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});},viewLikes:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/viewLike',data:{format:'json',action_id:action_id,nolist:true}}),{'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});},hideNotifications:function(reset_text){en4.core.request.send(new Request.JSON({'url':en4.core.baseUrl+'activity/notifications/hide'}));$('updates_toggle').set('html',reset_text).removeClass('new_updates');if($('notifications_main')){var notification_children=$('notifications_main').getChildren('li');notification_children.each(function(el){el.setAttribute('class','');});}
if($('notifications_menu')){var notification_children=$('notifications_menu').getChildren('li');notification_children.each(function(el){el.setAttribute('class','');});}},updateNotifications:function(){if(en4.core.request.isRequestActive())return;en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/update',data:{format:'json'},onSuccess:this.showNotifications.bind(this)}));},showNotifications:function(responseJSON){if(responseJSON.notificationCount>0){$('updates_toggle').set('html',responseJSON.text).addClass('new_updates');}},markRead:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/test',data:{format:'json','actionid':action_id}}));},cometNotify:function(responseObject){$('core_menu_mini_menu_updates').style.display='';$('core_menu_mini_menu_updates_count').innerHTML=responseObject.text;}};NotificationUpdateHandler=new Class({Implements:[Events,Options],options:{debug:false,baseUrl:'/',identity:false,delay:5000,minDelay:5000,maxDelay:600000,delayFactor:1.5,admin:false,idleTimeout:600000,last_id:0,subject_guid:null},state:true,activestate:1,fresh:true,lastEventTime:false,title:document.title,initialize:function(options){this.setOptions(options);this.options.minDelay=this.options.delay;},start:function(){this.state=true;this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this.activestate=1;this.state=true;}.bind(this),'onStateIdle':function(){this.activestate=0;this.state=false;}.bind(this)});this.loop();},stop:function(){this.state=false;},updateNotifications:function(){if(en4.core.request.isRequestActive())return;en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/update',data:{format:'json'},onSuccess:this.showNotifications.bind(this)}));},showNotifications:function(responseJSON){if(responseJSON.notificationCount>0){this.options.delay=this.options.minDelay;$('updates_toggle').set('html',responseJSON.text).addClass('new_updates');}else{this.options.delay=Math.min(this.options.maxDelay,this.options.delayFactor*this.options.delay);}},loop:function(){if(!this.state){this.loop.delay(this.options.delay,this);return;}
try{this.updateNotifications().addEvent('complete',function(){this.loop.delay(this.options.delay,this);}.bind(this));}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}},_log:function(object){if(!this.options.debug){return;}
try{if(typeof(console)&&$type(console)){console.log(object);}}catch(e){}}});en4.activity.compose={composers:{},register:function(object){name=object.getName();this.composers[name]=object;},deactivate:function(){for(var x in this.composers){this.composers[x].deactivate();}
return this;}};en4.activity.compose.icompose=new Class({Implements:[Events,Options],name:false,element:false,options:{},initialize:function(element,options){this.element=$(element);this.setOptions(options);},getName:function(){return this.name;},activate:function(){en4.activity.compose.deactivate();},deactivate:function(){}});ActivityUpdateHandler=new Class({Implements:[Events,Options],options:{debug:true,baseUrl:'/',identity:false,delay:5000,admin:false,idleTimeout:600000,last_id:0,next_id:null,subject_guid:null,showImmediately:false},state:true,activestate:1,fresh:true,lastEventTime:false,title:document.title,initialize:function(options){this.setOptions(options);},start:function(){this.state=true;this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this._log('activity loop onStateActive');this.activestate=1;this.state=true;}.bind(this),'onStateIdle':function(){this._log('activity loop onStateIdle');this.activestate=0;this.state=false;}.bind(this)});this.loop();},stop:function(){this.state=false;},checkFeedUpdate:function(action_id,subject_guid){if(en4.core.request.isRequestActive())return;function getAllElementsWithAttribute(attribute){var matchingElements=[];var values=[];var allElements=document.getElementsByTagName('*');for(var i=0;i<allElements.length;i++){if(allElements[i].getAttribute(attribute)){matchingElements.push(allElements[i]);values.push(allElements[i].getAttribute(attribute));}}
return values;}
var list=getAllElementsWithAttribute('data-activity-feed-item');this.options.last_id=Math.max.apply(Math,list);min_id=this.options.last_id+1;var req=new Request.HTML({url:en4.core.baseUrl+'widget/index/name/activity.feed',data:{'format':'html','minid':min_id,'feedOnly':true,'nolayout':true,'subject':this.options.subject_guid,'getUpdate':true}});en4.core.request.send(req,{'element':$('activity-feed'),'updateHtmlMode':'prepend'});req.addEvent('complete',function(){(function(){if(this.options.showImmediately&&$('feed-update').getChildren().length>0){$('feed-update').setStyle('display','none');$('feed-update').empty();this.getFeedUpdate(this.options.next_id);}}).delay(50,this);}.bind(this));if(localStorage){var pageTitle=document.title;var feed=document.getElementById('activity-feed');var items=feed.getElementsByTagName("li");var itemObject={};var c=0;for(var i=0;i<items.length;++i){if(items[i].getAttribute('data-activity-feed-item')!=null){var itemId=items[i].getAttribute('data-activity-feed-item');itemObject[c]={id:itemId,content:document.getElementById('activity-item-'+itemId).innerHTML};c++;}}
var activityFeedJSON=JSON.stringify(itemObject);localStorage.setItem(pageTitle+'-activity-feed-widget',activityFeedJSON);}
if(localStorage.getItem(pageTitle+'-activity-feed-widget')){var storedFeedJSON=localStorage.getItem(pageTitle+'-activity-feed-widget');var storedObj=eval("("+storedFeedJSON+")");}
return req;},getFeedUpdate:function(last_id){if(en4.core.request.isRequestActive())return;var min_id=this.options.last_id+1;this.options.last_id=last_id;document.title=this.title;var req=new Request.HTML({url:en4.core.baseUrl+'widget/index/name/activity.feed',data:{'format':'html','minid':min_id,'feedOnly':true,'nolayout':true,'getUpdate':true,'subject':this.options.subject_guid}});en4.core.request.send(req,{'element':$('activity-feed'),'updateHtmlMode':'prepend'});return req;},loop:function(){this._log('activity update loop start');if(!this.state){this.loop.delay(this.options.delay,this);return;}
try{this.checkFeedUpdate().addEvent('complete',function(){try{this._log('activity loop req complete');this.loop.delay(this.options.delay,this);}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}}.bind(this));}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}
this._log('activity update loop stop');},_log:function(object){if(!this.options.debug){return;}
try{if('console'in window&&typeof(console)&&'log'in console){console.log(object);}}catch(e){}}});})();;var my_location={my_lat:'',my_lon:'',my_request:'',my_map:'',my_url:'',my_marker:'',my_location_page_num:1,my_location_address:'',init:function(myurl){var self=this;self.my_url=myurl;self.my_map=new google.maps.Map(document.getElementById("my_map_canvas"),{mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:false,center:new google.maps.LatLng(37.0902400,-95.7128910),zoom:3});self.my_marker=new google.maps.Marker({map:self.my_map,animation:google.maps.Animation.BOUNCE,html:'My Location!',title:'My Location!'});},show_pages:function(markers,bounds){var self=this;var marker;if(markers.length==0){return false;}
var infoWindow=new google.maps.InfoWindow({content:''});for(var i=0;i<markers.length;i++)
{marker=markers[i];var point=new google.maps.LatLng(marker.lat,marker.lng);var marker_obj=new google.maps.Marker({position:point,map:self.my_map});marker_obj.html='<table width="500px"><tr valign="top"><td width="110px"><img src="'+marker.pages_photo+'" width="100"></td><td width="400px"><h3 style="margin-top:0; margin-bottom:6px;"><a href="'+marker.url+'">'+marker.title+'</a></h3>'+marker.desc+'</td></tr></table>';if(!marker.desc){marker.desc='';}
google.maps.event.addListener(marker_obj,'click',function(){infoWindow.setContent(this.html);infoWindow.open(self.my_map,this);});}
self.my_map.setCenter(new google.maps.LatLng(marker.lat,marker.lng));self.my_map.setZoom(4);if(bounds&&bounds.min_lat&&bounds.max_lng&&bounds.min_lat&&bounds.max_lng){var bds=new google.maps.LatLngBounds(new google.maps.LatLng(bounds.min_lat,bounds.min_lng),new google.maps.LatLng(bounds.max_lat,bounds.max_lng));}
if(bounds&&bounds.map_center_lat&&bounds.map_center_lng){self.my_map.setCenter(new google.maps.LatLng(bounds.map_center_lat,bounds.map_center_lng));self.my_map.setZoom(4);}else{self.my_map.setCenter(new google.maps.LatLng(marker.lat,marker.lng));self.my_map.setZoom(this.zoom);}
if(bds){self.my_map.fitBounds(bds);}},set_my_marker:function(latitude,longitude){var self=this;self.my_lat=latitude;self.my_lon=longitude;var point=new google.maps.LatLng(self.my_lat,self.my_lon);self.my_marker.setPosition(point);self.my_map.setCenter(point);var infoWindow=new google.maps.InfoWindow({content:''});google.maps.event.addListener(self.my_marker,'click',function(){infoWindow.setContent(this.html);infoWindow.open(self.my_map,this);});},get_geolocation:function(){var self=this;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){self.set_my_marker(position.coords.latitude,position.coords.longitude);self.get_pages();});}
else{alert('Your browser does not support geolocation api');}},set_my_location_page:function(page_num){this.my_location_page_num=page_num;this.get_pages();},set_my_location_address:function(address)
{this.my_location_address=address;this.my_location_page_num=1;this.get_pages();},get_pages:function()
{var self=this;$('my_location_loading').removeClass('hidden');my_request=new Request.HTML({url:self.my_url,data:{my_latitude:self.my_lat,my_longitude:self.my_lon,my_address:self.my_location_address,my_page_num:self.my_location_page_num},onComplete:function(responseTree,responseElements,responseHTML,responseJavaScript){var el=$$('.layout_page_my_location');var tElement=new Element('div',{'html':responseHTML});$('my_location_pages').innerHTML=tElement.getElement('.layout_page_my_location').innerHTML;if($('my_location_pagination_select'))
$('my_location_pagination_select').value=self.my_location_page_num;}}).post();}};var donations_map={pages_array:{},markers_array:{},map_bounds:{},current_data:{},zoom:4,constructed:false,canvas_id:'map_canvas',construct:function(pages_array,markers_array,zoom,map_bounds,edit_mode){this.pages_array=pages_array;this.markers_array=markers_array;this.map_bounds=map_bounds;this.zoom=zoom;this.init();if(edit_mode==undefined&&!edit_mode){this.show_map();}else{this.show_edit_map();}
this.constructed=true;},init:function(){window.map=new google.maps.Map(document.getElementById('map_canvas'),{mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:false});},show_map:function(){if(this.markers_array.length==0){return false;}
var infoWindow=new google.maps.InfoWindow({content:''});for(var i=0;i<this.markers_array.length;i++)
{marker=this.markers_array[i];point=new google.maps.LatLng(marker.lat,marker.lng);marker_obj=new google.maps.Marker({position:point,map:window.map});marker_obj.html='<table width="500px"><tr valign="top"><td width="110px"><img src="'+marker.pages_photo+'" width="100"></td><td width="400px"><h3 style="margin-top:0; margin-bottom:6px;"><a href="'+marker.url+'">'+marker.title+'</a></h3>'+marker.desc+'</td></tr></table>';if(!marker.desc){marker.desc='';}
google.maps.event.addListener(marker_obj,'click',function(){infoWindow.setContent(this.html);infoWindow.open(window.map,this);});}
window.map.setCenter(new google.maps.LatLng(marker.lat,marker.lng));window.map.setZoom(4);if(this.map_bounds&&this.map_bounds.min_lat&&this.map_bounds.max_lng&&this.map_bounds.min_lat&&this.map_bounds.max_lng){var bds=new google.maps.LatLngBounds(new google.maps.LatLng(this.map_bounds.min_lat,this.map_bounds.min_lng),new google.maps.LatLng(this.map_bounds.max_lat,this.map_bounds.max_lng));}
if(this.map_bounds&&this.map_bounds.map_center_lat&&this.map_bounds.map_center_lng){window.map.setCenter(new google.maps.LatLng(this.map_bounds.map_center_lat,this.map_bounds.map_center_lng));window.map.setZoom(4);}else{window.map.setCenter(new google.maps.LatLng(marker.lat,marker.lng));window.map.setZoom(this.zoom);}
if(bds){window.map.fitBounds(bds);}},show_edit_map:function(){if(this.markers_array.length==0){return false;}
var self=this;var infoWindow=new google.maps.InfoWindow({content:''});for(var i=0;i<this.markers_array.length;i++)
{marker=this.markers_array[i];point=new google.maps.LatLng(marker.lat,marker.lng);marker_obj=new google.maps.Marker({position:point,map:window.map,draggable:true});marker_obj.html='<table width="500"><tr valign="top"><td width="110"><img src="'+marker.pages_photo+'" width="100"></td><td width="400"><h3 style="margin-top:0; margin-bottom:6px;"><a href="'+marker.url+'">'+marker.title+'</a></h3>'+marker.desc+'</td></tr></table>';if(!marker.desc){marker.desc='';}
google.maps.event.addListener(marker_obj,'click',function(){infoWindow.setContent(this.html);infoWindow.open(window.map,this);});}
window.map.setCenter(new google.maps.LatLng(marker.lat,marker.lng));window.map.setZoom(4);if(this.map_bounds&&this.map_bounds.min_lat&&this.map_bounds.max_lng&&this.map_bounds.min_lat&&this.map_bounds.max_lng){var bds=new google.maps.LatLngBounds(new google.maps.LatLng(this.map_bounds.min_lat,this.map_bounds.min_lng),new google.maps.LatLng(this.map_bounds.max_lat,this.map_bounds.max_lng));}
if(this.map_bounds&&this.map_bounds.map_center_lat&&this.map_bounds.map_center_lng){window.map.setCenter(new google.maps.LatLng(this.map_bounds.map_center_lat,this.map_bounds.map_center_lng));window.map.setZoom(4);}else{window.map.setCenter(new google.maps.LatLng(marker.lat,marker.lng));window.map.setZoom(this.zoom);}
if(bds){window.map.fitBounds(bds);}
google.maps.event.addListener(marker_obj,"dragend",function(){self.trackChanges(marker_obj);});},showEditMap:function(pages_array,markers_array,zoom,map_bounds,edit_mode){$$('.page_edit_form_map_show').addClass('display_none');$$('.page_edit_form_map_hide').removeClass('display_none');$('map_canvas').removeClass('display_none');if(!this.constructed){this.construct(pages_array,markers_array,zoom,map_bounds,edit_mode);}},hideEditMap:function(){$$('.page_edit_form_map_show').removeClass('display_none');$$('.page_edit_form_map_hide').addClass('display_none');$('map_canvas').addClass('display_none');},trackChanges:function(marker){var coords=marker.getPosition();$('coordinates').value=coords.lat()+';'+coords.lng();geocoder=new google.maps.Geocoder();geocoder.geocode({'latLng':marker.getPosition()},function(results,status){if(status==google.maps.GeocoderStatus.OK){if(results[0]){var address=csvToArray(results[0].formatted_address,',');var index=address.length-1;if(index>=0){$('country').value=address[index].trim();index--;}
if(index>=0){var len=results[0].address_components.length,i;for(i=len-1;i>0;i--){if(results[0].address_components[i].types[0]=='country'){i--;$('state').value=results[0].address_components[i].long_name;break;}}
index--;}
if(index>=0){$('city').value=address[index].trim();index--;}
if(index>=0){$('street').value=address[index].trim();index--;}}}});}};var Donate={chooseAmount:'.donation_select > ul > li',checkAnonymous:'anon',fullName:'name',fieldsAnonymous:'.for_guests .fields_anonymous',selected_id:null,init:function(user_id){this.initSelectors();if(!user_id){var $name=$(this.fullName);$name.addEvent('focus',function(){if(this.value==en4.core.language.translate('DONATION_Anonym')){this.value='';}});$name.addEvent('blur',function(){if(this.value==''){this.value=en4.core.language.translate('DONATION_Anonym');}});}},initSelectors:function(){var self=this;var $selectors=$$(this.chooseAmount);if($selectors){$selectors.addEvent('click',function(){$selectors.removeClass('active');this.addClass('active');self.selected_id=this.id;});}}};;var like_api={likes:null,viewer:null,like_url:'',unlike_url:'',viewer_url:'',urls:{},like_img:'',unlike_img:'',like_count:0,block:false,login_url:'',unlike_class:'unlike',like_class:'like',likes_container_id:'like_button_likes',subject_guid:'',$link:null,method:'post',format:'json',like_button_container:'like_button_wrapper',$like_button_container:{},like:function(){var self=this;if(this.block){return;}
if(!this.viewer_url){this.login();return;}
this.block=true;self.show_loader();new Request.JSON({method:self.method,url:self.like_url,data:{format:self.format},onSuccess:function(response){self.hide_loader();if(response.error==3){self.login();return false;}else if(response.error>0){return false;}
self.toggle();self.viewer_url=response.viewer_url;self.viewer=response.viewer;self.add_like(response.viewer);self.like_count++;self.build();self.block=false;return true;}}).send();},unlike:function(){var self=this;if(this.block){return;}
this.block=true;this.show_loader();new Request.JSON({method:self.method,url:self.unlike_url,data:{format:self.format},onSuccess:function(response){self.hide_loader();if(response.error==3){self.login();return false;}else if(response.error>0){return false;}
self.toggle();self.remove_like(response.viewer.user_id);self.like_count--;self.build();self.block=false;return true;}}).send();},show_loader:function(){this.$like_button_container.setStyle('display','none');},hide_loader:function(){this.$like_button_container.setStyle('display','block');},remove_like:function(user_id){var likes=this.likes;if(!likes.length||!likes){return;}
for(var i=0;i<likes.length;i++){var like=likes[i];if(like.user_id==user_id){likes=likes.slice(0,i).concat(likes.slice(i+1));break;}}
this.urls[user_id]='';this.likes=likes;},add_like:function(like){if(!this.likes){this.likes=[];}
this.likes.push(like);this.urls[like.user_id]=this.viewer_url;},build:function(){var likes=this.likes;var html='';var urls=this.urls;var like={};var out='';var like_count=this.like_count;var other_count=like_count-likes.length;if(!other_count&&!likes.length){$(this.likes_container_id).innerHTML=langs.l_noResult;return;}
if(likes[likes.length-1]){like=likes[likes.length-1];if(like.user_id==this.viewer.user_id){html+='<a href="'+urls[like.user_id]+'" style="font-weight: bold; text-decoration: none;" target="_blank">'+langs.l_you+'</a>';likes=likes.slice(0,likes.length-1).concat(likes.slice(likes.length));if((other_count>0&&likes.length>0)||(!other_count&&likes.length>1)){html+=', ';}else if(!other_count&&!likes.length){html+='';}else{html+=' '+langs.l_and+' ';}}}
for(var i=0;i<likes.length;i++){like=likes[i];out='<a href="'+urls[like.user_id]+'" style="font-weight: bold; text-decoration: none;" target="_blank">'+like.displayname+'</a>';if(i!=(likes.length-1)){out+=', '}
html+=out;}
if(likes.length>0){html+=' '+langs.l_and+' ';}
if(other_count>1){html+=other_count+' '+langs.l_people+' ';}else if(other_count==1){html+=other_count+' '+langs.l_person+' ';}
html+=' '+langs.l_like_it;$(this.likes_container_id).innerHTML=html;},login:function(){return window.open(this.login_url,'popup','width=450,height=240,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=yes,left=0,top=0');},toggle:function(){var $link=$(this.$link);if($link.hasClass(this.unlike_class)){this.set_like();}else{this.set_unlike();}},set_like:function(){var $link=$(this.$link);var self=this;$link.removeEvents('click');$link.children[0].className='like_button';$link.children[0].innerHTML=langs.l_Like;$link.children[0].style.backgroundImage='url('+this.like_img+')';$link.removeClass(this.unlike_class);$link.addClass(this.like_class);$link.addEvent('click',function(){self.like();});return $link;},set_unlike:function(){var $link=$(this.$link);var self=this;$link.removeEvents('click');$link.children[0].className='unlike_button';$link.children[0].innerHTML=langs.l_Unlike;$link.children[0].style.backgroundImage='url('+this.unlike_img+')';$link.removeClass(this.like_class);$link.addClass(this.unlike_class);$link.addEvent('click',function(){self.unlike();});return $link;},init:function(){this.$link=$('_'+this.subject_guid);this.$like_button_container=$(this.like_button_container);this.init_link();},init_link:function(){var self=this;this.$link.removeEvents('click');if(this.$link.hasClass(this.unlike_class)){this.$link.addEvent('click',function(){self.unlike();});}else{this.$link.addEvent('click',function(){self.like();});}}}
function showLikesList($node,type){$node=$($node);var $box=$node.getParents('.he_like_cont');if(!$box||!$box[0]){return;}
$box=$box[0];$box.getElements('ul.like_list_switcher li a').removeClass('active');$node.addClass('active');$cur_list=$box.getElement('.likes_'+type);$old_list=$box.getElement('div.active_list');if($cur_list.hasClass('active_list')){$node.blur();return;}
var cur_tween=new Fx.Morph($cur_list,{duration:300,opacity:0});var old_tween=new Fx.Morph($old_list,{duration:300,opacity:1});old_tween.start({opacity:0}).chain(function(){$old_list.removeClass('active_list');$cur_list.addClass('active_list');cur_tween.start({opacity:1}).chain(function(){$node.blur();});});}
function print_arr(object,flag){var type=typeof(object);var output='';var property=null;switch(type){case'object':{for(property in object){output+=property+': '+print_arr(object[property],true)+'; ';}}
break;case'array':{for(var i=0;i<object.length;i++){output+=i+': '+print_arr(object[i],true)+'; ';}}
break;case'string':{output='"'+object+'"';}
break;case'number':default:{output=object;}}
if(flag){return output;}
if(window.console!==undefined){window.console.log(output);}else{alert(output);}};var LikeButton=new Class({Implements:[Options],options:{object_type:'',object_id:0,likeBtn:'',loader:'',menuHtml:'',menuId:'',suggestBtn:'',likeUrl:en4.core.baseUrl+'like/like',unlikeUrl:en4.core.baseUrl+'like/unlike',switcher:''},unlike_class:'unlike',like_class:'like',block:false,menuContainer:null,initialize:function(options){this.setOptions(options);this.options.likeBtn=$(this.options.likeBtn);this.options.loader=$(this.options.loader);this.options.switcher=$(this.options.switcher);if(this.options.likeBtn){if(this.options.likeBtn.hasClass(this.unlike_class)){this.setUnlike();}else{this.setLike();}}
this.init_menu();},init_menu:function(){var $div=new Element('div',{'html':this.options.menuHtml,'style':'position:absolute;','id':this.options.menuId});this.menuContainer=$div=$div.getElements('.like_container_menu_wrapper')[0];$$('body')[0].appendChild($div);this.initPosition();this.options.suggestBtn=$$(this.options.suggestBtn)[0];this.init_suggest_link();if(this.options.switcher){var self=this;this.options.switcher.addEvent('click',function(){self.toggle_menu();});}
if(Smoothbox&&Smoothbox.init){Smoothbox.init();}},initPosition:function(){var $switcher=$(this.options.likeBtn).getNext();var position=$switcher.getPosition();if(this.menuContainer!=undefined){if(en4.orientation=='rtl'){this.menuContainer.setStyle('left',position.x-this.menuContainer.getSize().x);}
else
{this.menuContainer.setStyle('left',position.x+20);}
this.menuContainer.setStyle('top',position.y);}},init_suggest_link:function(){var self=this;if(!this.options.suggestBtn){return;}
this.options.suggestBtn.addEvent('click',function(e){e.stop();like.url.suggest=this.href;he_contacts.box('like','getFriends','like.suggest',en4.core.language.translate('like_Suggest to Friends'),{'object':self.options.object_type,'object_id':self.options.object_id},0);});},like:function(){var self=this;if(this.block){return;}
this.showLoader();this.block=true;new Request.JSON({method:'post',url:self.options.likeUrl,data:{format:'json'},onSuccess:function(response){self.block=false;if(response.error){he_show_message(response.html,'error',3000);return;}
self.hideLoader();self.toggle();return true;}}).send();},unlike:function(){var self=this;if(this.block){return;}
self.showLoader();this.block=true;new Request.JSON({method:'post',url:self.options.unlikeUrl,data:{format:'json'},onSuccess:function(response){self.block=false;if(response.error){he_show_message(response.html,'error',3000);return;}
self.hideLoader();self.toggle();return true;}}).send();},toggle:function(){var $link=$(this.options.likeBtn);if($link.hasClass(this.unlike_class)){this.setLike();}else{this.setUnlike();}
this.initPosition();},toggle_menu:function(){var menu=this.menuContainer
var link=this.options.switcher;if(menu.hasClass('hidden')){menu.removeClass('hidden');link.getElements('span')[0].set('class','hide_options');link.set('title',en4.core.language.translate('like_Hide'));this.initPosition();}else{menu.addClass('hidden');link.getElements('span')[0].set('class','show_options');link.set('title',en4.core.language.translate('like_Show Like'));}},setLike:function(){var $link=$(this.options.likeBtn);var self=this;$link.getElements('span')[0].set('class','like_button');$link.getElements('span')[0].set('text',en4.core.language.translate('like_Like'));$link.set('class','like_button_link '+self.like_class);$link.removeEvents('click');$link.addEvent('click',function(){self.like();});return this;},setUnlike:function(){var $link=$(this.options.likeBtn);var self=this;$link.removeEvents('click');$link.getElements('span')[0].set('class','unlike_button');$link.getElements('span')[0].set('text',en4.core.language.translate('like_Unlike'));$link.set('class','like_button_link '+self.unlike_class);$link.addEvent('click',function(){self.unlike();});return this;},showLoader:function(){this.options.likeBtn.addClass('hidden');if(this.options.switcher){this.options.switcher.addClass('hidden');}
this.options.loader.removeClass('hidden');},hideLoader:function(){this.options.likeBtn.removeClass('hidden');if(this.options.switcher){this.options.switcher.removeClass('hidden');}
this.options.loader.addClass('hidden');}});var like={block:false,sender:{},url:{ajax:'',suggest:'',remove:''},clubs:{pages:{count:0,items:[]},users:{count:0,items:[]}},loader_id:'he_contacts_loading',disabled_div:'he_disabled_div',$link:{},method:'post',format:'json',unlike_class:'unlike',like_class:'like',like_url:'',unlike_url:'',menu_html:'',init:function(){var self=this;$$('.disable_like_club, .enable_like_club').addEvent('click',function(e){e.stop();self.url.ajax=this.href;self.sender=this;self.send();});if($$('a.like_display_none')){$$('a.like_display_none').each(function($item){$item.getParent().setStyle('display','none');});}
var guid=en4.core.subject.guid;if($('_'+guid)){this.$link=$('_'+guid);if(this.$link.hasClass(this.unlike_class)){this.set_unlike();}else{this.set_like();}}
this.init_menu();},init_menu:function(){var $div=new Element('div',{'html':this.menu_html,'style':'position:absolute;'});$div=$div.getElements('.like_container_menu_wrapper')[0];$$('body')[0].appendChild($div);var $switcher=$(this.$link).getNext();var position=$switcher.getPosition();$div.setStyle('left',position.x+20);$div.setStyle('top',position.y);this.init_suggest_link();Smoothbox.init();},init_suggest_link:function(){var self=this;if(!$$('.like_suggest')){return;}
$$('.like_suggest').addEvent('click',function(e){e.stop();self.url.suggest=this.href;he_contacts.box('like','getFriends','like.suggest',en4.core.language.translate('like_Suggest to Friends'),{'object':window.en4.core.subject.type,'object_id':window.en4.core.subject.id},0);});},set_menu_pos:function(){var $div=$$('.like_container_menu_wrapper')[0];var $switcher=$(this.$link).getNext();var position=$switcher.getPosition();$div.setStyle('left',position.x+20);$div.setStyle('top',position.y);},like:function(){var self=this;if(this.block){return;}
self.show_like_loader();this.block=true;new Request.JSON({method:self.method,url:self.like_url,data:{format:self.format},onSuccess:function(response){self.block=false;if(response.error){he_show_message(response.html,'error',3000);return;}
self.hide_like_loader();self.toggle();return true;}}).send();},unlike:function(){var self=this;if(this.block){return;}
self.show_like_loader();this.block=true;new Request.JSON({method:self.method,url:self.unlike_url,data:{format:self.format},onSuccess:function(response){self.block=false;if(response.error){he_show_message(response.html,'error',3000);return;}
self.hide_like_loader();self.toggle();return true;}}).send();},toggle:function(){var $link=$(this.$link);if($link.hasClass(this.unlike_class)){this.set_like();}else{this.set_unlike();}},set_like:function(){var $link=$(this.$link);var self=this;$link.getElements('span')[0].set('class','like_button');$link.getElements('span')[0].set('text',en4.core.language.translate('like_Like'));$link.set('class','like_button_link '+self.like_class);$link.removeEvents('click');$link.addEvent('click',function(){self.like();});this.$link=$($link);return this.$link;},set_unlike:function(){var $link=$(this.$link);var self=this;$link.removeEvents('click');$link.getElements('span')[0].set('class','unlike_button');$link.getElements('span')[0].set('text',en4.core.language.translate('like_Unlike'));$link.set('class','like_button_link '+self.unlike_class);$link.addEvent('click',function(){self.unlike();});this.$link=$($link);return $link;},show_like_loader:function(){$(this.$link).addClass('hidden');if($$('.like_menu_switcher')[0]){$$('.like_menu_switcher')[0].addClass('hidden');}
$$('.like_button_loader')[0].removeClass('hidden');},hide_like_loader:function(){$(this.$link).removeClass('hidden');if($$('.like_menu_switcher')[0]){$$('.like_menu_switcher')[0].removeClass('hidden');}
$$('.like_button_loader')[0].addClass('hidden');},init_counts:function(){var self=this;if($('like_users_count')){$('like_users_count').innerHTML="("+this.clubs.users.count+")";}
if($('like_pages_count')){$('like_pages_count').innerHTML="("+this.clubs.pages.count+")";}
if($$('.like_profile_pages')[0]){$$('.like_profile_pages')[0].addEvent('click',function(){self.make_active(this);});}
if($$('.like_profile_users')[0]){$$('.like_profile_users')[0].addEvent('click',function(){self.make_active(this);});this.make_active($$('.like_profile_users')[0]);}
if($$('.menu_like_profile')){$$('.menu_like_profile').addEvent('focus',function(){this.blur();});}
if(!this.clubs.users.count){if($$('.no_result_users'))$$('.no_result_users').removeClass('hidden');}
if(!this.clubs.pages.count){if($$('.no_result_pages'))$$('.no_result_pages').removeClass('hidden');}},make_active:function($link){if($$('ul.like_navigation li.active'))$$('ul.like_navigation li.active').removeClass('active');$link.getParent().addClass('active');},list:function(type,$link){var id="likes_"+type;$$('.like_navigation_item').removeClass('active');$($link).getParent().addClass('active');if(!$(id).hasClass('hidden')){return;}
$$('.like_club_container').addClass('hidden');$(id).removeClass('hidden');},suggest:function(user_ids){var self=this;new Request.JSON({'url':self.url.suggest,'method':'post','data':{'user_ids':user_ids,'format':'json'}}).send();},send:function(){if(this.block||!this.url.ajax){return;}
this.block=true;var self=this;new Request.JSON({'url':self.url.ajax,'method':'post','data':{'format':'json'},onSuccess:function(response){self.sender.getParent().innerHTML=response.html;self.init();self.block=false;switch(response.link){case'disable':if($$('.like_promote')[0])$$('.like_promote')[0].getParent().setStyle('display','block');if($$('.like_send_update')[0])$$('.like_send_update')[0].getParent().setStyle('display','block');if($$('.like_suggest')[0])$$('.like_suggest')[0].getParent().setStyle('display','block');if($$('.like_button_container')[0])$$('.like_button_container')[0].setStyle('display','block');break;case'enable':if($$('.like_promote')[0])$$('.like_promote')[0].getParent().setStyle('display','none');if($$('.like_send_update')[0])$$('.like_send_update')[0].getParent().setStyle('display','none');if($$('.like_suggest')[0])$$('.like_suggest')[0].getParent().setStyle('display','none');if($$('.like_button_container')[0])$$('.like_button_container')[0].setStyle('display','none');break;}}}).send();},see_all:function(object,object_id,period_type){he_list.box('like','getLikes','Likes',{'object':object,'object_id':object_id,'period_type':period_type});},see_all_liked:function(user_id,period_type){var $el=new Element('a',{'href':'like/see-liked/user_id/'+user_id+'/period_type/'+period_type,'class':'smoothbox'});Smoothbox.open($el);},list_like:function(object,object_id,$element,callback){var self=this;$element=$($element);if(this.block){return false;}
this.block=true;new Request.JSON({'url':'like/like/object/'+object+'/object_id/'+object_id,'method':'post','data':{'format':'json'},onSuccess:function(response){self.block=false;if(response.error){he_show_message(response.html,'error',3000);callback(false);return;}
$('unlike_'+object+'_'+object_id).getParent().setStyle('display','block');$('like_'+object+'_'+object_id).getParent().setStyle('display','none');if(typeof(callback)=='function'){callback(true);}}}).send();},list_unlike:function(object,object_id,$element,callback){var self=this;$element=$($element);if(this.block){return false;}
this.block=true;new Request.JSON({'url':'like/unlike/object/'+object+'/object_id/'+object_id,'method':'post','data':{'format':'json'},onSuccess:function(response){self.block=false;if(response.error){he_show_message(response.html,'error',3000);callback(true);return;}
$('unlike_'+object+'_'+object_id).getParent().setStyle('display','none');$('like_'+object+'_'+object_id).getParent().setStyle('display','block');if(typeof(callback)=='function'){callback(false);}}}).send();},init_buttons:function(){var self=this;if($$('div.like_button_container a.unlike')){var $btns=$$('.like_button_container a.unlike');$btns.removeEvents('click');$btns.each(function($item){if($item.hasClass('unlike')){$item.addEvent('click',function(){var id=this.id;var guid=id.substr(7);var info=guid.split('_');self.list_unlike(info[0],info[1],$item);});}});}
if($$('div.like_button_container a.like')){var $btns=$$('.like_button_container a.like');$btns.removeEvents('click');$btns.each(function($item){if($item.hasClass('like')){$item.addEvent('click',function(){var id=this.id;var guid=id.substr(5);var info=guid.split('_');self.list_like(info[0],info[1],$item);});}});}},init_like_buttons:function(){var self=this;if($$('.page_browser_likebox a.unlike')){var $btns=$$('.page_browser_likebox a.unlike');$btns.removeEvents('click');$btns.each(function($item){if($item.hasClass('unlike')){$item.addEvent('click',function(){var id=this.id;var guid=id.substr(7);var info=guid.split('_');if(info.length==3){self.show_page_loader(info[2]);self.list_unlike(info[0]+'_'+info[1],info[2],$item,function(liked){self.hide_page_loader(info[2],liked);});}else{self.show_page_loader(info[1]);self.list_unlike(info[0],info[1],$item,function(liked){self.hide_page_loader(info[1],liked);});}});}});}
if($$('.page_browser_likebox a.like')){var $btns=$$('.page_browser_likebox a.like');$btns.removeEvents('click');$btns.each(function($item){if($item.hasClass('like')){$item.addEvent('click',function(){var id=this.id;var guid=id.substr(5);var info=guid.split('_');if(info.length==3){self.show_page_loader(info[2]);self.list_like(info[0]+'_'+info[1],info[2],$item,function(liked){self.hide_page_loader(info[2],liked);});}else{self.show_page_loader(info[1]);self.list_like(info[0],info[1],$item,function(liked){self.hide_page_loader(info[1],liked);});}});}});}},show_page_loader:function(id){$('page_status_'+id).addClass('hidden');$('page_loader_like_'+id).removeClass('hidden');},hide_page_loader:function(id,liked){$('page_status_'+id).removeClass('hidden');$('page_loader_like_'+id).addClass('hidden');var $item=$('page_status_'+id).getParent('.item');if(liked){$item.addClass('liked_item');}else{$item.removeClass('liked_item');}},select_list:function(list,user_id,$link){var self=this;self.show_loader();new Request.JSON({'url':'like/see-liked/list/'+list+'/user_id/'+user_id,'method':'post','data':{'format':'json'},onSuccess:function(response){$('he_list').innerHTML=response.html;if($$('.select_btns .active')){$$('.select_btns .active').each(function($element){$($element).removeClass('active');});}
$($link).addClass('active');self.hide_loader();self.init_buttons();}}).send();},do_remove:function(object,object_id){var self=this;var $item=$('like_'+object+'_'+object_id);$item.dispose();new Request.JSON({'url':self.url.remove,'method':'post','data':{'object':object,'object_id':object_id,'format':'json'},onSuccess:function(response){if(response.error){he_show_message(response.html,'error',3000);return;}
self.counting(object+'s',-1);}}).send();},remove:function(object,object_id){var self=this;var callback=function(){self.do_remove(object,object_id)};he_show_confirm(en4.core.language.translate("like_Unlike"),en4.core.language.translate("like_Are you sure you want to unlike this?"),callback);},counting:function(type,count){var prev=$('like_'+type+'_count').innerHTML.substr(1).toInt();var next=prev+count;$('like_'+type+'_count').innerHTML="("+next+")";if(!next){$$('.no_result_'+type).removeClass('hidden');}},show_loader:function(){$(this.loader_id).removeClass('hidden');$(this.disabled_div).removeClass('hidden');},hide_loader:function(){$(this.loader_id).addClass('hidden');},toggle_menu:function($link){$link=$($link);if($$('.like_container_menu_wrapper')[0].hasClass('hidden')){$$('.like_container_menu_wrapper')[0].removeClass('hidden');$link.getElements('span')[0].set('class','hide_options');$link.set('title',en4.core.language.translate('like_Hide'));this.set_menu_pos();}else{$$('.like_container_menu_wrapper')[0].addClass('hidden');$link.getElements('span')[0].set('class','show_options');$link.set('title',en4.core.language.translate('like_Show Like'));}},get_mutual_friends:function(user_id){he_list.box('like','getMutualFriends',en4.core.language.translate('Friends'),{'user_id':user_id,'list_type':'mutual'});},get_friends:function(user_id){he_list.box('like','getFriends',en4.core.language.translate('Friends'),{'user_id':user_id,'list_type':'all'});}}
var LikeTips=new Class({Implements:[Options],type:'',id:0,guid:'',options:{container:'comments',html:'',url:{like:'',unlike:'',hint:'',showLikes:'',postComment:''}},likeBtn:null,unlikeBtn:null,commentBtn:null,commentForm:null,commentViewAllBtns:[],container:null,likeContainer:null,likeCountBtn:null,viewAllLikes:false,cache:{},tipBlock:{},blockHints:false,timeout:null,tips:null,initialize:function(type,id,options){this.type=type;this.id=id;this.guid=type+'_'+id;this.setOptions(options);this.tipBlock=this.createTipBlock();this.container=$(this.options.container);this.replace();this.init();this.bind();return this;},createTipBlock:function(){if($('like_tip_'+this.guid)){return $('like_tip_'+this.guid);}
var $container=new Element('div',{'class':'like_tool_tip hidden','id':'like_tip_'+this.guid,'style':'position:absolute;'});var $header=new Element('div',{'class':'like-tip-title'});var $content=new Element('div',{'class':'like-tip'});var $footer=new Element('div',{'class':'like-tip-footer'});var $clr=new Element('div',{'class':'clr'});$container.appendChild($header);$container.appendChild($content);$container.appendChild($footer);$container.appendChild($clr);$$('body')[0].appendChild($container);return $container;},init:function(){this.likeContainer=$('comments_likes_list_'+this.guid);this.likeCountBtn=$('show_likes_'+this.guid);this.likeBtn=$('comments_like_'+this.guid);this.unlikeBtn=$('comments_unlike_'+this.guid);this.commentBtn=$('post_comment_'+this.guid);this.commentViewAllBtns=$$('.comments_view_all_'+this.guid);this.commentForm=$('comment-form_'+this.guid);if(this.likeCountBtn){this.bindLikeCountBtn();}
if(this.likeBtn){this.bindLikeBtn();}
if(this.unlikeBtn){this.bindUnlikeBtn();}
if(this.commentBtn){this.bindCommentBtn();}
if(this.commentViewAllBtns){this.bindCommentViewAllBtns();}
if(this.commentForm){this.bindCommentForm();}
return this;},replace:function(html){if(!html){html=this.options.html;}
if(this.container){this.container.set('html',html);}
return this;},runScripts:function(){$$(this.container.getElements('script')).each(function($script){var script=$script.innerHTML;eval(script);});return this;},bind:function(){var self=this;if(!$(this.likeContainer)){return;}
var $likes=$$($(this.likeContainer).getElements('a'));if($likes.length){$likes.each(function($item){self.bindItem($item);});}},bindItem:function($item){var self=this;if(!$item){return;}
if($item.href.indexOf('javascript')>=0){return;}
$($item).addEvents({'mouseover':function(){var username=this.href.split('/').pop();var x=$(this).getPosition().x;var y=$(this).getPosition().y;self.timeout=window.setTimeout(function(){self.hint(username,x,y);},500);},'mouseout':function(){window.clearTimeout(self.timeout);self.timeout=window.setTimeout(function(){self.hideTip();},500);}});},hint:function(username,x,y){var self=this;if(this.blockHints){return;}
if(this.cache[username]){this.showTip(this.cache[username],x,y);this.blockHints=false;return;}
this.blockHints=true;new Request.JSON({'method':'post','url':self.options.url.hint,'data':{'username':username,'format':'json'},onSuccess:function(response){self.cache[username]=response.html;self.showTip(response.html,x,y);self.blockHints=false;}}).send();},showTip:function(html,x,y){var self=this;$(this.tipBlock).getElements('.like-tip')[0].set('html',html);$(this.tipBlock).setStyle('left',x);$(this.tipBlock).setStyle('top',(y-175));$(this.tipBlock).removeClass('hidden');Smoothbox.bind();var miniTipsOptions={'htmlElement':'.like_hint_text','delay':100,'className':'he-tip-mini','id':'he-mini-tool-tip-id','ajax':false,'visibleOnHover':false};var internalTips=new HETips($$('.like_hint_tip_links'),miniTipsOptions);this.tipBlock.removeEvents('mouseover').removeEvents('mouseout').addEvents({'mouseover':function(){if(self.options.visibleOnHover){window.clearTimeout(self.timeout);}},'mouseout':function(){self.timeout=window.setTimeout(function(){self.hideTip();},500);}});},hideTip:function(){this.tipBlock.addClass('hidden');},bindLikeCountBtn:function(){var self=this;this.resetLikeCountBtn();var $btn=this.likeCountBtn;$btn.removeEvents('click').addEvent('click',function(){self.viewAllLikes=true;new Request.JSON({'method':'post','url':self.options.url.showLikes,'data':{'format':'json','type':self.type,'id':self.id,'viewAllLikes':self.viewAllLikes},onSuccess:function(response){self.replace(response.body);self.init();self.bind();}}).send();});return this;},bindLikeBtn:function(){var self=this;this.resetLikeBtn();var $btn=this.likeBtn;$btn.removeEvents('click').addEvent('click',function(){new Request.JSON({'method':'post','url':self.options.url.like,'data':{'format':'json','type':self.type,'id':self.id,'viewAllLikes':self.viewAllLikes},onSuccess:function(response){self.replace(response.body);self.init();self.bind();}}).send();});return this;},bindUnlikeBtn:function(){var self=this;this.resetUnlikeBtn();var $btn=this.unlikeBtn;$btn.removeEvents('click').addEvent('click',function(){new Request.JSON({'method':'post','url':self.options.url.unlike,'data':{'format':'json','type':self.type,'id':self.id,'viewAllLikes':self.viewAllLikes},onSuccess:function(response){self.replace(response.body);self.init();self.bind();}}).send();});return this;},bindCommentBtn:function(){var self=this;this.resetCommentBtn();var $btn=this.commentBtn;$btn.removeEvents('click').addEvent('click',function(){if(self.commentForm){self.commentForm.style.display='';self.commentForm.body.focus();}});return this;},bindCommentForm:function(){var self=this;this.resetCommentForm();var $form=$(this.commentForm);$($form.body).autogrow();$form.removeEvents('submit').addEvent('submit',function(e){e.stop();var body=this.body.value;new Request.JSON({'method':'post','url':self.options.url.postComment,'data':{'format':'json','type':self.type,'id':self.id,'body':body,'viewAllLikes':self.viewAllLikes},onSuccess:function(response){self.replace(response.body);self.init();self.bind();$form.style.display='none';}}).send();});return this;},bindCommentViewAllBtns:function(){var self=this;this.resetCommentViewAllBtns();var $btns=this.commentViewAllBtns;$btns.removeEvents('click').addEvent('click',function(){var page=this.id.split('_').pop();new Request.JSON({'method':'post','url':self.options.url.showLikes,'data':{'format':'json','type':self.type,'id':self.id,'page':page},onSuccess:function(response){self.replace(response.body);self.init();self.bind();}}).send();});return this;},resetLikeCountBtn:function(){this.likeCountBtn.set('onclick','');return this;},resetLikeBtn:function(){this.likeBtn.set('onclick','');return this;},resetUnlikeBtn:function(){this.unlikeBtn.set('onclick','');return this;},resetCommentBtn:function(){this.commentBtn.set('onclick','');return this;},resetCommentForm:function(){$(this.commentForm).set('onsubmit','');return this;},resetCommentViewAllBtns:function(){this.commentViewAllBtns.set('onclick','');}});var likeInterest={data:{},interests:{},html:null,id:0,button:"save_changes",$button:null,url:{add:'',remove:'',suggest:''},defaultText:{},defaultTextClass:'default_text',autoCompleters:{},interestItemClass:'.select',interestSelectedClass:'selected',linkIdPrefix:'select_',inputIdPrefix:'interest_',selectedInterestWrapperIdPrefix:'selected_interest_',linkListIdPrefix:'interests_list_',addedInterests:null,addedInterestsFake:null,isChanged:null,addedFiedlId:'added',privacyOptions:'.like_interests_privacy .options .option',privacyValue:'',init:function(id){this.id=id;this.initButton();this.initInputs();this.initInterests();this.initPrivacy();},input:function(type){return $(this.data[type].input);},initButton:function(){var self=this;this.$button=$(this.button);this.$button.addEvent('click',function(){var $form=self.createForm();$$('body')[0].appendChild($form);$form.submit();});},initPrivacy:function(){var self=this;var $buttons=$$(this.privacyOptions);$buttons.addEvent('click',function(){$buttons.removeClass('active');this.addClass('active');self.privacyValue=this.id;});},createForm:function(){var $form=new Element('form',{'action':this.url.submit,'method':'post','class':'hidden'});for(var type in this.addedInterests){var ids=this.addedInterests[type];var $input=new Element('input',{'type':'hidden','name':'data['+type+']','value':ids});$form.appendChild($input);}
for(var type in this.addedInterestsFake){var ids=this.addedInterestsFake[type];var $input=new Element('input',{'type':'hidden','name':'fake_data['+type+']','value':ids});$form.appendChild($input);}
var $input=new Element('input',{'type':'hidden','name':'view_interest','value':this.privacyValue});$form.appendChild($input);return $form;},initInterests:function(){var self=this;this.interests=$$(this.interestItemClass);this.interests.removeEvents('click').addEvents({'click':function(){self.initLink(this);},'focus':function(){this.blur();}});},initLink:function($link){this.interests.removeClass(this.interestSelectedClass);$link.addClass(this.interestSelectedClass);var guid=$link.id.substr(this.linkIdPrefix.length);var data=guid.split('_');var type=data[0];if(data.length>2){for(var i=1;i<(data.length-1);i++){type+='_'+data[i];}}
var id=data[data.length-1];this.showInterest(type,id);},showInterest:function(type,id){var previewType=this.convertType(type);$(this.selectedInterestWrapperIdPrefix+previewType).set('html',this.html[type+'_'+id]);},showInterestGuid:function(guid){var data=guid.split('_');var type=data[0];if(data.length>2){for(var i=1;i<(data.length-1);i++){type+='_'+data[i];}}
var id=data[data.length-1];this.showInterest(type,id);},initInputs:function(){var self=this;var data={id:self.id};if(this.data&&this.data.length<1){return;}
for(var type in this.data){data.type=type;data.except=self.addedInterests[type];data.fake_except=self.addedInterestsFake[type];switch(type)
{case'event':data.page_except=self.addedInterests['pageevent'];break;case'blog':data.page_except=self.addedInterests['pageblog'];break;case'music_playlist':data.page_except=self.addedInterests['playlist'];break;case'album':data.page_except=self.addedInterests['pagevideo'];default:break;}
this.autoCompleters[type]=new Autocompleter.Request.JSON(this.data[type].input,this.url.suggest,{'postVar':'text','postData':data,'customChoices':true,'minLength':1,'selectMode':'selection','autocompleteType':'interest','className':'interest-autosuggest','filterSubset':true,'multiple':false,'maxChoices':5,'cache':false,'injectChoice':function(token){var choice=new Element('li',{'class':'interest-choice','value':token.label,'id':token.id});var photo=new Element('div',{'html':'','class':'interest-choice-photo'});var a=new Element('a',{'html':'','class':'hidden href_holder','href':token.href});var img=new Element('img',{'src':token.img,'class':'thumb_icon item_photo_interest_suggest'});var title=new Element('div',{'html':this.markQueryValue(token.label),'class':'interest-choice-title'});var clr=new Element('div',{'html':'','class':'clr'});photo.appendChild(img);choice.appendChild(photo);choice.appendChild(title);choice.appendChild(a);choice.appendChild(clr);choice.inputValue=token;this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},onChoiceSelect:function(selected){var guid=selected.id;var data=guid.split('_');var type=data[0];if(data.length>2){for(var i=1;i<(data.length-1);i++){type+='_'+data[i];}}
var id=data[data.length-1];var interest={};var label=$(selected).getElement('.interest-choice-title').get('text');interest.title=label;interest.img=$(selected).getElement('img').src;interest.href=$(selected).getElement('a.href_holder').href;self.newInterest(type,id,interest);self.newInterestLink(type,id,label);switch(type){case'pageevent':var previewType='event';break;case'pageblog':var previewType='blog';break;case'pagevideo':var previewType='video';break;case'playlist':var previewType='music_playlist';break;default:var previewType=type;break;}
$(self.data[previewType].input).value='';},onBlur:function(input){var type=input.id.substr(self.inputIdPrefix.length);if(input.value.trim()==''){input.value=self.defaultText[type];$(input).addClass(self.defaultTextClass);}},onFocus:function(input){var type=input.id.substr(self.inputIdPrefix.length);if(input.value==self.defaultText[type]){input.value='';$(input).removeClass(self.defaultTextClass);}}});}},newInterestLink:function(type,id,title){var previewType=this.convertType(type);var self=this;var $item=new Element('div',{'class':'item'});var $a=new Element('a',{'href':'javascript:void(0)','html':title,'class':self.interestItemClass.substr(1),'id':self.linkIdPrefix+type+'_'+id});$item.appendChild($a);$item.setStyle('opacity',0);$item.set('tween',{duration:300});var $list=$(this.linkListIdPrefix+previewType).grab($item,'top');window.setTimeout(function(){$item.tween('opacity',1);},300);this.initInterests();$($a).fireEvent('click');},newInterest:function(type,id,interest){var $container=new Element('div');var $photo=new Element('div',{'class':'pic'});var $a=new Element('a',{'href':interest.href});var $img=new Element('img',{'src':interest.img,'class':'thumb_icon item_photo_'+type});if(parseInt(id))
{$a.appendChild($img);$photo.appendChild($a);}
else
{$photo.appendChild($img);}
$container.appendChild($photo);var $wrapper=new Element('div',{'class':'wrapper'});var $link=new Element('div',{'class':'link'});if(parseInt(id))
{var $a=new Element('a',{'href':interest.href,'html':interest.title});}
else
{var $a=new Element('label',{'text':interest.title});}
$link.appendChild($a);var $delete=new Element('div',{'class':'delete'});if(parseInt(id))
{var $a=new Element('a',{'href':'javascript:likeInterest.doRemove("'+type+'", '+id+')','html':'Remove'});}
else
{var $a=new Element('a',{'href':'javascript:likeInterest.doRemove("'+type+'", "'+id+'")','html':'Remove'});}
$delete.appendChild($a);$wrapper.appendChild($link);$wrapper.appendChild($delete);$container.appendChild($wrapper);var html=$container.innerHTML;if(this.addedInterests[type]===undefined)
{this.addedInterests[type]=[];}
if(parseInt(id))
{this.addedInterests[type].push(parseInt(id));this.refreshPostData(type);}
else
{this.addedInterestsFake[type].push(id);this.refreshPostData(type,true);}
this.newInterestHTML(type,id,html);this.showInterest(type,id);},newInterestHTML:function(type,id,html){this.html[type+'_'+id]=html;},remove:function(type,id){var self=this;he_show_confirm(en4.core.language.translate('like_Delete Interest'),en4.core.language.translate('like_If you delete it, you will unlike this item. Are you sure you want to delete it?'),function(){self.doRemove(type,id);});},doRemove:function(type,id){this.removeInterest(type,id);this.removeInterestLink(type,id);},removeInterest:function(type,id){var previewType=this.convertType(type);var $wrapper=$(this.selectedInterestWrapperIdPrefix+previewType);var guid=type+'_'+id;delete this.html[guid];var last=0;if(parseInt(id))
{this.addedInterests[type].erase(id);this.refreshPostData(type);}
else
{this.addedInterestsFake[type].erase(id);this.refreshPostData(type,true);if(this.addedInterestsFake[type].length)
{last=this.addedInterestsFake[type][this.addedInterestsFake[type].length-1];}
if(last)
{$(this.linkIdPrefix+type+'_'+last).fireEvent('click');return;}}
if(this.addedInterests[type].length){last=this.addedInterests[type][this.addedInterests[type].length-1];}
if(last){$(this.linkIdPrefix+type+'_'+last).fireEvent('click');}
else{if(this.isPageType(type))
{var new_type=this.convertType(type);}
else
{var new_type=this.convertToPageType(type);}
if(this.addedInterests[new_type]===undefined)
{this.addedInterests[new_type]=[];}
if(this.addedInterests[new_type].length)
{last=this.addedInterests[new_type][this.addedInterests[new_type].length-1];}
if(last)
{$(this.linkIdPrefix+new_type+'_'+last).fireEvent('click');}
else
{new_type=this.convertType(type);if(this.addedInterestsFake[new_type].length)
{last=this.addedInterestsFake[new_type][this.addedInterestsFake[new_type].length-1];}
if(last)
{$(this.linkIdPrefix+new_type+'_'+last).fireEvent('click');}
else
{$wrapper.set('html',' &nbsp; ');}}}},removeInterestLink:function(type,id){var $link=$(this.linkIdPrefix+type+'_'+id);$link.dispose();},refreshPostData:function(type,fake){if(fake)
{this.autoCompleters[type].options.postData.fake_except=this.addedInterestsFake[type];return;}
switch(type)
{case'pageevent':this.autoCompleters['event'].options.postData.page_except=this.addedInterests[type];break;case'pageblog':this.autoCompleters['blog'].options.postData.page_except=this.addedInterests[type];break;case'pagevideo':this.autoCompleters['video'].options.postData.page_except=this.addedInterests[type];break;case'playlist':this.autoCompleters['music_playlist'].options.postData.page_except=this.addedInterests[type];break;default:this.autoCompleters[type].options.postData.except=this.addedInterests[type];break;}},convertType:function(type){switch(type){case'pageevent':var previewType='event';break;case'pageblog':var previewType='blog';break;case'pagevideo':var previewType='video';break;case'playlist':var previewType='music_playlist';break;default:var previewType=type;break;}
return previewType;},convertToPageType:function(type)
{switch(type)
{case'event':var pageType='pageevent';break;case'blog':var pageType='pageblog';break;case'video':var pageType='pagevideo';break;case'music_playlist':var pageType='playlist';break;default:var pageType=type;break;}
return pageType;},isPageType:function(type)
{if(type=='playlist')
return 1;else
return type.indexOf('page')+1;}};var LikeAction=new Class({Implements:[Options],options:{userIds:[],likecount:0},nodeId:'',$node:null,viewerId:0,viewerLiked:false,initialize:function(nodeId,options){this.nodeId=nodeId;this.$node=$(nodeId);this.viewerId=en4.user.viewer.id;this.setOptions(options);this.viewerLiked=this.options.userIds.indexOf(this.viewerId)<0?false:true;this.render();},render:function(){var out='like_';var likeCount=this.options.likeCount;if(this.viewerLiked){out+='You ';likeCount--;if(likeCount){out+='and ';}}
if(likeCount>1){out+='%s other people ';}else if(likeCount==1){out+='%s other person ';}else if(!this.viewerLiked){out+='No one ';}
out+='like it.'
this.$node.set('html',en4.core.language.translate(out,likeCount));return out;}});;var Calendar=new Class({Implements:Options,options:{blocked:[],classes:[],days:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],direction:0,draggable:true,months:['January','February','March','April','May','June','July','August','September','October','November','December'],navigation:1,offset:0,onHideStart:Class.empty,onHideComplete:Class.empty,onShowStart:Class.empty,onShowComplete:Class.empty,pad:1,tweak:{x:0,y:0},day_suffixes:['st','nd','rd','th'],year_suffix:''},initialize:function(obj,options){if(!obj){return false;}
this.setOptions(options);var keys=['calendar','prev','next','month','year','today','invalid','valid','inactive','active','hover','hilite'];var values=keys.map(function(key,i){if(this.options.classes[i]){if(this.options.classes[i].length){key=this.options.classes[i];}}
return key;},this);this.classes=values.associate(keys);this.calendar=new Element('div',{'styles':{left:'-1000px',opacity:0,position:'absolute',top:'-1000px',zIndex:1000}}).addClass(this.classes.calendar).injectInside(document.body);if(window.ie6){this.iframe=new Element('iframe',{'styles':{left:'-1000px',position:'absolute',top:'-1000px',zIndex:999}}).injectInside(document.body);this.iframe.style.filter='progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)';}
this.fx=new Fx.Tween(this.calendar,{onStart:function(){if(this.calendar.getStyle('opacity')==0){if(window.ie6){this.iframe.setStyle('display','block');}
this.calendar.setStyle('display','block');this.fireEvent('onShowStart',this.element);}
else{this.fireEvent('onHideStart',this.element);}}.bind(this),onComplete:function(){if(this.calendar.getStyle('opacity')==0){this.calendar.setStyle('display','none');if(window.ie6){this.iframe.setStyle('display','none');}
this.fireEvent('onHideComplete',this.element);}
else{this.fireEvent('onShowComplete',this.element);}}.bind(this)});if(window.Drag&&this.options.draggable){this.drag=new Drag.Move(this.calendar,{onDrag:function(){if(window.ie6){this.iframe.setStyles({left:this.calendar.style.left,top:this.calendar.style.top});}}.bind(this)});}
this.calendars=[];var id=0;var d=new Date();d.setDate(d.getDate()+this.options.direction.toInt());for(var i in obj){var cal={button:new Element('button',{'type':'button'}),el:$(i),els:[],id:id++,month:d.getMonth(),visible:false,year:d.getFullYear()};if(!this.element(i,obj[i],cal)){continue;}
cal.el.addClass(this.classes.calendar);var self=this;cal.button.addClass(this.classes.calendar).addEvent('click',function(e,cal){this.toggle(cal);e.stop();}.bindWithEvent(this,cal)).injectBefore(cal.el);cal.val=this.read(cal);$extend(cal,this.bounds(cal));$extend(cal,this.values(cal));this.rebuild(cal);this.calendars.push(cal);}},blocked:function(cal){var blocked=[];var offset=new Date(cal.year,cal.month,1).getDay();var last=new Date(cal.year,cal.month+1,0).getDate();this.options.blocked.each(function(date){var values=date.split(' ');for(var i=0;i<=3;i++){if(!values[i]){values[i]=(i==3)?'':'*';}
values[i]=values[i].contains(',')?values[i].split(','):new Array(values[i]);var count=values[i].length-1;for(var j=count;j>=0;j--){if(values[i][j].contains('-')){var val=values[i][j].split('-');for(var k=val[0];k<=val[1];k++){if(!values[i].contains(k)){values[i].push(k+'');}}
values[i].splice(j,1);}}}
if(values[2].contains(cal.year+'')||values[2].contains('*')){if(values[1].contains(cal.month+1+'')||values[1].contains('*')){values[0].each(function(val){if(val>0){blocked.push(val.toInt());}});if(values[3]){for(var i=0;i<last;i++){var day=(i+offset)%7;if(values[3].contains(day+'')){blocked.push(i+1);}}}}}},this);return blocked;},bounds:function(cal){var start=new Date(1000,0,1);var end=new Date(2999,11,31);var date=new Date().getDate()+this.options.direction.toInt();if(this.options.direction>0){start=new Date();start.setDate(date+this.options.pad*cal.id);}
if(this.options.direction<0){end=new Date();end.setDate(date-this.options.pad*(this.calendars.length-cal.id-1));}
cal.els.each(function(el){if(el.get('tag')=='select'){if(el.format.test('(y|Y)')){var years=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if(!years.contains(values[0])){years.push(values[0]);}},this);years.sort(this.sort);if(years[0]>start.getFullYear()){d=new Date(years[0],start.getMonth()+1,0);if(start.getDate()>d.getDate()){start.setDate(d.getDate());}
start.setYear(years[0]);}
if(years.getLast()<end.getFullYear()){d=new Date(years.getLast(),end.getMonth()+1,0);if(end.getDate()>d.getDate()){end.setDate(d.getDate());}
end.setYear(years.getLast());}}
if(el.format.test('(F|m|M|n)')){var months_start=[];var months_end=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if($type(values[0])!='number'||values[0]==years[0]){if(!months_start.contains(values[1])){months_start.push(values[1]);}}
if($type(values[0])!='number'||values[0]==years.getLast()){if(!months_end.contains(values[1])){months_end.push(values[1]);}}},this);months_start.sort(this.sort);months_end.sort(this.sort);if(months_start[0]>start.getMonth()){d=new Date(start.getFullYear(),months_start[0]+1,0);if(start.getDate()>d.getDate()){start.setDate(d.getDate());}
start.setMonth(months_start[0]);}
if(months_end.getLast()<end.getMonth()){d=new Date(start.getFullYear(),months_end.getLast()+1,0);if(end.getDate()>d.getDate()){end.setDate(d.getDate());}
end.setMonth(months_end.getLast());}}}},this);return{'start':start,'end':end};},caption:function(cal){var navigation={prev:{'month':true,'year':true},next:{'month':true,'year':true}};if(cal.year==cal.start.getFullYear()){navigation.prev.year=false;if(cal.month==cal.start.getMonth()&&this.options.navigation==1){navigation.prev.month=false;}}
if(cal.year==cal.end.getFullYear()){navigation.next.year=false;if(cal.month==cal.end.getMonth()&&this.options.navigation==1){navigation.next.month=false;}}
if($type(cal.months)=='array'){if(cal.months.length==1&&this.options.navigation==2){navigation.prev.month=navigation.next.month=false;}}
var caption=new Element('caption');var prev=new Element('a').addClass(this.classes.prev).appendText('\x3c');var next=new Element('a').addClass(this.classes.next).appendText('\x3e');if(this.options.navigation==2){var month=new Element('span').addClass(this.classes.month).injectInside(caption);if(navigation.prev.month){prev.clone().addEvent('click',function(cal){this.navigate(cal,'m',-1);}.pass(cal,this)).injectInside(month);}
month.adopt(new Element('span').appendText(this.options.months[cal.month]));if(navigation.next.month){next.clone().addEvent('click',function(cal){this.navigate(cal,'m',1);}.pass(cal,this)).injectInside(month);}
var year=new Element('span').addClass(this.classes.year).injectInside(caption);if(navigation.prev.year){prev.clone().addEvent('click',function(cal){this.navigate(cal,'y',-1);}.pass(cal,this)).injectInside(year);}
year.adopt(new Element('span').appendText(cal.year));if(navigation.next.year){next.clone().addEvent('click',function(cal){this.navigate(cal,'y',1);}.pass(cal,this)).injectInside(year);}}
else{if(navigation.prev.month&&this.options.navigation){prev.clone().addEvent('click',function(cal){this.navigate(cal,'m',-1);}.pass(cal,this)).injectInside(caption);}
caption.adopt(new Element('span').addClass(this.classes.month).appendText(this.options.months[cal.month]));caption.adopt(new Element('span').addClass(this.classes.year).appendText(cal.year));if(navigation.next.month&&this.options.navigation){next.clone().addEvent('click',function(cal){this.navigate(cal,'m',1);}.pass(cal,this)).injectInside(caption);}}
return caption;},changed:function(cal){cal.val=this.read(cal);$extend(cal,this.values(cal));this.rebuild(cal);if(!cal.val){return;}
if(cal.val.getDate()<cal.days[0]){cal.val.setDate(cal.days[0]);}
if(cal.val.getDate()>cal.days.getLast()){cal.val.setDate(cal.days.getLast());}
cal.els.each(function(el){el.value=this.format(cal.val,el.format);},this);this.check(cal);this.calendars.each(function(kal){if(kal.visible){this.display(kal);}},this);},check:function(cal){this.calendars.each(function(kal,i){if(kal.val){var change=false;if(i<cal.id){var bound=new Date(Date.parse(cal.val));bound.setDate(bound.getDate()-(this.options.pad*(cal.id-i)));if(bound<kal.val){change=true;}}
if(i>cal.id){var bound=new Date(Date.parse(cal.val));bound.setDate(bound.getDate()+(this.options.pad*(i-cal.id)));if(bound>kal.val){change=true;}}
if(change){if(kal.start>bound){bound=kal.start;}
if(kal.end<bound){bound=kal.end;}
kal.month=bound.getMonth();kal.year=bound.getFullYear();$extend(kal,this.values(kal));kal.val=kal.days.contains(bound.getDate())?bound:null;this.write(kal);if(kal.visible){this.display(kal);}}}
else{kal.month=cal.month;kal.year=cal.year;}},this);},clicked:function(td,day,cal){cal.val=(this.value(cal)==day)?null:new Date(cal.year,cal.month,day);this.write(cal);if(!cal.val){cal.val=this.read(cal);}
if(cal.val){this.check(cal);this.toggle(cal);}
else{td.addClass(this.classes.valid);td.removeClass(this.classes.active);}},display:function(cal){this.calendar.empty();this.calendar.className=this.classes.calendar+' '+this.options.months[cal.month].toLowerCase();var div=new Element('div').injectInside(this.calendar);var table=new Element('table').injectInside(div).adopt(this.caption(cal));var thead=new Element('thead').injectInside(table);var tr=new Element('tr').injectInside(thead);for(var i=0;i<=6;i++){var th=this.options.days[(i+this.options.offset)%7];tr.adopt(new Element('th',{'title':th}).appendText(th.substr(0,1)));}
var tbody=new Element('tbody').injectInside(table);var tr=new Element('tr').injectInside(tbody);var d=new Date(cal.year,cal.month,1);var offset=((d.getDay()-this.options.offset)+7)%7;var last=new Date(cal.year,cal.month+1,0).getDate();var prev=new Date(cal.year,cal.month,0).getDate();var active=this.value(cal);var valid=cal.days;var inactive=[];var hilited=[];this.calendars.each(function(kal,i){if(kal!=cal&&kal.val){if(cal.year==kal.val.getFullYear()&&cal.month==kal.val.getMonth()){inactive.push(kal.val.getDate());}
if(cal.val){for(var day=1;day<=last;day++){d.setDate(day);if((i<cal.id&&d>kal.val&&d<cal.val)||(i>cal.id&&d>cal.val&&d<kal.val)){if(!hilited.contains(day)){hilited.push(day);}}}}}},this);var d=new Date();var today=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();for(var i=1;i<43;i++){if((i-1)%7==0){tr=new Element('tr').injectInside(tbody);}
var td=new Element('td').injectInside(tr);var day=i-offset;var date=new Date(cal.year,cal.month,day);var cls='';if(day===active){cls=this.classes.active;}
else if(inactive.contains(day)){cls=this.classes.inactive;}
else if(valid.contains(day)){cls=this.classes.valid;}
else if(day>=1&&day<=last){cls=this.classes.invalid;}
if(date.getTime()==today){cls=cls+' '+this.classes.today;}
if(hilited.contains(day)){cls=cls+' '+this.classes.hilite;}
td.addClass(cls);if(valid.contains(day)){td.setProperty('title',this.format(date,'D M jS Y'));td.addEvents({'click':function(td,day,cal){this.clicked(td,day,cal);}.pass([td,day,cal],this),'mouseover':function(td,cls){td.addClass(cls);}.pass([td,this.classes.hover]),'mouseout':function(td,cls){td.removeClass(cls);}.pass([td,this.classes.hover])});}
if(day<1){day=prev+day;}
else if(day>last){day=day-last;}
td.appendText(day);}},element:function(el,f,cal){if($type(f)=='object'){for(var i in f){if(!this.element(i,f[i],cal)){return false;}}
return true;}
el=$(el);if(!el){return false;}
el.format=f;if(el.get('tag')=='select'){el.addEvent('change',function(cal){this.changed(cal);}.pass(cal,this));}
else{el.readOnly=true;el.addEvent('focus',function(cal){this.toggle(cal);}.pass(cal,this));}
cal.els.push(el);return true;},format:function(date,format){var str='';if(date){var j=date.getDate();var w=date.getDay();var l=this.options.days[w];var n=date.getMonth()+1;var f=this.options.months[n-1];var y=date.getFullYear()+'';var d_st=this.options.day_suffixes[0];var d_nd=this.options.day_suffixes[1];var d_rd=this.options.day_suffixes[2];var d_th=this.options.day_suffixes[3];for(var i=0,len=format.length;i<len;i++){var cha=format.charAt(i);switch(cha){case'y':y=y.substr(2);case'Y':str+=y+this.options.year_suffix;break;case'm':if(n<10){n='0'+n;}
case'n':str+=n;break;case'M':f=f.substr(0,3);case'F':str+=f;break;case'd':if(j<10){j='0'+j;}
case'j':str+=j;break;case'D':l=l.substr(0,3);case'l':str+=l;break;case'N':w+=1;case'w':str+=w;break;case'S':if(j%10==1&&j!='11'){str+=d_st;}
else if(j%10==2&&j!='12'){str+=d_nd;}
else if(j%10==3&&j!='13'){str+=d_rd;}
else{str+=d_th;}
break;default:str+=cha;}}}
return str;},navigate:function(cal,type,n){switch(type){case'm':if($type(cal.months)=='array'){var i=cal.months.indexOf(cal.month)+n;if(i<0||i==cal.months.length){if(this.options.navigation==1){this.navigate(cal,'y',n);}
i=(i<0)?cal.months.length-1:0;}
cal.month=cal.months[i];}
else{var i=cal.month+n;if(i<0||i==12){if(this.options.navigation==1){this.navigate(cal,'y',n);}
i=(i<0)?11:0;}
cal.month=i;}
break;case'y':if($type(cal.years)=='array'){var i=cal.years.indexOf(cal.year)+n;cal.year=cal.years[i];}
else{cal.year+=n;}
break;}
$extend(cal,this.values(cal));if($type(cal.months)=='array'){var i=cal.months.indexOf(cal.month);if(i<0){cal.month=cal.months[0];}}
this.display(cal);},read:function(cal){var arr=[null,null,null];cal.els.each(function(el){var values=this.unformat(el.value,el.format);values.each(function(val,i){if($type(val)=='number'){arr[i]=val;}});},this);if($type(arr[0])=='number'){cal.year=arr[0];}
if($type(arr[1])=='number'){cal.month=arr[1];}
var val=null;if(arr.every(function(i){return $type(i)=='number';})){var last=new Date(arr[0],arr[1]+1,0).getDate();if(arr[2]>last){arr[2]=last;}
val=new Date(arr[0],arr[1],arr[2]);}
return(cal.val==val)?null:val;},rebuild:function(cal){cal.els.each(function(el){if(el.get('tag')=='select'&&el.format.test('^(d|j)$')){var d=this.value(cal);if(!d){d=el.value.toInt();}
el.empty();cal.days.each(function(day){var option=new Element('option',{'selected':(d==day),'value':((el.format=='d'&&day<10)?'0'+day:day)}).appendText(day).injectInside(el);},this);}},this);},sort:function(a,b){return a-b;},toggle:function(cal){document.removeEvent('mousedown',this.fn);if(cal.visible){cal.visible=false;cal.button.removeClass(this.classes.active);this.fx.start('opacity',1,0);}
else{this.fn=function(e,cal){var e=new Event(e);var el=e.target;var stop=false;while(el!=document.body&&el.nodeType==1){if(el==this.calendar){stop=true;}
this.calendars.each(function(kal){if(kal.button==el||kal.els.contains(el)){stop=true;}});if(stop){e.stop();return false;}
else{el=el.parentNode;}}
this.toggle(cal);}.create({'arguments':cal,'bind':this,'event':true});document.addEvent('mousedown',this.fn);this.calendars.each(function(kal){if(kal==cal){kal.visible=true;kal.button.addClass(this.classes.active);}
else{kal.visible=false;kal.button.removeClass(this.classes.active);}},this);var size=window.getScrollSize();var coord=cal.button.getCoordinates();var x=coord.right+this.options.tweak.x;var y=coord.top+this.options.tweak.y;if(!this.calendar.coord){this.calendar.coord=this.calendar.getCoordinates();}
if(x+this.calendar.coord.width>size.x){x-=(x+this.calendar.coord.width-size.x);}
if(y+this.calendar.coord.height>size.y){y-=(y+this.calendar.coord.height-size.y);}
this.calendar.setStyles({left:x+'px',top:y+'px'});if(window.ie6){this.iframe.setStyles({height:this.calendar.coord.height+'px',left:x+'px',top:y+'px',width:this.calendar.coord.width+'px'});}
this.display(cal);this.fx.start('opacity',0,1);}},unformat:function(val,f){f=f.escapeRegExp();var re={d:'([0-9]{2})',j:'([0-9]{1,2})',D:'('+this.options.days.map(function(day){return day.substr(0,3);}).join('|')+')',l:'('+this.options.days.join('|')+')',S:'(st|nd|rd|th)',F:'('+this.options.months.join('|')+')',m:'([0-9]{2})',M:'('+this.options.months.map(function(month){return month.substr(0,3);}).join('|')+')',n:'([0-9]{1,2})',Y:'([0-9]{4})',y:'([0-9]{2})'}
var arr=[];var g='';for(var i=0;i<f.length;i++){var c=f.charAt(i);if(re[c]){arr.push(c);g+=re[c];}
else{g+=c;}}
var matches=val.match('^'+g+'$');var dates=new Array(3);if(matches){matches=matches.slice(1);arr.each(function(c,i){i=matches[i];switch(c){case'y':i='19'+i;case'Y':dates[0]=i.toInt();break;case'F':i=i.substr(0,3);case'M':i=this.options.months.map(function(month){return month.substr(0,3);}).indexOf(i)+1;case'm':case'n':dates[1]=i.toInt()-1;break;case'd':case'j':dates[2]=i.toInt();break;}},this);}
return dates;},value:function(cal){var day=null;if(cal.val){if(cal.year==cal.val.getFullYear()&&cal.month==cal.val.getMonth()){day=cal.val.getDate();}}
return day;},values:function(cal){var years,months,days;cal.els.each(function(el){if(el.get('tag')=='select'){if(el.format.test('(y|Y)')){years=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if(!years.contains(values[0])){years.push(values[0]);}},this);years.sort(this.sort);}
if(el.format.test('(F|m|M|n)')){months=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if($type(values[0])!='number'||values[0]==cal.year){if(!months.contains(values[1])){months.push(values[1]);}}},this);months.sort(this.sort);}
if(el.format.test('(d|j)')&&!el.format.test('^(d|j)$')){days=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if(values[0]==cal.year&&values[1]==cal.month){if(!days.contains(values[2])){days.push(values[2]);}}},this);}}},this);var first=1;var last=new Date(cal.year,cal.month+1,0).getDate();if(cal.year==cal.start.getFullYear()){if(months==null&&this.options.navigation==2){months=[];for(var i=0;i<12;i++){if(i>=cal.start.getMonth()){months.push(i);}}}
if(cal.month==cal.start.getMonth()){first=cal.start.getDate();}}
if(cal.year==cal.end.getFullYear()){if(months==null&&this.options.navigation==2){months=[];for(var i=0;i<12;i++){if(i<=cal.end.getMonth()){months.push(i);}}}
if(cal.month==cal.end.getMonth()){last=cal.end.getDate();}}
var blocked=this.blocked(cal);if($type(days)=='array'){days=days.filter(function(day){if(day>=first&&day<=last&&!blocked.contains(day)){return day;}});}
else{days=[];for(var i=first;i<=last;i++){if(!blocked.contains(i)){days.push(i);}}}
days.sort(this.sort);return{'days':days,'months':months,'years':years};},write:function(cal){this.rebuild(cal);cal.els.each(function(el){el.value=this.format(cal.val,el.format);$('calendar_output_span_'+el.id).innerHTML=this.format(cal.val,el.format);},this);}});Calendar.implement(new Events,new Options);