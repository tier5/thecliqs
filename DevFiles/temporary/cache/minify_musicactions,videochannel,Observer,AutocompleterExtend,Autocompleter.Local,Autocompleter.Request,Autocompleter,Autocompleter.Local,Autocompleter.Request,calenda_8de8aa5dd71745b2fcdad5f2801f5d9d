window.addEvent('domready',function(){addEventsForSocialMusicPopup();});function addEventsForSocialMusicPopup(){$$('a.action-link.show-hide-btn').removeEvents('click').addEvent('click',function(){var parent=this.getParent('.show-hide-action');var popup=parent.getElement('.action-pop-up');$$('.action-pop-up').each(function(el){if(el!=popup)el.hide();});if(!popup.isDisplayed()){var loading=popup.getElement('.add-to-playlist-loading');if(loading){var url=loading.get('rel');loading.show();var checkbox=popup.getElement('.box-checkbox');checkbox.hide();var request=new Request.HTML({url:url,onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){elements=Elements.from(responseHTML);if(elements.length>0){checkbox.empty();checkbox.adopt(elements);eval(responseJavaScript);loading.hide();checkbox.show();var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');var y_position=popup.getPosition(layout_parent).y;var p_height=layout_parent.getHeight();var c_height=popup.getHeight();if(p_height-y_position<(c_height+1)){layout_parent.addClass('popup-padding-bottom');var margin_bottom=parseInt(layout_parent.getStyle('padding-bottom').replace(/\D+/g,''));layout_parent.setStyle('padding-bottom',(margin_bottom+c_height+1+y_position-p_height)+'px');}}}});request.send();}}
popup.toggle();var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}
var y_position=popup.getPosition(layout_parent).y;var p_height=layout_parent.getHeight();var c_height=popup.getHeight();if(popup.isDisplayed()){if(p_height-y_position<(c_height+1)){layout_parent.addClass('popup-padding-bottom');layout_parent.setStyle('padding-bottom',(c_height+1+y_position-p_height)+'px');}
else if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}}
else{if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}}});$$('a.action-link.cancel').removeEvents('click').addEvent('click',function(){var parent=this.getParent('.action-pop-up');if(parent){parent.hide();var layout_parent=parent.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}}});}
function setCookie(cname,cvalue,exdays){var d=new Date();d.setTime(d.getTime()+(exdays*24*60*60*1000));var expires="expires="+d.toUTCString();document.cookie=cname+"="+cvalue+"; "+expires;}
function getCookie(cname){var name=cname+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1);if(c.indexOf(name)!=-1)return c.substring(name.length,c.length);}
return"";}
function ynmusicLike(obj,itemType,itemId){obj.getElement('i.fa').removeClass('fa-thumbs-up').addClass('fa-spinner').addClass('fa-pulse');obj.set('onclick','');new Request.JSON({url:en4.core.baseUrl+'core/comment/like',method:'post',data:{format:'json',type:itemType,id:itemId,comment_id:0},onSuccess:function(responseJSON,responseText){if(responseJSON.status==true){obj.getElement('i.fa').addClass('fa-thumbs-up').removeClass('fa-spinner').removeClass('fa-pulse');obj.set('onclick','ynmusicUnlike(this,"'+itemType+'","'+itemId+'")');obj.addClass('liked');var label=obj.getElement('.label');if(label)label.set('text',en4.core.language.translate('Unlike'));else obj.set('title',en4.core.language.translate('Unlike'));var li=obj.getParent('.music-item');if(li){var spans=li.getElements('.like-count span');spans.each(function(el){var count=parseInt(el.get('text'));count=count+1;el.set('text',count);});}
var div=$('music-detail-'+itemType+'_'+itemId);if(div){var spans=div.getElements('.like_count span');spans.each(function(el){var count=parseInt(el.get('text'));count=count+1;el.set('text',count);});}}}}).send();}
function ynmusicUnlike(obj,itemType,itemId){obj.getElement('i.fa').removeClass('fa-thumbs-up').addClass('fa-spinner').addClass('fa-pulse');obj.set('onclick','');new Request.JSON({url:en4.core.baseUrl+'core/comment/unlike',method:'post',data:{format:'json',type:itemType,id:itemId,comment_id:0},onSuccess:function(responseJSON,responseText){if(responseJSON.status==true){obj.getElement('i.fa').addClass('fa-thumbs-up').removeClass('fa-spinner').removeClass('fa-pulse');obj.set('onclick','ynmusicLike(this,"'+itemType+'","'+itemId+'")');obj.removeClass('liked');var label=obj.getElement('.label');if(label)label.set('text',en4.core.language.translate('Like'));else obj.set('title',en4.core.language.translate('Like'));var li=obj.getParent('.music-item');if(li){var spans=li.getElements('.like-count span');spans.each(function(el){var count=parseInt(el.get('text'));count=count-1;el.set('text',count);});}
var div=$('music-detail-'+itemType+'_'+itemId);if(div){var spans=div.getElements('.like_count span');spans.each(function(el){var count=parseInt(el.get('text'));count=count-1;el.set('text',count);});}}}}).send();};function ynvideochannelAddNewPlaylist(ele,guid,url){var nextEle=ele.getNext();if(nextEle.hasClass("ynvideochannel_active_add_playlist")){nextEle.removeClass("ynvideochannel_active_add_playlist");nextEle.setStyle("display","none");}else{nextEle.addClass("ynvideochannel_active_add_playlist");nextEle.setStyle("display","block");}
$$('.play_list_span').each(function(el){if(el===nextEle){}else{el.empty();el.setStyle("display","none");el.removeClass("ynvideochannel_active_add_playlist");}});var data=guid;var request=new Request.HTML({url:url,data:{subject:data,},onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){var spanEle=nextEle;spanEle.innerHTML=responseHTML;eval(responseJavaScript);var popup=spanEle.getParent('.ynvideochannel-action-pop-up');var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');var y_position=popup.getPosition(layout_parent).y;var p_height=layout_parent.getHeight();var c_height=popup.getHeight();if(p_height-y_position<(c_height+65)){layout_parent.addClass('popup-padding-bottom');var margin_bottom=parseInt(layout_parent.getStyle('padding-bottom').replace(/\D+/g,''));layout_parent.setStyle('padding-bottom',(margin_bottom+c_height+65+y_position-p_height)+'px');}}});request.send();}
function ynvideochannelAddToPlaylist(ele,playlistId,guild,url){var checked=ele.get('checked');var data=guild;var request=new Request.JSON({url:url,data:{subject:data,playlist_id:playlistId,checked:checked,},onSuccess:function(responseJSON){if(!responseJSON.status){ele.set('checked',!checked);}
var div=ele.getParent('.ynvideochannel-action-pop-up');var notices=div.getElement('.add-to-playlist-notices');var notice=new Element('div',{'class':'add-to-playlist-notice',text:responseJSON.message});notices.adopt(notice);notice.fade('in');(function(){notice.fade('out').get('tween').chain(function(){notice.destroy();});}).delay(2000,notice);}});request.send();}
function ynvideochannelAddToFavorite(ele,video_id,url,favtext,unfavtext){var popup=ele.getParent('.ynvideochannel-action-pop-up');var favorite=popup.getElement('.favorite-loading');if(favorite){favorite.show();}
var favorite_link=popup.getElement('.favorite_link');if(favorite_link){favorite_link.hide();}
var request=new Request.JSON({url:url,data:{id:video_id},onSuccess:function(responseJSON){if(favorite){favorite.hide();}
if(favorite_link){favorite_link.show();}
if(responseJSON.result){if(responseJSON.added==1){var html='<i class="fa fa-star"></i>'+' '+unfavtext;ele.innerHTML=html;}else{var html='<i class="fa fa-star-o"></i>'+' '+favtext;ele.innerHTML=html;}}
var notices=popup.getElement('.add-to-playlist-notices');var notice=new Element('div',{'class':'add-to-playlist-notice',text:responseJSON.message});notices.adopt(notice);notice.fade('in');(function(){notice.fade('out').get('tween').chain(function(){notice.destroy();});}).delay(2000,notice);}});request.send();}
window.addEvent('domready',function(){ynvideochannelAddToOptions();});(function($,$$){var events;var check=function(e){var target=$(e.target);var parents=target.getParents();events.each(function(item){var element=item.element;if(element!=target&&!parents.contains(element))
item.fn.call(element,e);});};Element.Events.outerClick={onAdd:function(fn){if(!events){document.addEvent('click',check);events=[];}
events.push({element:this,fn:fn});},onRemove:function(fn){events=events.filter(function(item){return item.element!=this||item.fn!=fn;},this);if(!events.length){document.removeEvent('click',check);events=null;}}};})(document.id,$$);function ynvideochannelAddToOptions(){$$('a.ynvideochannel-action-link.show-hide-btn').removeEvents('click').addEvent('click',function(){var parent=this.getParent('.action-container');var popup=parent.getElement('.ynvideochannel-action-pop-up');var parent_active=$$('.ynvideochannel_video-channel-playlist_options').length;$$('.action-container').each(function(el){el.removeClass("ynvideochannel-action-shown");});if(parent_active){this.getParents('.ynvideochannel_video-channel-playlist_options').toggleClass('ynvideochannel-addtoplaylist-active');}
var pageParent=popup.getParent('#global_content');var otherPopup=pageParent.getElement('.ynvideochannel_button_more_explain');if(otherPopup!=null){otherPopup.hide();}
$$('.ynvideochannel-action-pop-up').each(function(el){if(el!=popup)el.hide();});if(!popup.isDisplayed()){parent.addClass("ynvideochannel-action-shown");var loading=popup.getElement('.add-to-playlist-loading');if(loading){var url=loading.get('rel');loading.show();var checkbox=popup.getElement('.box-checkbox');checkbox.hide();var request=new Request.HTML({url:url,onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){elements=Elements.from(responseHTML);if(elements.length>0){checkbox.empty();checkbox.adopt(elements);eval(responseJavaScript);loading.hide();checkbox.show();var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');var y_position=popup.getPosition(layout_parent).y;var p_height=layout_parent.getHeight();var c_height=popup.getHeight();if(p_height-y_position<(c_height+65)){layout_parent.addClass('popup-padding-bottom');var margin_bottom=parseInt(layout_parent.getStyle('padding-bottom').replace(/\D+/g,''));layout_parent.setStyle('padding-bottom',(margin_bottom+c_height+65+y_position-p_height)+'px');}}}});request.send();}
var favorite=popup.getElement('.favorite-loading');if(favorite){var url=favorite.get('rel');favorite.show();var favorite_link=popup.getElement('.favorite_link');favorite_link.hide();var request=new Request.HTML({url:url,onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){elements=Elements.from(responseHTML);if(elements.length>0){favorite_link.empty();favorite_link.adopt(elements);eval(responseJavaScript);favorite.hide();favorite_link.show();}}});request.send();}}else{parent.removeClass("ynvideochannel-action-shown");}
popup.toggle();var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}
var y_position=popup.getPosition(layout_parent).y;var p_height=layout_parent.getHeight();var c_height=popup.getHeight();if(popup.isDisplayed()){if(p_height-y_position<(c_height+1)){layout_parent.addClass('popup-padding-bottom');layout_parent.setStyle('padding-bottom',(c_height+1+y_position-p_height)+'px');}
else if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}}
else{if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}}});$$('.ynvideochannel-action-add-playlist').addEvent('outerClick',function(){var popup=this.getElement('.ynvideochannel-action-pop-up');var display_popup=popup.getStyle('display');var parent_popup_active=this.getParents('.ynvideochannel_video-channel-playlist_options');if(display_popup='block'){popup.setStyle('display','none');};if(this.hasClass('ynvideochannel-action-shown')){this.removeClass('ynvideochannel-action-shown');}
if(parent_popup_active.hasClass('ynvideochannel-addtoplaylist-active')){parent_popup_active.removeClass('ynvideochannel-addtoplaylist-active');}});$$('a.ynvideochannel-action-link.cancel').removeEvents('click').addEvent('click',function(){var parent=this.getParent('.ynvideochannel-action-pop-up');if(parent){parent.hide();var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');if(layout_parent.hasClass('popup-padding-bottom')){layout_parent.setStyle('padding-bottom','0');}}});}
function ynvideochannelVideoOptions(){var parent_active=$$('.ynvideochannel_video-channel-playlist_options').length;$$('.ynvideochannel_video_options-btn').removeEvents('click').addEvent('click',function(){this.getParent('.ynvideochannel_video_options').toggleClass('explained');if(parent_active){this.getParents('.ynvideochannel_video-channel-playlist_options').toggleClass('ynvideochannel-options-active');}});$$('.ynvideochannel_video_options-btn').addEvent('outerClick',function(){var popup=this.getParent('.ynvideochannel_video_options');var parent_popup=this.getParents('.ynvideochannel_video-channel-playlist_options');if(popup.hasClass('explained')){popup.removeClass('explained');}
if(parent_popup.hasClass('ynvideochannel-options-active')){parent_popup.removeClass('ynvideochannel-options-active');}});}
function ynvideochannelChannelOptions(){$$('.ynvideochannel_channel_options-btn').removeEvents('click').addEvent('click',function(){var popup=this.getParent('.ynvideochannel_channel_options');popup.toggleClass('explained');var layout_parent=popup.getParent('.layout_middle');if(!layout_parent)layout_parent=popup.getParent('#global_content');var y_position=popup.getPosition(layout_parent).y;var p_height=layout_parent.getHeight();var c_height=popup.getElement('.ynvideochannel_channel_options-block').getHeight();if(p_height-y_position<(c_height+60)){layout_parent.addClass('popup-padding-bottom');var margin_bottom=parseInt(layout_parent.getStyle('padding-bottom').replace(/\D+/g,''));layout_parent.setStyle('padding-bottom',(margin_bottom+c_height+80+y_position-p_height)+'px');}});$$('.ynvideochannel_channel_options').addEvent('outerClick',function(){var popup=this;if(popup.hasClass('explained')){popup.removeClass('explained');$$('.owl-next').setStyle('display','block');}})}
function ynvideochannelPlaylistOptions(){var parent_active=$$('.ynvideochannel_video-channel-playlist_options').length;$$('.ynvideochannel_video_options-btn').removeEvents('click').addEvent('click',function(){this.getParent('.ynvideochannel_video_options').toggleClass('explained');if(parent_active){this.getParents('.ynvideochannel_video-channel-playlist_options').toggleClass('ynvideochannel-options-active');}});$$('.ynvideochannel_video_options-btn').addEvent('outerClick',function(){var popup=this.getParent('.ynvideochannel_video_options');var parent_popup=this.getParents('.ynvideochannel_video-channel-playlist_options');if(popup.hasClass('explained')){popup.removeClass('explained');}
if(parent_popup.hasClass('ynvideochannel-options-active')){parent_popup.removeClass('ynvideochannel-options-active');}})};var Observer=new Class({Implements:[Options,Events],options:{periodical:false,delay:1000},initialize:function(el,onFired,options){this.element=$(el)||$$(el);this.addEvent('onFired',onFired);this.setOptions(options);this.bound=this.changed.bind(this);this.resume();},changed:function(){var value=this.element.get('value');if($equals(this.value,value))return;this.clear();this.value=value;this.timeout=this.onFired.delay(this.options.delay,this);},setValue:function(value){this.value=value;this.element.set('value',value);return this.clear();},onFired:function(){this.fireEvent('onFired',[this.value,this.element]);},clear:function(){$clear(this.timeout||null);return this;},pause:function(){if(this.timer)$clear(this.timer);else this.element.removeEvent('keyup',this.bound);return this.clear();},resume:function(){this.value=this.element.get('value');if(this.options.periodical)this.timer=this.changed.periodical(this.options.periodical,this);else this.element.addEvent('keyup',this.bound);return this;}});var $equals=function(obj1,obj2){return(obj1==obj2||JSON.encode(obj1)==JSON.encode(obj2));};;var Autocompleter2=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:true,width:'inherit',maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:true,className:'autocompleter-choices',zIndex:42,delay:1,observerOptions:{},fxOptions:{},autoSubmit:false,overflow:false,overflowMargin:25,selectFirst:true,filter:null,filterCase:false,filterSubset:false,forceSelect:false,selectMode:true,choicesMatch:null,multiple:false,separator:', ',separatorSplit:/\s*[,;]\s*/,autoTrim:false,allowDupes:false,toValues:'toValues',cache:true,relative:true,tokenFormat:'object',tokenIdKey:'id',tokenValueKey:'label',prefetchOnInit:false,alwaysOpen:false,ignoreKeys:false,ignoreOverlayFix:false},initialize:function(element,options){this.element=$(element);this.setOptions(options);this.build();this.observer=new Observer(this.element,this.prefetch.bind(this),$merge({'delay':this.options.delay},this.options.observerOptions));this.queryValue=null;if(this.options.filter)this.filter=this.options.filter.bind(this);var mode=this.options.selectMode;this.typeAhead=(mode=='type-ahead');this.selectMode=(mode===true)?'selection':mode;this.cached=[];if(this.options.prefetchOnInit)this.prefetch.delay(this.options.delay+50,this);},build:function(){if($(this.options.customChoices)){this.choices=this.options.customChoices;}else{this.choices=new Element('ul',{'class':this.options.className,'styles':{'zIndex':this.options.zIndex}}).inject(document.body);this.relative=false;if(this.options.relative){this.choices.inject(this.element,'after');this.relative=this.element.getOffsetParent();}
if(!this.options.ignoreOverlayFix)this.fix=new OverlayFix2(this.choices);}
if(!this.options.separator.test(this.options.separatorSplit)){this.options.separatorSplit=this.options.separator;}
if(!this.options.alwaysOpen){this.fx=(!this.options.fxOptions)?null:new Fx.Tween(this.choices,$merge({'property':'opacity','link':'cancel','duration':200},this.options.fxOptions)).addEvent('onStart',Chain.prototype.clearChain).set(0);}
this.element.setProperty('autocomplete','off').addEvent((Browser.Engine.trident||Browser.Engine.webkit)?'keydown':'keypress',this.onCommand.bind(this)).addEvent('click',this.onCommand.bind(this,[false]));if(!this.options.alwaysOpen){this.element.addEvent('focus',this.toggleFocus.create({bind:this,arguments:true,delay:100})).addEvent('blur',this.toggleFocus.create({bind:this,arguments:false,delay:100}));}},destroy:function(){if(this.fix)this.fix.destroy();this.choices=this.selected=this.choices.destroy();},toggleFocus:function(state){this.focussed=state;if(!state)this.hideChoices(true);this.fireEvent((state)?'onFocus':'onBlur',[this.element]);},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift&&!this.options.ignoreKeys){switch(e.key){case'enter':e.stop();if(!this.selected||!this.visible){if(!this.options.customChoices){addNewChoice(this.element,this.options.toValues);}}
if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}
break;case'up':case'down':var value=this.element.value;if(!this.prefetch()&&this.queryValue!==null){var up=(e.key=='up');this.choiceOver((this.selected||this.choices)[(this.selected)?((up)?'getPrevious':'getNext'):((up)?'getLast':'getFirst')](this.options.choicesMatch),true);this.element.value=value;}
return false;case'esc':this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;case'tab':if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}else{this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;}}}
this.fireEvent('onCommand',e);return true;},setSelection:function(finish){var tokenInfo=this.selected.retrieve('autocompleteChoice');var input=(this.options.tokenFormat=='object'?tokenInfo[this.options.tokenValueKey]:tokenInfo);var value=input;var start=this.queryValue.length,end=input.length;if((input.substr(0,start)||'').toLowerCase()!=(this.queryValue||'').toLowerCase())start=0;if(this.options.multiple){var split=this.options.separatorSplit;value=this.element.value;start+=this.queryIndex;end+=this.queryIndex;var old=value.substr(this.queryIndex).split(split,1)[0];value=value.substr(0,this.queryIndex)+input+value.substr(this.queryIndex+old.length);if(finish){var tokens=value.split(this.options.separatorSplit).filter(function(entry){return this.test(entry);},/[^\s,]+/);if(!this.options.allowDupes)tokens=[].combine(tokens);var sep=this.options.separator;value=tokens.join(sep)+sep;end=value.length;}}
if(this.options.autocompleteType=='tag')this.observer.setValue(value);this.opted=value;if(finish||this.selectMode=='pick')start=end;$try(function(){this.element.selectRange(start,end)}.bind(this));this.fireEvent('onSelection',[this.element,this.selected,value,input]);},showChoices:function(){var match=this.options.choicesMatch,first=this.choices.getFirst(match);this.selected=this.selectedValue=null;if(this.fix){var pos=this.element.getCoordinates(this.relative),width=this.options.width||'auto';this.choices.setStyles({'width':(width===true||width=='inherit')?pos.width:width});}
if(!first)return;if(!this.visible){this.visible=true;this.choices.style.display='';if(this.fx)this.fx.start(1);this.fireEvent('onShow',[this.element,this.choices]);}
if(this.options.selectFirst||this.typeAhead||first.inputValue==this.queryValue)this.choiceOver(first,this.typeAhead);var items=this.choices.getChildren(match),max=this.options.maxChoices;var styles={'overflowY':'hidden','height':''};this.overflown=false;if(items.length>max){var item=items[max-1];styles.overflowY='scroll';styles.height=item.getCoordinates(this.choices).bottom;this.overflown=true;};this.choices.setStyles(styles);if(this.fix)this.fix.show();if(this.options.visibleChoices){var scroll=document.getScroll(),size=document.getSize(),coords=this.choices.getCoordinates();if(coords.right>scroll.x+size.x)scroll.x=coords.right-size.x;if(coords.bottom>scroll.y+size.y)scroll.y=coords.bottom-size.y;window.scrollTo(Math.min(scroll.x,coords.left),Math.min(scroll.y,coords.top));}},hideChoices:function(clear){if(clear){var value=this.element.value;if(this.options.forceSelect)value=this.opted;if(this.options.autoTrim){value=value.split(this.options.separatorSplit).filter($arguments(0)).join(this.options.separator);}
this.observer.setValue(value);}
if(!this.visible)return;this.visible=false;if(this.selected)this.selected.removeClass('autocompleter-selected');this.observer.clear();var hide=function(){this.choices.style.display='none';if(this.fix)this.fix.hide();}.bind(this);if(this.fx)this.fx.start(0).chain(hide);else hide();this.fireEvent('onHide',[this.element,this.choices]);},prefetch:function(){var value=this.element.value,query=value;if(this.options.multiple){var split=this.options.separatorSplit;var values=value.split(split);var index=this.element.getSelectedRange().start;var toIndex=value.substr(0,index).split(split);var last=toIndex.length-1;index-=toIndex[last].length;query=values[last];}
if(query.length<this.options.minLength){this.hideChoices();}else{if(query===this.queryValue||(this.visible&&query==this.selectedValue)){if(this.visible)return false;this.showChoices();}else{this.queryValue=query;this.queryIndex=index;if(!this.fetchCached())this.query();}}
return true;},fetchCached:function(){switch(true){case(!this.options.cache):case(!this.cachedQueryValue||this.queryValue.length<this.cachedQueryValue.length):case(this.queryValue.indexOf(this.cachedQueryValue)==-1):return false;break;}
if(this.cached.length<this.options.maxChoices)
{this.update(this.filter(this.cached));return true;}
var newChoices=this.filter(this.cached,this.queryValue);if(newChoices.length>=this.cached.length)
{this.update(this.filter(this.cached));return true;}
return false;},update:function(tokens){$(this.choices).empty();this.cached=tokens;this.cachedQueryValue=this.queryValue;var type=tokens&&$type(tokens);if(!type||(type=='array'&&!tokens.length)||(type=='hash'&&!tokens.getLength())){(this.options.emptyChoices||this.hideChoices).call(this);}else{if(this.options.maxChoices<tokens.length&&!this.options.overflow)tokens.length=this.options.maxChoices;tokens.each(this.options.injectChoice||function(token){tokenValue=(this.options.tokenFormat=='object'?token[this.options.tokenValueKey]:token);var choice=new Element('li',{'html':this.markQueryValue(tokenValue)});this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},this);this.showChoices();}},choiceOver:function(choice,selection){if(!choice||choice==this.selected)return;if(this.selected)this.selected.removeClass('autocompleter-selected');this.selected=choice.addClass('autocompleter-selected');this.fireEvent('onSelect',[this.element,this.selected,selection]);if(!this.selectMode)this.opted=this.element.value;if(!selection)return;this.selectedValue=this.selected.retrieve('autocompleteChoice');if(this.overflown){var coords=this.selected.getCoordinates(this.choices),margin=this.options.overflowMargin,top=this.choices.scrollTop,height=this.choices.offsetHeight,bottom=top+height;if(coords.top-margin<top&&top)this.choices.scrollTop=Math.max(coords.top-margin,0);else if(coords.bottom+margin>bottom)this.choices.scrollTop=Math.min(coords.bottom-height+margin,bottom);}
if(this.selectMode)this.setSelection();},choiceSelect:function(choice){if(choice)this.choiceOver(choice);this.setSelection(true);this.queryValue=false;if(!this.options.alwaysOpen){this.hideChoices();}else{this.observer.setValue('');this.prefetch.delay(this.options.delay,this);}
this.fireEvent('onChoiceSelect',choice);if(this.options.autocompleteType=='message'){this.element.value='';var token=choice.retrieve('autocompleteChoice');if(token.friends){var friend_ids="";for(var id in token.friends){if(friend_ids=="")friend_ids=id;else friend_ids=friend_ids+","+id;}
this.doAddValueToHidden(token.label,friend_ids,this.options.toValues,true,' tag_friend',token.url);}
else
{this.doAddValueToHidden(choice.id,token.id,this.options.toValues,true,null,token.url,token);}}},doAddValueToHidden:function(name,toID,hideLoc,newItem,list,url,token){var hiddenInputField=document.getElementById(hideLoc);var previousToValues=hiddenInputField.value;if(this.checkSpanExists(hideLoc,toID)){if(previousToValues==''){document.getElementById(hideLoc).value=toID;}
else{document.getElementById(hideLoc).value=previousToValues+","+toID;}
this.doPushSpan(name,toID,newItem,hideLoc,list,url,token);}},doPushSpan:function(name,toID,newItem,hideLoc,list,url,token){var myElement=new Element("span");myElement.id=hideLoc+"_tospan_"+toID;switch(token.type){case'user':myElement.addClass("user_tag");myElement.innerHTML="<a target='_blank' href="+url+">"+token.photo+name+"</a>"+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\", \""+this.element.get('id')+"\");'><i class='fa fa-times'></i></a>";break;case'genre':myElement.addClass("genre_tag");myElement.innerHTML="<a target='_blank' href="+url+">"+name+"</a>"+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\", \""+this.element.get('id')+"\");'><i class='fa fa-times'></i></a>";break;case'artist':myElement.addClass("artist_tag");myElement.innerHTML="<a target='_blank' href="+url+">"+name+"</a>"+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\", \""+this.element.get('id')+"\");'><i class='fa fa-times'></i></a>";break;}
document.getElementById(this.options.toValues+'-wrapper').show();document.getElementById(this.options.toValues+'-wrapper').style.height='auto';if(list==null)list="";document.getElementById(this.options.toValues+'-element').appendChild(myElement);this.fireEvent('push');},checkToValue:function(toID,toValues){var checkValue=true;var checkMulti=toID.search(/,/);var x;var toValueArray=toValues.split(",");if(checkMulti!=-1){var recipientsArray=toID.split(",");var multiBool=false;for(var i=0;i<recipientsArray.length;i++){var tempBool=true;for(var x=0;x<toValueArray.length;x++){if(toValueArray[x]==recipientsArray[i]){tempBool=false;}}
multiBool=multiBool||tempBool;}
checkValue=multiBool;}
else{for(x in toValueArray)
{if(toValueArray[x]==toID){checkValue=false;}}}
return checkValue;},checkSpanExists:function(hideLoc,toID){var span_id=hideLoc+"_tospan_"+toID;if($(span_id)){return false;}
else return true;},filter:function(tokens,queryValue){queryValue=queryValue||this.queryValue;tokens=tokens||this.tokens;var regex=new RegExp(((this.options.filterSubset)?'':'^')+queryValue.escapeRegExp(),(this.options.filterCase)?'':'i');if(this.options.tokenFormat=='object'){var key=this.options.tokenValueKey;return tokens.filter(function(token){return regex.test(token[key]);});}else{return tokens.filter(function(token){return regex.test(token);});}
return tokens;},markQueryValue:function(str){return(!this.options.markQuery||!this.queryValue)?str:str.replace(new RegExp('('+((this.options.filterSubset)?'':'^')+this.queryValue.escapeRegExp()+')',(this.options.filterCase)?'':'i'),'<span class="autocompleter-queried">$1</span>');},addChoiceEvents:function(el){return el.addEvents({'mouseover':this.choiceOver.bind(this,el),'click':this.choiceSelect.bind(this,el)});}});var OverlayFix2=new Class({initialize:function(el){if(Browser.Engine.trident){this.element=$(el);this.relative=this.element.getOffsetParent();this.fix=new Element('iframe',{'frameborder':'0','scrolling':'no','src':'javascript:false;','styles':{'position':'absolute','border':'none','display':'none','filter':'progid:DXImageTransform.Microsoft.Alpha(opacity=0)'}}).inject(this.element,'after');}},show:function(){if(this.fix){var coords=this.element.getCoordinates(this.relative);delete coords.right;delete coords.bottom;this.fix.setStyles($extend(coords,{'display':'','zIndex':(this.element.getStyle('zIndex')||1)-1}));}
return this;},hide:function(){if(this.fix)this.fix.style.display='none';return this;},destroy:function(){if(this.fix)this.fix=this.fix.destroy();}});Element.implement({getSelectedRange:function(){if(!Browser.Engine.trident)return{start:this.selectionStart,end:this.selectionEnd};var pos={start:0,end:0};var range=this.getDocument().selection.createRange();if(!range||range.parentElement()!=this)return pos;var dup=range.duplicate();if(this.type=='text'){pos.start=0-dup.moveStart('character',-100000);pos.end=pos.start+range.text.length;}else{var value=this.value;var offset=value.length-value.match(/[\n\r]*$/)[0].length;dup.moveToElementText(this);dup.setEndPoint('StartToEnd',range);pos.end=offset-dup.text.length;dup.setEndPoint('StartToStart',range);pos.start=offset-dup.text.length;}
return pos;},selectRange:function(start,end){if(Browser.Engine.trident){var diff=this.value.substr(start,end-start).replace(/\r/g,'').length;start=this.value.substr(0,start).replace(/\r/g,'').length;var range=this.createTextRange();range.collapse(true);range.moveEnd('character',start+diff);range.moveStart('character',start);range.select();}else{this.focus();this.setSelectionRange(start,end);}
return this;}});Autocompleter2.Base=Autocompleter2;;Autocompleter2.Local=new Class({Extends:Autocompleter2,options:{minLength:0,delay:200},initialize:function(element,tokens,options){this.parent(element,options);this.tokens=tokens;},query:function(){this.update(this.filter());}});;Autocompleter2.Request=new Class({Extends:Autocompleter2,options:{postData:{},ajaxOptions:{},postVar:'value',delay:250},query:function(){var data=$unlink(this.options.postData)||{};data[this.options.postVar]=this.queryValue;var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','');var cls=this.options.indicatorClass;if(cls)this.element.addClass(cls);this.fireEvent('onRequest',[this.element,this.request,data,this.queryValue]);this.request.send({'data':data});},queryResponse:function(){var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','none');var cls=this.options.indicatorClass;if(cls)this.element.removeClass(cls);return this.fireEvent('onComplete',[this.element,this.request]);}});Autocompleter2.Request.JSON=new Class({Extends:Autocompleter2.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.JSON($merge({'url':url,'link':'cancel'},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(response){this.parent();this.update(response);}});Autocompleter2.Request.HTML=new Class({Extends:Autocompleter2.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.HTML($merge({'url':url,'link':'cancel','update':this.choices},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(tree,elements){this.parent();if(!elements||!elements.length){this.hideChoices();}else{this.choices.getChildren(this.options.choicesMatch).each(this.options.injectChoice||function(choice){var value=choice.innerHTML;choice.inputValue=value;this.addChoiceEvents(choice.set('html',this.markQueryValue(value)));},this);this.showChoices();}}});Autocompleter2.Ajax={Base:Autocompleter2.Request,Json:Autocompleter2.Request.JSON,Xhtml:Autocompleter2.Request.HTML};;var Autocompleter=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:true,width:'inherit',maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:true,className:'autocompleter-choices',zIndex:42,delay:1,observerOptions:{},fxOptions:{},autoSubmit:false,overflow:false,overflowMargin:25,selectFirst:true,filter:null,filterCase:false,filterSubset:false,forceSelect:false,selectMode:true,choicesMatch:null,multiple:false,separator:', ',separatorSplit:/\s*[,;]\s*/,autoTrim:false,allowDupes:false,cache:true,relative:true,tokenFormat:'object',tokenIdKey:'id',tokenValueKey:'label',prefetchOnInit:false,alwaysOpen:false,ignoreKeys:false,ignoreOverlayFix:false},initialize:function(element,options){this.element=$(element);this.setOptions(options);this.build();this.observer=new Observer(this.element,this.prefetch.bind(this),$merge({'delay':this.options.delay},this.options.observerOptions));this.queryValue=null;if(this.options.filter)this.filter=this.options.filter.bind(this);var mode=this.options.selectMode;this.typeAhead=(mode=='type-ahead');this.selectMode=(mode===true)?'selection':mode;this.cached=[];if(this.options.prefetchOnInit)this.prefetch.delay(this.options.delay+50,this);},build:function(){if($(this.options.customChoices)){this.choices=this.options.customChoices;}else{this.choices=new Element('ul',{'class':this.options.className,'styles':{'zIndex':this.options.zIndex}}).inject(document.body);this.relative=false;if(this.options.relative){this.choices.inject(this.element,'after');this.relative=this.element.getOffsetParent();}
if(!this.options.ignoreOverlayFix)this.fix=new OverlayFix(this.choices);}
if(!this.options.separator.test(this.options.separatorSplit)){this.options.separatorSplit=this.options.separator;}
if(!this.options.alwaysOpen){this.fx=(!this.options.fxOptions)?null:new Fx.Tween(this.choices,$merge({'property':'opacity','link':'cancel','duration':200},this.options.fxOptions)).addEvent('onStart',Chain.prototype.clearChain).set(0);}
this.element.setProperty('autocomplete','off').addEvent((Browser.Engine.trident||Browser.Engine.webkit)?'keydown':'keypress',this.onCommand.bind(this)).addEvent('click',this.onCommand.bind(this,[false]));if(!this.options.alwaysOpen){this.element.addEvent('focus',this.toggleFocus.create({bind:this,arguments:true,delay:100})).addEvent('blur',this.toggleFocus.create({bind:this,arguments:false,delay:100}));}},destroy:function(){if(this.fix)this.fix.destroy();this.choices=this.selected=this.choices.destroy();},toggleFocus:function(state){this.focussed=state;if(!state)this.hideChoices(true);this.fireEvent((state)?'onFocus':'onBlur',[this.element]);},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift&&!this.options.ignoreKeys){switch(e.key){case'enter':e.stop();if(!this.selected){if(!this.options.customChoices){this.element.value='';}
return true;}
if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}
break;case'up':case'down':var value=this.element.value;if(!this.prefetch()&&this.queryValue!==null){var up=(e.key=='up');this.choiceOver((this.selected||this.choices)[(this.selected)?((up)?'getPrevious':'getNext'):((up)?'getLast':'getFirst')](this.options.choicesMatch),true);this.element.value=value;}
return false;case'esc':this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;case'tab':if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}else{this.hideChoices(true);if(!this.options.customChoices)this.element.value='';break;}}}
this.fireEvent('onCommand',e);return true;},setSelection:function(finish){var tokenInfo=this.selected.retrieve('autocompleteChoice');var input=(this.options.tokenFormat=='object'?tokenInfo[this.options.tokenValueKey]:tokenInfo);var value=input;var start=this.queryValue.length,end=input.length;if((input.substr(0,start)||'').toLowerCase()!=(this.queryValue||'').toLowerCase())start=0;if(this.options.multiple){var split=this.options.separatorSplit;value=this.element.value;start+=this.queryIndex;end+=this.queryIndex;var old=value.substr(this.queryIndex).split(split,1)[0];value=value.substr(0,this.queryIndex)+input+value.substr(this.queryIndex+old.length);if(finish){var tokens=value.split(this.options.separatorSplit).filter(function(entry){return this.test(entry);},/[^\s,]+/);if(!this.options.allowDupes)tokens=[].combine(tokens);var sep=this.options.separator;value=tokens.join(sep)+sep;end=value.length;}}
if(this.options.autocompleteType=='tag')this.observer.setValue(value);this.opted=value;if(finish||this.selectMode=='pick')start=end;$try(function(){this.element.selectRange(start,end)}.bind(this));this.fireEvent('onSelection',[this.element,this.selected,value,input]);},showChoices:function(){var match=this.options.choicesMatch,first=this.choices.getFirst(match);this.selected=this.selectedValue=null;if(this.fix){var pos=this.element.getCoordinates(this.relative),width=this.options.width||'auto';this.choices.setStyles({'width':(width===true||width=='inherit')?pos.width:width});}
if(!first)return;if(!this.visible){this.visible=true;this.choices.setStyle('display','');if(this.fx)this.fx.start(1);this.fireEvent('onShow',[this.element,this.choices]);}
if(this.options.selectFirst||this.typeAhead||first.inputValue==this.queryValue)this.choiceOver(first,this.typeAhead);var items=this.choices.getChildren(match),max=this.options.maxChoices;var styles={'overflowY':'hidden','height':''};this.overflown=false;if(items.length>max){var item=items[max-1];styles.overflowY='scroll';styles.height=item.getCoordinates(this.choices).bottom;this.overflown=true;};this.choices.setStyles(styles);if(this.fix)this.fix.show();if(this.options.visibleChoices){var scroll=document.getScroll(),size=document.getSize(),coords=this.choices.getCoordinates();if(coords.right>scroll.x+size.x)scroll.x=coords.right-size.x;if(coords.bottom>scroll.y+size.y)scroll.y=coords.bottom-size.y;window.scrollTo(Math.min(scroll.x,coords.left),Math.min(scroll.y,coords.top));}},hideChoices:function(clear){if(clear){var value=this.element.value;if(this.options.forceSelect)value=this.opted;if(this.options.autoTrim){value=value.split(this.options.separatorSplit).filter($arguments(0)).join(this.options.separator);}
this.observer.setValue(value);}
if(!this.visible)return;this.visible=false;if(this.selected)this.selected.removeClass('autocompleter-selected');this.observer.clear();var hide=function(){this.choices.setStyle('display','none');if(this.fix)this.fix.hide();}.bind(this);if(this.fx)this.fx.start(0).chain(hide);else hide();this.fireEvent('onHide',[this.element,this.choices]);},prefetch:function(){var value=this.element.value,query=value;if(this.options.multiple){var split=this.options.separatorSplit;var values=value.split(split);var index=this.element.getSelectedRange().start;var toIndex=value.substr(0,index).split(split);var last=toIndex.length-1;index-=toIndex[last].length;query=values[last];}
if(query.length<this.options.minLength){this.hideChoices();}else{if(query===this.queryValue||(this.visible&&query==this.selectedValue)){if(this.visible)return false;this.showChoices();}else{this.queryValue=query;this.queryIndex=index;if(!this.fetchCached())this.query();}}
return true;},fetchCached:function(){switch(true){case(!this.options.cache):case(!this.cachedQueryValue||this.queryValue.length<this.cachedQueryValue.length):case(this.queryValue.indexOf(this.cachedQueryValue)==-1):return false;break;}
if(this.cached.length<this.options.maxChoices)
{this.update(this.filter(this.cached));return true;}
var newChoices=this.filter(this.cached,this.queryValue);if(newChoices.length>=this.cached.length)
{this.update(this.filter(this.cached));return true;}
return false;},update:function(tokens){$(this.choices).empty();this.cached=tokens;this.cachedQueryValue=this.queryValue;var type=tokens&&$type(tokens);if(!type||(type=='array'&&!tokens.length)||(type=='hash'&&!tokens.getLength())){(this.options.emptyChoices||this.hideChoices).call(this);}else{if(this.options.maxChoices<tokens.length&&!this.options.overflow)tokens.length=this.options.maxChoices;tokens.each(this.options.injectChoice||function(token){tokenValue=(this.options.tokenFormat=='object'?token[this.options.tokenValueKey]:token);var choice=new Element('li',{'html':this.markQueryValue(tokenValue)});this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},this);this.showChoices();}},choiceOver:function(choice,selection){if(!choice||choice==this.selected)return;if(this.selected)this.selected.removeClass('autocompleter-selected');this.selected=choice.addClass('autocompleter-selected');this.fireEvent('onSelect',[this.element,this.selected,selection]);if(!this.selectMode)this.opted=this.element.value;if(!selection)return;this.selectedValue=this.selected.retrieve('autocompleteChoice');if(this.overflown){var coords=this.selected.getCoordinates(this.choices),margin=this.options.overflowMargin,top=this.choices.scrollTop,height=this.choices.offsetHeight,bottom=top+height;if(coords.top-margin<top&&top)this.choices.scrollTop=Math.max(coords.top-margin,0);else if(coords.bottom+margin>bottom)this.choices.scrollTop=Math.min(coords.bottom-height+margin,bottom);}
if(this.selectMode)this.setSelection();},choiceSelect:function(choice){if(choice)this.choiceOver(choice);this.setSelection(true);this.queryValue=false;if(!this.options.alwaysOpen){this.hideChoices();}else{this.observer.setValue('');this.prefetch.delay(this.options.delay,this);}
this.fireEvent('onChoiceSelect',choice);if(this.options.autocompleteType=='message'){this.element.value='';var token=choice.retrieve('autocompleteChoice');if(token.friends){var friend_ids="";for(var id in token.friends){if(friend_ids=="")friend_ids=id;else friend_ids=friend_ids+","+id;}
this.doAddValueToHidden(token.label,friend_ids,'toValues',true,' tag_friend');}
else this.doAddValueToHidden(choice.id,token.id,'toValues',true);}},doAddValueToHidden:function(name,toID,hideLoc,newItem,list){var hiddenInputField=document.getElementById(hideLoc);var previousToValues=hiddenInputField.value;if(this.checkSpanExists(name,toID)){if(previousToValues==''){document.getElementById(hideLoc).value=toID;}
else{document.getElementById(hideLoc).value=previousToValues+","+toID;}
this.doPushSpan(name,toID,newItem,hideLoc,list);}},doPushSpan:function(name,toID,newItem,hideLoc,list){var myElement=new Element("span");if(newItem){myElement.id="tospan_"+name+"_"+toID;myElement.innerHTML=name+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\");'>x</a>";}
else{myElement.id="tospan_"+name+"_"+toID;myElement.innerHTML=name+" <a href='javascript:void(0);' onclick='this.parentNode.destroy();removeFromToValue(\""+toID+"\", \""+hideLoc+"\");'>x</a>";}
$('toValues-wrapper').setStyle('height','auto');if(list==null)list="";myElement.addClass("tag"+list);document.getElementById('toValues-element').appendChild(myElement);this.fireEvent('push');},checkToValue:function(toID,toValues){var checkValue=true;var checkMulti=toID.search(/,/);var x;var toValueArray=toValues.split(",");if(checkMulti!=-1){var recipientsArray=toID.split(",");var multiBool=false;for(var i=0;i<recipientsArray.length;i++){var tempBool=true;for(var x=0;x<toValueArray.length;x++){if(toValueArray[x]==recipientsArray[i]){tempBool=false;}}
multiBool=multiBool||tempBool;}
checkValue=multiBool;}
else{for(x in toValueArray)
{if(toValueArray[x]==toID){checkValue=false;}}}
return checkValue;},checkSpanExists:function(name,toID){var span_id="tospan_"+name+"_"+toID;if($(span_id)){return false;}
else return true;},filter:function(tokens,queryValue){queryValue=queryValue||this.queryValue;tokens=tokens||this.tokens;var regex=new RegExp(((this.options.filterSubset)?'':'^')+queryValue.escapeRegExp(),(this.options.filterCase)?'':'i');if(this.options.tokenFormat=='object'){var key=this.options.tokenValueKey;return tokens.filter(function(token){return regex.test(token[key]);});}else{return tokens.filter(function(token){return regex.test(token);});}
return tokens;},markQueryValue:function(str){return(!this.options.markQuery||!this.queryValue)?str:str.replace(new RegExp('('+((this.options.filterSubset)?'':'^')+this.queryValue.escapeRegExp()+')',(this.options.filterCase)?'':'i'),'<span class="autocompleter-queried">$1</span>');},addChoiceEvents:function(el){return el.addEvents({'mouseover':this.choiceOver.bind(this,el),'click':this.choiceSelect.bind(this,el)});}});var OverlayFix=new Class({initialize:function(el){if(Browser.Engine.trident){this.element=$(el);this.relative=this.element.getOffsetParent();this.fix=new Element('iframe',{'frameborder':'0','scrolling':'no','src':'javascript:false;','styles':{'position':'absolute','border':'none','display':'none','filter':'progid:DXImageTransform.Microsoft.Alpha(opacity=0)'}}).inject(this.element,'after');}},show:function(){if(this.fix){var coords=this.element.getCoordinates(this.relative);delete coords.right;delete coords.bottom;this.fix.setStyles($extend(coords,{'display':'','zIndex':(this.element.getStyle('zIndex')||1)-1}));}
return this;},hide:function(){if(this.fix)this.fix.setStyle('display','none');return this;},destroy:function(){if(this.fix)this.fix=this.fix.destroy();}});Element.implement({getSelectedRange:function(){if(!Browser.Engine.trident)return{start:this.selectionStart,end:this.selectionEnd};var pos={start:0,end:0};var range=this.getDocument().selection.createRange();if(!range||range.parentElement()!=this)return pos;var dup=range.duplicate();if(this.type=='text'){pos.start=0-dup.moveStart('character',-100000);pos.end=pos.start+range.text.length;}else{var value=this.value;var offset=value.length-value.match(/[\n\r]*$/)[0].length;dup.moveToElementText(this);dup.setEndPoint('StartToEnd',range);pos.end=offset-dup.text.length;dup.setEndPoint('StartToStart',range);pos.start=offset-dup.text.length;}
return pos;},selectRange:function(start,end){if(Browser.Engine.trident){var diff=this.value.substr(start,end-start).replace(/\r/g,'').length;start=this.value.substr(0,start).replace(/\r/g,'').length;var range=this.createTextRange();range.collapse(true);range.moveEnd('character',start+diff);range.moveStart('character',start);range.select();}else{this.focus();this.setSelectionRange(start,end);}
return this;}});Autocompleter.Base=Autocompleter;;Autocompleter.Local=new Class({Extends:Autocompleter,options:{minLength:0,delay:200},initialize:function(element,tokens,options){this.parent(element,options);this.tokens=tokens;},query:function(){this.update(this.filter());}});;Autocompleter.Request=new Class({Extends:Autocompleter,options:{postData:{},ajaxOptions:{},postVar:'value',delay:250},query:function(){var data=$unlink(this.options.postData)||{};data[this.options.postVar]=this.queryValue;var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','');var cls=this.options.indicatorClass;if(cls)this.element.addClass(cls);this.fireEvent('onRequest',[this.element,this.request,data,this.queryValue]);this.request.send({'data':data});},queryResponse:function(){var indicator=$(this.options.indicator);if(indicator)indicator.setStyle('display','none');var cls=this.options.indicatorClass;if(cls)this.element.removeClass(cls);return this.fireEvent('onComplete',[this.element,this.request]);}});Autocompleter.Request.JSON=new Class({Extends:Autocompleter.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.JSON($merge({'url':url,'link':'cancel'},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(response){this.parent();this.update(response);}});Autocompleter.Request.HTML=new Class({Extends:Autocompleter.Request,initialize:function(el,url,options){this.parent(el,options);this.request=new Request.HTML($merge({'url':url,'link':'cancel','update':this.choices},this.options.ajaxOptions)).addEvent('onComplete',this.queryResponse.bind(this));},queryResponse:function(tree,elements){this.parent();if(!elements||!elements.length){this.hideChoices();}else{this.choices.getChildren(this.options.choicesMatch).each(this.options.injectChoice||function(choice){var value=choice.innerHTML;choice.inputValue=value;this.addChoiceEvents(choice.set('html',this.markQueryValue(value)));},this);this.showChoices();}}});Autocompleter.Ajax={Base:Autocompleter.Request,Json:Autocompleter.Request.JSON,Xhtml:Autocompleter.Request.HTML};;var Calendar=new Class({Implements:Options,options:{blocked:[],classes:[],days:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],direction:0,draggable:true,months:['January','February','March','April','May','June','July','August','September','October','November','December'],navigation:1,offset:0,onHideStart:Class.empty,onHideComplete:Class.empty,onShowStart:Class.empty,onShowComplete:Class.empty,pad:1,tweak:{x:0,y:0},day_suffixes:['st','nd','rd','th'],year_suffix:''},initialize:function(obj,options){if(!obj){return false;}
this.setOptions(options);var keys=['calendar','prev','next','month','year','today','invalid','valid','inactive','active','hover','hilite'];var values=keys.map(function(key,i){if(this.options.classes[i]){if(this.options.classes[i].length){key=this.options.classes[i];}}
return key;},this);this.classes=values.associate(keys);this.calendar=new Element('div',{'styles':{left:'-1000px',opacity:0,position:'absolute',top:'-1000px',zIndex:1000}}).addClass(this.classes.calendar).injectInside(document.body);if(window.ie6){this.iframe=new Element('iframe',{'styles':{left:'-1000px',position:'absolute',top:'-1000px',zIndex:999}}).injectInside(document.body);this.iframe.style.filter='progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)';}
this.fx=new Fx.Tween(this.calendar,{onStart:function(){if(this.calendar.getStyle('opacity')==0){if(window.ie6){this.iframe.setStyle('display','block');}
this.calendar.setStyle('display','block');this.fireEvent('onShowStart',this.element);}
else{this.fireEvent('onHideStart',this.element);}}.bind(this),onComplete:function(){if(this.calendar.getStyle('opacity')==0){this.calendar.setStyle('display','none');if(window.ie6){this.iframe.setStyle('display','none');}
this.fireEvent('onHideComplete',this.element);}
else{this.fireEvent('onShowComplete',this.element);}}.bind(this)});if(window.Drag&&this.options.draggable){this.drag=new Drag.Move(this.calendar,{onDrag:function(){if(window.ie6){this.iframe.setStyles({left:this.calendar.style.left,top:this.calendar.style.top});}}.bind(this)});}
this.calendars=[];var id=0;var d=new Date();d.setDate(d.getDate()+this.options.direction.toInt());for(var i in obj){var cal={button:new Element('button',{'type':'button'}),el:$(i),els:[],id:id++,month:d.getMonth(),visible:false,year:d.getFullYear()};if(!this.element(i,obj[i],cal)){continue;}
cal.el.addClass(this.classes.calendar);var self=this;cal.button.addClass(this.classes.calendar).addEvent('click',function(e,cal){this.toggle(cal);e.stop();}.bindWithEvent(this,cal)).injectBefore(cal.el);cal.val=this.read(cal);$extend(cal,this.bounds(cal));$extend(cal,this.values(cal));this.rebuild(cal);this.calendars.push(cal);}},blocked:function(cal){var blocked=[];var offset=new Date(cal.year,cal.month,1).getDay();var last=new Date(cal.year,cal.month+1,0).getDate();this.options.blocked.each(function(date){var values=date.split(' ');for(var i=0;i<=3;i++){if(!values[i]){values[i]=(i==3)?'':'*';}
values[i]=values[i].contains(',')?values[i].split(','):new Array(values[i]);var count=values[i].length-1;for(var j=count;j>=0;j--){if(values[i][j].contains('-')){var val=values[i][j].split('-');for(var k=val[0];k<=val[1];k++){if(!values[i].contains(k)){values[i].push(k+'');}}
values[i].splice(j,1);}}}
if(values[2].contains(cal.year+'')||values[2].contains('*')){if(values[1].contains(cal.month+1+'')||values[1].contains('*')){values[0].each(function(val){if(val>0){blocked.push(val.toInt());}});if(values[3]){for(var i=0;i<last;i++){var day=(i+offset)%7;if(values[3].contains(day+'')){blocked.push(i+1);}}}}}},this);return blocked;},bounds:function(cal){var start=new Date(1000,0,1);var end=new Date(2999,11,31);var date=new Date().getDate()+this.options.direction.toInt();if(this.options.direction>0){start=new Date();start.setDate(date+this.options.pad*cal.id);}
if(this.options.direction<0){end=new Date();end.setDate(date-this.options.pad*(this.calendars.length-cal.id-1));}
cal.els.each(function(el){if(el.get('tag')=='select'){if(el.format.test('(y|Y)')){var years=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if(!years.contains(values[0])){years.push(values[0]);}},this);years.sort(this.sort);if(years[0]>start.getFullYear()){d=new Date(years[0],start.getMonth()+1,0);if(start.getDate()>d.getDate()){start.setDate(d.getDate());}
start.setYear(years[0]);}
if(years.getLast()<end.getFullYear()){d=new Date(years.getLast(),end.getMonth()+1,0);if(end.getDate()>d.getDate()){end.setDate(d.getDate());}
end.setYear(years.getLast());}}
if(el.format.test('(F|m|M|n)')){var months_start=[];var months_end=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if($type(values[0])!='number'||values[0]==years[0]){if(!months_start.contains(values[1])){months_start.push(values[1]);}}
if($type(values[0])!='number'||values[0]==years.getLast()){if(!months_end.contains(values[1])){months_end.push(values[1]);}}},this);months_start.sort(this.sort);months_end.sort(this.sort);if(months_start[0]>start.getMonth()){d=new Date(start.getFullYear(),months_start[0]+1,0);if(start.getDate()>d.getDate()){start.setDate(d.getDate());}
start.setMonth(months_start[0]);}
if(months_end.getLast()<end.getMonth()){d=new Date(start.getFullYear(),months_end.getLast()+1,0);if(end.getDate()>d.getDate()){end.setDate(d.getDate());}
end.setMonth(months_end.getLast());}}}},this);return{'start':start,'end':end};},caption:function(cal){var navigation={prev:{'month':true,'year':true},next:{'month':true,'year':true}};if(cal.year==cal.start.getFullYear()){navigation.prev.year=false;if(cal.month==cal.start.getMonth()&&this.options.navigation==1){navigation.prev.month=false;}}
if(cal.year==cal.end.getFullYear()){navigation.next.year=false;if(cal.month==cal.end.getMonth()&&this.options.navigation==1){navigation.next.month=false;}}
if($type(cal.months)=='array'){if(cal.months.length==1&&this.options.navigation==2){navigation.prev.month=navigation.next.month=false;}}
var caption=new Element('caption');var prev=new Element('a').addClass(this.classes.prev).appendText('\x3c');var next=new Element('a').addClass(this.classes.next).appendText('\x3e');if(this.options.navigation==2){var month=new Element('span').addClass(this.classes.month).injectInside(caption);if(navigation.prev.month){prev.clone().addEvent('click',function(cal){this.navigate(cal,'m',-1);}.pass(cal,this)).injectInside(month);}
month.adopt(new Element('span').appendText(this.options.months[cal.month]));if(navigation.next.month){next.clone().addEvent('click',function(cal){this.navigate(cal,'m',1);}.pass(cal,this)).injectInside(month);}
var year=new Element('span').addClass(this.classes.year).injectInside(caption);if(navigation.prev.year){prev.clone().addEvent('click',function(cal){this.navigate(cal,'y',-1);}.pass(cal,this)).injectInside(year);}
year.adopt(new Element('span').appendText(cal.year));if(navigation.next.year){next.clone().addEvent('click',function(cal){this.navigate(cal,'y',1);}.pass(cal,this)).injectInside(year);}}
else{if(navigation.prev.month&&this.options.navigation){prev.clone().addEvent('click',function(cal){this.navigate(cal,'m',-1);}.pass(cal,this)).injectInside(caption);}
caption.adopt(new Element('span').addClass(this.classes.month).appendText(this.options.months[cal.month]));caption.adopt(new Element('span').addClass(this.classes.year).appendText(cal.year));if(navigation.next.month&&this.options.navigation){next.clone().addEvent('click',function(cal){this.navigate(cal,'m',1);}.pass(cal,this)).injectInside(caption);}}
return caption;},changed:function(cal){cal.val=this.read(cal);$extend(cal,this.values(cal));this.rebuild(cal);if(!cal.val){return;}
if(cal.val.getDate()<cal.days[0]){cal.val.setDate(cal.days[0]);}
if(cal.val.getDate()>cal.days.getLast()){cal.val.setDate(cal.days.getLast());}
cal.els.each(function(el){el.value=this.format(cal.val,el.format);},this);this.check(cal);this.calendars.each(function(kal){if(kal.visible){this.display(kal);}},this);},check:function(cal){this.calendars.each(function(kal,i){if(kal.val){var change=false;if(i<cal.id){var bound=new Date(Date.parse(cal.val));bound.setDate(bound.getDate()-(this.options.pad*(cal.id-i)));if(bound<kal.val){change=true;}}
if(i>cal.id){var bound=new Date(Date.parse(cal.val));bound.setDate(bound.getDate()+(this.options.pad*(i-cal.id)));if(bound>kal.val){change=true;}}
if(change){if(kal.start>bound){bound=kal.start;}
if(kal.end<bound){bound=kal.end;}
kal.month=bound.getMonth();kal.year=bound.getFullYear();$extend(kal,this.values(kal));kal.val=kal.days.contains(bound.getDate())?bound:null;this.write(kal);if(kal.visible){this.display(kal);}}}
else{kal.month=cal.month;kal.year=cal.year;}},this);},clicked:function(td,day,cal){cal.val=(this.value(cal)==day)?null:new Date(cal.year,cal.month,day);this.write(cal);if(!cal.val){cal.val=this.read(cal);}
if(cal.val){this.check(cal);this.toggle(cal);}
else{td.addClass(this.classes.valid);td.removeClass(this.classes.active);}},display:function(cal){this.calendar.empty();this.calendar.className=this.classes.calendar+' '+this.options.months[cal.month].toLowerCase();var div=new Element('div').injectInside(this.calendar);var table=new Element('table').injectInside(div).adopt(this.caption(cal));var thead=new Element('thead').injectInside(table);var tr=new Element('tr').injectInside(thead);for(var i=0;i<=6;i++){var th=this.options.days[(i+this.options.offset)%7];tr.adopt(new Element('th',{'title':th}).appendText(th.substr(0,1)));}
var tbody=new Element('tbody').injectInside(table);var tr=new Element('tr').injectInside(tbody);var d=new Date(cal.year,cal.month,1);var offset=((d.getDay()-this.options.offset)+7)%7;var last=new Date(cal.year,cal.month+1,0).getDate();var prev=new Date(cal.year,cal.month,0).getDate();var active=this.value(cal);var valid=cal.days;var inactive=[];var hilited=[];this.calendars.each(function(kal,i){if(kal!=cal&&kal.val){if(cal.year==kal.val.getFullYear()&&cal.month==kal.val.getMonth()){inactive.push(kal.val.getDate());}
if(cal.val){for(var day=1;day<=last;day++){d.setDate(day);if((i<cal.id&&d>kal.val&&d<cal.val)||(i>cal.id&&d>cal.val&&d<kal.val)){if(!hilited.contains(day)){hilited.push(day);}}}}}},this);var d=new Date();var today=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();for(var i=1;i<43;i++){if((i-1)%7==0){tr=new Element('tr').injectInside(tbody);}
var td=new Element('td').injectInside(tr);var day=i-offset;var date=new Date(cal.year,cal.month,day);var cls='';if(day===active){cls=this.classes.active;}
else if(inactive.contains(day)){cls=this.classes.inactive;}
else if(valid.contains(day)){cls=this.classes.valid;}
else if(day>=1&&day<=last){cls=this.classes.invalid;}
if(date.getTime()==today){cls=cls+' '+this.classes.today;}
if(hilited.contains(day)){cls=cls+' '+this.classes.hilite;}
td.addClass(cls);if(valid.contains(day)){td.setProperty('title',this.format(date,'D M jS Y'));td.addEvents({'click':function(td,day,cal){this.clicked(td,day,cal);}.pass([td,day,cal],this),'mouseover':function(td,cls){td.addClass(cls);}.pass([td,this.classes.hover]),'mouseout':function(td,cls){td.removeClass(cls);}.pass([td,this.classes.hover])});}
if(day<1){day=prev+day;}
else if(day>last){day=day-last;}
td.appendText(day);}},element:function(el,f,cal){if($type(f)=='object'){for(var i in f){if(!this.element(i,f[i],cal)){return false;}}
return true;}
el=$(el);if(!el){return false;}
el.format=f;if(el.get('tag')=='select'){el.addEvent('change',function(cal){this.changed(cal);}.pass(cal,this));}
else{el.readOnly=true;el.addEvent('focus',function(cal){this.toggle(cal);}.pass(cal,this));}
cal.els.push(el);return true;},format:function(date,format){var str='';if(date){var j=date.getDate();var w=date.getDay();var l=this.options.days[w];var n=date.getMonth()+1;var f=this.options.months[n-1];var y=date.getFullYear()+'';var d_st=this.options.day_suffixes[0];var d_nd=this.options.day_suffixes[1];var d_rd=this.options.day_suffixes[2];var d_th=this.options.day_suffixes[3];for(var i=0,len=format.length;i<len;i++){var cha=format.charAt(i);switch(cha){case'y':y=y.substr(2);case'Y':str+=y+this.options.year_suffix;break;case'm':if(n<10){n='0'+n;}
case'n':str+=n;break;case'M':f=f.substr(0,3);case'F':str+=f;break;case'd':if(j<10){j='0'+j;}
case'j':str+=j;break;case'D':l=l.substr(0,3);case'l':str+=l;break;case'N':w+=1;case'w':str+=w;break;case'S':if(j%10==1&&j!='11'){str+=d_st;}
else if(j%10==2&&j!='12'){str+=d_nd;}
else if(j%10==3&&j!='13'){str+=d_rd;}
else{str+=d_th;}
break;default:str+=cha;}}}
return str;},navigate:function(cal,type,n){switch(type){case'm':if($type(cal.months)=='array'){var i=cal.months.indexOf(cal.month)+n;if(i<0||i==cal.months.length){if(this.options.navigation==1){this.navigate(cal,'y',n);}
i=(i<0)?cal.months.length-1:0;}
cal.month=cal.months[i];}
else{var i=cal.month+n;if(i<0||i==12){if(this.options.navigation==1){this.navigate(cal,'y',n);}
i=(i<0)?11:0;}
cal.month=i;}
break;case'y':if($type(cal.years)=='array'){var i=cal.years.indexOf(cal.year)+n;cal.year=cal.years[i];}
else{cal.year+=n;}
break;}
$extend(cal,this.values(cal));if($type(cal.months)=='array'){var i=cal.months.indexOf(cal.month);if(i<0){cal.month=cal.months[0];}}
this.display(cal);},read:function(cal){var arr=[null,null,null];cal.els.each(function(el){var values=this.unformat(el.value,el.format);values.each(function(val,i){if($type(val)=='number'){arr[i]=val;}});},this);if($type(arr[0])=='number'){cal.year=arr[0];}
if($type(arr[1])=='number'){cal.month=arr[1];}
var val=null;if(arr.every(function(i){return $type(i)=='number';})){var last=new Date(arr[0],arr[1]+1,0).getDate();if(arr[2]>last){arr[2]=last;}
val=new Date(arr[0],arr[1],arr[2]);}
return(cal.val==val)?null:val;},rebuild:function(cal){cal.els.each(function(el){if(el.get('tag')=='select'&&el.format.test('^(d|j)$')){var d=this.value(cal);if(!d){d=el.value.toInt();}
el.empty();cal.days.each(function(day){var option=new Element('option',{'selected':(d==day),'value':((el.format=='d'&&day<10)?'0'+day:day)}).appendText(day).injectInside(el);},this);}},this);},sort:function(a,b){return a-b;},toggle:function(cal){document.removeEvent('mousedown',this.fn);if(cal.visible){cal.visible=false;cal.button.removeClass(this.classes.active);this.fx.start('opacity',1,0);}
else{this.fn=function(e,cal){var e=new Event(e);var el=e.target;var stop=false;while(el!=document.body&&el.nodeType==1){if(el==this.calendar){stop=true;}
this.calendars.each(function(kal){if(kal.button==el||kal.els.contains(el)){stop=true;}});if(stop){e.stop();return false;}
else{el=el.parentNode;}}
this.toggle(cal);}.create({'arguments':cal,'bind':this,'event':true});document.addEvent('mousedown',this.fn);this.calendars.each(function(kal){if(kal==cal){kal.visible=true;kal.button.addClass(this.classes.active);}
else{kal.visible=false;kal.button.removeClass(this.classes.active);}},this);var size=window.getScrollSize();var coord=cal.button.getCoordinates();var x=coord.right+this.options.tweak.x;var y=coord.top+this.options.tweak.y;if(!this.calendar.coord){this.calendar.coord=this.calendar.getCoordinates();}
if(x+this.calendar.coord.width>size.x){x-=(x+this.calendar.coord.width-size.x);}
if(y+this.calendar.coord.height>size.y){y-=(y+this.calendar.coord.height-size.y);}
this.calendar.setStyles({left:x+'px',top:y+'px'});if(window.ie6){this.iframe.setStyles({height:this.calendar.coord.height+'px',left:x+'px',top:y+'px',width:this.calendar.coord.width+'px'});}
this.display(cal);this.fx.start('opacity',0,1);}},unformat:function(val,f){f=f.escapeRegExp();var re={d:'([0-9]{2})',j:'([0-9]{1,2})',D:'('+this.options.days.map(function(day){return day.substr(0,3);}).join('|')+')',l:'('+this.options.days.join('|')+')',S:'(st|nd|rd|th)',F:'('+this.options.months.join('|')+')',m:'([0-9]{2})',M:'('+this.options.months.map(function(month){return month.substr(0,3);}).join('|')+')',n:'([0-9]{1,2})',Y:'([0-9]{4})',y:'([0-9]{2})'}
var arr=[];var g='';for(var i=0;i<f.length;i++){var c=f.charAt(i);if(re[c]){arr.push(c);g+=re[c];}
else{g+=c;}}
var matches=val.match('^'+g+'$');var dates=new Array(3);if(matches){matches=matches.slice(1);arr.each(function(c,i){i=matches[i];switch(c){case'y':i='19'+i;case'Y':dates[0]=i.toInt();break;case'F':i=i.substr(0,3);case'M':i=this.options.months.map(function(month){return month.substr(0,3);}).indexOf(i)+1;case'm':case'n':dates[1]=i.toInt()-1;break;case'd':case'j':dates[2]=i.toInt();break;}},this);}
return dates;},value:function(cal){var day=null;if(cal.val){if(cal.year==cal.val.getFullYear()&&cal.month==cal.val.getMonth()){day=cal.val.getDate();}}
return day;},values:function(cal){var years,months,days;cal.els.each(function(el){if(el.get('tag')=='select'){if(el.format.test('(y|Y)')){years=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if(!years.contains(values[0])){years.push(values[0]);}},this);years.sort(this.sort);}
if(el.format.test('(F|m|M|n)')){months=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if($type(values[0])!='number'||values[0]==cal.year){if(!months.contains(values[1])){months.push(values[1]);}}},this);months.sort(this.sort);}
if(el.format.test('(d|j)')&&!el.format.test('^(d|j)$')){days=[];el.getChildren().each(function(option){var values=this.unformat(option.value,el.format);if(values[0]==cal.year&&values[1]==cal.month){if(!days.contains(values[2])){days.push(values[2]);}}},this);}}},this);var first=1;var last=new Date(cal.year,cal.month+1,0).getDate();if(cal.year==cal.start.getFullYear()){if(months==null&&this.options.navigation==2){months=[];for(var i=0;i<12;i++){if(i>=cal.start.getMonth()){months.push(i);}}}
if(cal.month==cal.start.getMonth()){first=cal.start.getDate();}}
if(cal.year==cal.end.getFullYear()){if(months==null&&this.options.navigation==2){months=[];for(var i=0;i<12;i++){if(i<=cal.end.getMonth()){months.push(i);}}}
if(cal.month==cal.end.getMonth()){last=cal.end.getDate();}}
var blocked=this.blocked(cal);if($type(days)=='array'){days=days.filter(function(day){if(day>=first&&day<=last&&!blocked.contains(day)){return day;}});}
else{days=[];for(var i=first;i<=last;i++){if(!blocked.contains(i)){days.push(i);}}}
days.sort(this.sort);return{'days':days,'months':months,'years':years};},write:function(cal){this.rebuild(cal);cal.els.each(function(el){el.value=this.format(cal.val,el.format);$('calendar_output_span_'+el.id).innerHTML=this.format(cal.val,el.format);},this);}});Calendar.implement(new Events,new Options);